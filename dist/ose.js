function e(e,t,a,i){return new(a||(a=Promise))((function(s,n){function l(e){try{r(i.next(e))}catch(e){n(e)}}function o(e){try{r(i.throw(e))}catch(e){n(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(l,o)}r((i=i.apply(e,t||[])).next())}))}function t(e,t,a,i){if("a"===a&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===a?i:"a"===a?i.call(e):i?i.value:t.get(e)}function a(e,t,a,i,s){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?s.call(e,a):s?s.value=a:t.set(e,a),a}var i,s,n,l,o,r,d,u,c,m,v,g,h,y,p,f,b,w,q,S,O,k,E;class T{constructor(e="disabled",t=T.baseEncumbranceCap,o=[]){i.add(this),s.set(this,void 0),n.set(this,void 0),l.set(this,0),a(this,s,e,"f"),a(this,n,t,"f")}get variant(){return t(this,s,"f")}get enabled(){return"disabled"!==t(this,s,"f")}get pct(){return Math.clamp(100*this.value/this.max,0,100)}get encumbered(){return this.value>this.max}get steps(){return[]}get value(){return t(this,l,"f")}get max(){return t(this,n,"f")}set max(e){a(this,n,e,"f")}get atThirdBreakpoint(){return this.value>this.max*(T.encumbranceSteps.half/100)+(t(this,i,"a",o)||0)}get atSecondBreakpoint(){return this.value>this.max*(T.encumbranceSteps.threeEighths/100)+(t(this,i,"a",o)||0)}get atFirstBreakpoint(){return this.value>this.max*(T.encumbranceSteps.quarter/100)+(t(this,i,"a",o)||0)}}s=new WeakMap,n=new WeakMap,l=new WeakMap,i=new WeakSet,o=function(){return this.max-T.baseEncumbranceCap},Object.defineProperty(T,"baseEncumbranceCap",{enumerable:!0,configurable:!0,writable:!0,value:1600}),Object.defineProperty(T,"encumbranceSteps",{enumerable:!0,configurable:!0,writable:!0,value:{quarter:25,threeEighths:37.5,half:50}});class I extends T{constructor(e=T.baseEncumbranceCap,t=[],i={}){super(I.type,e),r.set(this,void 0),d.set(this,void 0),u.set(this,void 0),a(this,d,(null==i?void 0:i.significantTreasure)||I.significantTreasure,"f"),a(this,r,t.reduce(((e,{type:t,system:{treasure:a,quantity:i,weight:s}})=>"item"===t&&a?e+i.value*s:e),0),"f"),a(this,u,t.reduce(((e,{type:t,system:{type:a,equipped:i}})=>"armor"===t&&i?"light"===a&&e===I.armorWeight.unarmored?I.armorWeight.light:"heavy"===a?I.armorWeight.heavy:e:e),I.armorWeight.unarmored),"f")}get steps(){return[100*t(this,d,"f")/this.max]}get overTreasureThreshold(){return this.value>=t(this,d,"f")}get value(){return t(this,r,"f")}get overSignificantTreasureThreshold(){return this.value>=t(this,d,"f")}get atThirdBreakpoint(){return t(this,u,"f")===I.armorWeight.heavy&&this.value>=t(this,d,"f")}get atSecondBreakpoint(){const e=t(this,u,"f")===I.armorWeight.heavy,a=t(this,u,"f")===I.armorWeight.light&&this.value>=t(this,d,"f");return e||a}get atFirstBreakpoint(){return t(this,u,"f")===I.armorWeight.light||this.overSignificantTreasureThreshold}}r=new WeakMap,d=new WeakMap,u=new WeakMap,Object.defineProperty(I,"templateEncumbranceBar",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(I,"templateInventoryRow",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(I,"type",{enumerable:!0,configurable:!0,writable:!0,value:"basic"}),Object.defineProperty(I,"localizedLabel",{enumerable:!0,configurable:!0,writable:!0,value:"OSE.Setting.EncumbranceBasic"}),Object.defineProperty(I,"significantTreasure",{enumerable:!0,configurable:!0,writable:!0,value:800}),Object.defineProperty(I,"armorWeight",{enumerable:!0,configurable:!0,writable:!0,value:{unarmored:0,light:1,heavy:2}});class C extends T{constructor(e=T.baseEncumbranceCap,t=[]){super(C.type,e),c.set(this,void 0),a(this,c,t.reduce(((e,{type:t,system:{quantity:a,weight:i}})=>"item"===t?e+a.value*i:["weapon","armor","container"].includes(t)?e+i:e),0),"f")}get steps(){return Object.values(T.encumbranceSteps)}get value(){return t(this,c,"f")}}c=new WeakMap,Object.defineProperty(C,"templateEncumbranceBar",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(C,"templateInventoryRow",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(C,"type",{enumerable:!0,configurable:!0,writable:!0,value:"complete"}),Object.defineProperty(C,"localizedLabel",{enumerable:!0,configurable:!0,writable:!0,value:"OSE.Setting.EncumbranceComplete"});class A extends T{constructor(e=T.baseEncumbranceCap,i=[]){super(A.type,e),m.set(this,0),v.set(this,void 0),a(this,v,i.some((e=>"item"===e.type&&!e.system.treasure)),"f"),a(this,m,i.reduce(((e,{type:t,system:{treasure:a,quantity:i,weight:s}})=>{if("spell"===t||"ability"===t)return e;let n=e;return"item"===t&&a&&(n+=i.value*s),["weapon","armor","container"].includes(t)&&(n+=s),n}),0)+(t(this,v,"f")?A.gearWeight:0),"f")}get steps(){return Object.values(T.encumbranceSteps)}get value(){return t(this,m,"f")}}m=new WeakMap,v=new WeakMap,Object.defineProperty(A,"templateEncumbranceBar",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(A,"templateInventoryRow",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(A,"type",{enumerable:!0,configurable:!0,writable:!0,value:"detailed"}),Object.defineProperty(A,"localizedLabel",{enumerable:!0,configurable:!0,writable:!0,value:"OSE.Setting.EncumbranceDetailed"}),Object.defineProperty(A,"gearWeight",{enumerable:!0,configurable:!0,writable:!0,value:80});class D extends T{constructor(){super(D.type)}get value(){return 0}}Object.defineProperty(D,"templateEncumbranceBar",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(D,"templateInventoryRow",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(D,"type",{enumerable:!0,configurable:!0,writable:!0,value:"disabled"}),Object.defineProperty(D,"localizedLabel",{enumerable:!0,configurable:!0,writable:!0,value:"OSE.Setting.EncumbranceDisabled"});class M extends T{constructor(e=16,i=[]){super(M.type,e),g.set(this,void 0),h.set(this,void 0),y.set(this,void 0),p.set(this,void 0),f.set(this,void 0),b.set(this,void 0),w.set(this,void 0),q.set(this,void 0),S.set(this,void 0),O.set(this,void 0),k.set(this,void 0),E.set(this,void 0),a(this,h,16,"f"),a(this,g,9,"f"),a(this,E,Math.ceil(i.reduce(((e,{type:t,system:{quantity:a,itemslots:i,equipped:s}})=>"item"!==t||s?["weapon","armor","container"].includes(t)&&!s?e+i:e:e+a.value*i),0)),"f"),a(this,k,Math.ceil(i.reduce(((e,{type:t,system:{quantity:a,itemslots:i,equipped:s}})=>"item"===t&&s?e+a.value*i:["weapon","armor","container"].includes(t)&&s?e+i:e),0)),"f"),a(this,p,t(this,O,"f")>t(this,y,"f")*(M.packedEncumbranceSteps.fiveEighths/100),"f"),a(this,f,t(this,O,"f")>t(this,y,"f")*(M.packedEncumbranceSteps.threeQuarters/100),"f"),a(this,b,t(this,O,"f")>t(this,y,"f")*(M.packedEncumbranceSteps.sevenEighths/100),"f"),a(this,w,t(this,O,"f")>t(this,y,"f")*(M.equippedEncumbranceSteps.oneThird/100),"f"),a(this,q,t(this,O,"f")>t(this,y,"f")*(M.equippedEncumbranceSteps.fiveNinths/100),"f"),a(this,S,t(this,O,"f")>t(this,y,"f")*(M.equippedEncumbranceSteps.sevenNinths/100),"f")}get steps(){return this.usingEquippedEncumbrance?Object.values(M.equippedEncumbranceSteps):Object.values(M.packedEncumbranceSteps)}get usingEquippedEncumbrance(){const e=Object.values(M.equippedEncumbranceSteps),a=Object.values(M.packedEncumbranceSteps);let i=e.findIndex((e=>e>t(this,k,"f")/t(this,g,"f")*100));i=-1===i?4:i;let s=a.findIndex((e=>e>t(this,E,"f")/t(this,h,"f")*100));return s=-1===s?4:s,!!(i>=s)}get value(){return t(this,O,"f")}get max(){return t(this,y,"f")}get atFirstBreakpoint(){return this.usingEquippedEncumbrance?t(this,w,"f"):t(this,p,"f")}get atSecondBreakpoint(){return this.usingEquippedEncumbrance?t(this,q,"f"):t(this,f,"f")}get atThirdBreakpoint(){return this.usingEquippedEncumbrance?t(this,S,"f"):t(this,b,"f")}}g=new WeakMap,h=new WeakMap,y=new WeakMap,p=new WeakMap,f=new WeakMap,b=new WeakMap,w=new WeakMap,q=new WeakMap,S=new WeakMap,O=new WeakMap,k=new WeakMap,E=new WeakMap,Object.defineProperty(M,"packedEncumbranceSteps",{enumerable:!0,configurable:!0,writable:!0,value:{fiveEighths:62.5,threeQuarters:75,sevenEighths:87.5}}),Object.defineProperty(M,"equippedEncumbranceSteps",{enumerable:!0,configurable:!0,writable:!0,value:{oneThird:33.33,fiveNinths:55.55,sevenNinths:77.77}}),Object.defineProperty(M,"templateEncumbranceBar",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(M,"templateInventoryRow",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(M,"type",{enumerable:!0,configurable:!0,writable:!0,value:"itembased"}),Object.defineProperty(M,"localizedLabel",{enumerable:!0,configurable:!0,writable:!0,value:"OSE.Setting.EncumbranceItemBased"});const F={systemPath(){return`${this.systemRoot}/dist`},get systemRoot(){return`/systems/${game.system.id}`},get assetsPath(){return`${this.systemRoot}/assets`},get encumbrance(){const e=game.settings.get(game.system.id,"encumbranceOption");return this.encumbranceOptions[e]||this.encumbranceOptions.disabled},encumbranceOptions:{basic:I,detailed:A,complete:C,disabled:D,itembased:M},scores:{str:"OSE.scores.str.long",int:"OSE.scores.int.long",dex:"OSE.scores.dex.long",wis:"OSE.scores.wis.long",con:"OSE.scores.con.long",cha:"OSE.scores.cha.long"},scores_short:{str:"OSE.scores.str.short",int:"OSE.scores.int.short",dex:"OSE.scores.dex.short",wis:"OSE.scores.wis.short",con:"OSE.scores.con.short",cha:"OSE.scores.cha.short"},exploration_skills:{ld:"OSE.exploration.ld.long",od:"OSE.exploration.od.long",sd:"OSE.exploration.sd.long",fs:"OSE.exploration.ft.long"},exploration_skills_short:{ld:"OSE.exploration.ld.abrev",od:"OSE.exploration.od.abrev",sd:"OSE.exploration.sd.abrev",fs:"OSE.exploration.ft.abrev"},roll_type:{result:"=",above:"≥",below:"≤"},saves_short:{death:"OSE.saves.death.short",wand:"OSE.saves.wand.short",paralysis:"OSE.saves.paralysis.short",breath:"OSE.saves.breath.short",spell:"OSE.saves.spell.short"},saves_long:{death:"OSE.saves.death.long",wand:"OSE.saves.wand.long",paralysis:"OSE.saves.paralysis.long",breath:"OSE.saves.breath.long",spell:"OSE.saves.spell.long"},armor:{unarmored:"OSE.armor.unarmored",light:"OSE.armor.light",heavy:"OSE.armor.heavy",shield:"OSE.armor.shield"},apply_damage_options:{selected:"selected",targeted:"targeted",originalTarget:"originalTarget"},colors:{green:"OSE.colors.green",red:"OSE.colors.red",yellow:"OSE.colors.yellow",purple:"OSE.colors.purple",blue:"OSE.colors.blue",orange:"OSE.colors.orange",white:"OSE.colors.white"},languages:["Common","Lawful","Chaotic","Neutral","Bugbear","Doppelgänger","Dragon","Dwarvish","Elvish","Gargoyle","Gnoll","Gnomish","Goblin","Halfling","Harpy","Hobgoblin","Kobold","Lizard Man","Medusa","Minotaur","Ogre","Orcish","Pixie"],tags:{melee:"OSE.items.Melee",missile:"OSE.items.Missile",slow:"OSE.items.Slow",twohanded:"OSE.items.TwoHanded",blunt:"OSE.items.Blunt",brace:"OSE.items.Brace",splash:"OSE.items.Splash",reload:"OSE.items.Reload",charge:"OSE.items.Charge"},auto_tags:{get melee(){return{label:CONFIG.OSE.tags.melee,image:`${CONFIG.OSE.assetsPath}/melee.png`,icon:"fa-sword"}},get missile(){return{label:CONFIG.OSE.tags.missile,image:`${CONFIG.OSE.assetsPath}/missile.png`,icon:"fa-bow-arrow"}},get slow(){return{label:CONFIG.OSE.tags.slow,image:`${CONFIG.OSE.assetsPath}/slow.png`,icon:"fa-weight-hanging"}},get twohanded(){return{label:CONFIG.OSE.tags.twohanded,image:`${CONFIG.OSE.assetsPath}/twohanded.png`,icon:"fa-hands-holding"}},get blunt(){return{label:CONFIG.OSE.tags.blunt,image:`${CONFIG.OSE.assetsPath}/blunt.png`,icon:"fa-hammer-crash"}},get brace(){return{label:CONFIG.OSE.tags.brace,image:`${CONFIG.OSE.assetsPath}/brace.png`,icon:"fa-block-brick"}},get splash(){return{label:CONFIG.OSE.tags.splash,image:`${CONFIG.OSE.assetsPath}/splash.png`,icon:"fa-burst"}},get reload(){return{label:CONFIG.OSE.tags.reload,image:`${CONFIG.OSE.assetsPath}/reload.png`,icon:"fa-gear"}},get charge(){return{label:CONFIG.OSE.tags.charge,image:`${CONFIG.OSE.assetsPath}/charge.png`,icon:"fa-person-running"}}},tag_images:{get melee(){return`${CONFIG.OSE.assetsPath}/melee.png`},get missile(){return"fa-bow-arrow"},get slow(){return`${CONFIG.OSE.assetsPath}/slow.png`},get twohanded(){return`${CONFIG.OSE.assetsPath}/twohanded.png`},get blunt(){return`${CONFIG.OSE.assetsPath}/blunt.png`},get brace(){return`${CONFIG.OSE.assetsPath}/brace.png`},get splash(){return`${CONFIG.OSE.assetsPath}/splash.png`},get reload(){return`${CONFIG.OSE.assetsPath}/reload.png`},get charge(){return`${CONFIG.OSE.assetsPath}/charge.png`}},monster_saves:{0:{d:14,w:15,p:16,b:17,s:18},1:{d:12,w:13,p:14,b:15,s:16},4:{d:10,w:11,p:12,b:13,s:14},7:{d:8,w:9,p:10,b:10,s:12},10:{d:6,w:7,p:8,b:8,s:10},13:{d:4,w:5,p:6,b:5,s:8},16:{d:2,w:3,p:4,b:3,s:6},19:{d:2,w:2,p:2,b:2,s:4},22:{d:2,w:2,p:2,b:2,s:2}},monster_thac0:{0:20,1:19,2:18,3:17,4:16,5:15,6:14,7:13,9:12,10:11,12:10,14:9,16:8,18:7,20:6,22:5}},_={async sendRoll({parts:e=[],data:t={},title:a=null,flavor:i=null,speaker:s=null,form:n=null,chatMessage:l=!0}={}){const o=`${F.systemPath()}/templates/chat/roll-result.html`,r={user:game.user.id,speaker:s},d={title:a,flavor:i,data:t,config:CONFIG.OSE};null!==n&&n.bonus.value&&e.push(n.bonus.value);const u=new Roll(e.join("+"),t);await u.evaluate({allowStrings:!0});let c=game.settings.get("core","rollMode");return c=n?n.rollMode.value:c,!n&&t.roll.blindroll&&(c=game.user.isGM?"selfroll":"blindroll"),["gmroll","blindroll"].includes(c)&&(r.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===c&&(r.whisper=[game.user._id]),"blindroll"===c&&(r.blind=!0,t.roll.blindroll=!0),d.result=_.digestResult(t,u),new Promise((e=>{u.render().then((t=>{d.rollOSE=t,renderTemplate(o,d).then((t=>{r.content=t,game.dice3d?game.dice3d.showForRoll(u,game.user,!0,r.whisper,r.blind).then((t=>{!1!==l&&ChatMessage.create(r),e(u)})):(r.sound=CONFIG.sounds.dice,!1!==l&&ChatMessage.create(r),e(u))}))}))}))},digestResult(e,t){const a={isSuccess:!1,isFailure:!1,target:e.roll.target,total:t.total},i=t.terms[0].results[0].result;switch(e.roll.type){case"result":t.total===a.target?a.isSuccess=!0:a.isFailure=!0;break;case"above":t.total>=a.target?a.isSuccess=!0:a.isFailure=!0;break;case"below":t.total<=a.target?a.isSuccess=!0:a.isFailure=!0;break;case"check":1===i||t.total<=a.target&&i<20?a.isSuccess=!0:a.isFailure=!0;break;case"table":{const{table:i}=e.roll;let s=Object.values(i)[0];for(let e=0;e<=t.total;e++)i[e]&&(s=i[e]);a.details=s;break}default:a.isSuccess=!1,a.isFailure=!1}return a},attackIsSuccess:(e,t,a)=>1!==e.terms[0].results[0].result&&(20===e.terms[0].results[0].result||e.total+a>=t),digestAttackResult(e,t){const a={isSuccess:!1,isFailure:!1,target:"",total:t.total};a.target=e.roll.thac0;const i=e.roll.target?.actor?.system||null,s=e.roll.target?i.ac.value:20,n=e.roll.target?i.aac.value:-20;if(a.victim=e.roll.target||null,game.settings.get(game.system.id,"ascendingAC")){const i=19-e.roll.thac0;this.attackIsSuccess(t,n,i)?(a.details=game.i18n.format("OSE.messages.AttackAscendingSuccess",{result:t.total}),a.isSuccess=!0):(a.details=game.i18n.format("OSE.messages.AttackAscendingFailure",{bonus:a.target}),a.isFailure=!0)}else if(this.attackIsSuccess(t,a.target,s)){const e=Math.clamp(a.target-t.total,-3,9);a.details=game.i18n.format("OSE.messages.AttackSuccess",{result:e,bonus:a.target}),a.isSuccess=!0}else a.details=game.i18n.format("OSE.messages.AttackFailure",{bonus:a.target}),a.isFailure=!0;return a},async sendAttackRoll({parts:e=[],data:t={},flags:a={},title:i=null,flavor:s=null,speaker:n=null,form:l=null}={}){if(0===t.roll.dmg.filter((e=>""!==e)).length)return void ui.notifications.error("Attack has no damage dice terms; be sure to set the attack's damage");const o=`${F.systemPath()}/templates/chat/roll-attack.html`,r={user:game.user.id,speaker:n,flags:a},d={title:i,flavor:s,data:t,config:CONFIG.OSE};null!==l&&l.bonus.value&&e.push(l.bonus.value);const u=new Roll(e.join("+"),t);await u.evaluate();const c=new Roll(t.roll.dmg.join("+"),t);await c.evaluate();let m=game.settings.get("core","rollMode");return m=l?l.rollMode.value:m,t.roll.blindroll&&(m=game.user.isGM?"selfroll":"blindroll"),["gmroll","blindroll"].includes(m)&&(r.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===m&&(r.whisper=[game.user._id]),"blindroll"===m&&(r.blind=!0,t.roll.blindroll=!0),d.result=_.digestAttackResult(t,u),new Promise((e=>{u.render().then((t=>{d.rollOSE=t,c.render().then((t=>{d.rollDamage=t,renderTemplate(o,d).then((t=>{r.content=t,game.dice3d?game.dice3d.showForRoll(u,game.user,!0,r.whisper,r.blind).then((()=>{d.result.isSuccess?(d.result.dmg=c.total,game.dice3d.showForRoll(c,game.user,!0,r.whisper,r.blind).then((()=>{ChatMessage.create(r),e(u)}))):(ChatMessage.create(r),e(u))})):(r.sound=CONFIG.sounds.dice,ChatMessage.create(r),e(u))}))}))}))}))},async RollSave({parts:e=[],data:t={},skipDialog:a=!1,speaker:i=null,flavor:s=null,title:n=null,chatMessage:l=!0}={}){let o=!1;const r=`${F.systemPath()}/templates/chat/roll-dialog.html`,d={formula:e.join(" "),data:t,rollMode:game.settings.get("core","rollMode"),rollModes:CONFIG.Dice.rollModes},u={parts:e,data:t,title:n,flavor:s,speaker:i,chatMessage:l};if(a)return _.sendRoll(u);const c={ok:{label:game.i18n.localize("OSE.Roll"),icon:'<i class="fas fa-dice-d20"></i>',callback:e=>{o=!0,u.form=e[0].querySelector("form"),v=_.sendRoll(u)}},magic:{label:game.i18n.localize("OSE.saves.magic.short"),icon:'<i class="fas fa-magic"></i>',callback:e=>{o=!0,u.form=e[0].querySelector("form"),u.parts.push(`${u.data.roll.magic}`),u.title+=` ${game.i18n.localize("OSE.saves.magic.short")} (${u.data.roll.magic})`,v=_.sendRoll(u)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("OSE.Cancel"),callback:e=>{}}},m=await renderTemplate(r,d);let v;return new Promise((e=>{new Dialog({title:n,content:m,buttons:c,default:"ok",close:()=>{e(!!o&&v)}}).render(!0)}))},async Roll({parts:e=[],data:t={},skipDialog:a=!1,speaker:i=null,flavor:s=null,title:n=null,chatMessage:l=!0,flags:o={}}={}){let r=!1;const d=`${F.systemPath()}/templates/chat/roll-dialog.html`,u={formula:e.join(" "),data:t,rollMode:t.roll.blindroll?"blindroll":game.settings.get("core","rollMode"),rollModes:CONFIG.Dice.rollModes},c={parts:e,data:t,title:n,flavor:s,speaker:i,chatMessage:l,flags:o};if(a)return["melee","missile","attack"].includes(t.roll.type)?_.sendAttackRoll(c):_.sendRoll(c);const m={ok:{label:game.i18n.localize("OSE.Roll"),icon:'<i class="fas fa-dice-d20"></i>',callback:e=>{r=!0,c.form=e[0].querySelector("form"),g=["melee","missile","attack"].includes(t.roll.type)?_.sendAttackRoll(c):_.sendRoll(c)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("OSE.Cancel"),callback:e=>{}}},v=await renderTemplate(d,u);let g;return new Promise((e=>{new Dialog({title:n,content:v,buttons:m,default:"ok",close:()=>{e(!!r&&g)}}).render(!0)}))}};class N extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.classes=["ose","dialog","creator"],e.id="character-creator",e.template=`${F.systemPath()}/templates/actors/dialogs/character-creation.html`,e.width=235,e.submitOnClose=!1,e}get title(){return`${this.object.name}: ${game.i18n.localize("OSE.dialog.generator")}`}getData(){const e=foundry.utils.deepClone(this.object);return e.user=game.user,e.config=CONFIG.OSE,this.counters={str:0,wis:0,dex:0,int:0,cha:0,con:0,gold:0},this.stats={sum:0,avg:0,std:0},this.scores={},this.gold=0,e}doStats(e){const t=$(e.currentTarget).closest(".attribute-list"),a=Object.values(this.scores),i=a.length,s=a.reduce(((e,t)=>e+t.value),0),n=parseFloat(s)/i,l=Math.sqrt(a.map((e=>(e.value-n)**2)).reduce(((e,t)=>e+t),0)/i),o=t.siblings(".roll-stats");o.find(".sum").text(s),o.find(".avg").text(Math.round(10*s/i)/10),o.find(".std").text(Math.round(100*l)/100),i>=6&&$(e.currentTarget).closest("form").find('button[type="submit"]').removeAttr("disabled"),this.object.stats={sum:s,avg:Math.round(10*s/i)/10,std:Math.round(100*l)/100}}async rollScore(e,t={}){this.counters[e]+=1;const a="gold"===e?"Gold":game.i18n.localize(`OSE.scores.${e}.long`),i=["3d6"];if(t.skipMessage){const e=new Roll(i[0]);await e.evaluate()}return _.Roll({event:t.event,parts:i,data:{roll:{}},skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.dialog.generateScore",{score:a,count:this.counters[e]}),title:game.i18n.format("OSE.dialog.generateScore",{score:a,count:this.counters[e]})})}activateListeners(e){super.activateListeners(e),e.find("a.score-roll").click((e=>{const t=e.currentTarget.parentElement.parentElement,{score:a}=t.dataset;this.rollScore(a,{event:e}).then((e=>{this.scores[a]={value:e.total},$(t).find("input").val(e.total).trigger("change")}))})),e.find("a.gold-roll").click((e=>{const t=e.currentTarget.parentElement.parentElement.parentElement;this.rollScore("gold",{event:e}).then((e=>{this.gold=10*e.total,$(t).find(".gold-value").val(this.gold)}))})),e.find("input.score-value").change((e=>{this.doStats(e)})),e.find("a.auto-roll").click((async e=>{const t=["str","int","dex","wis","con","cha"];for(const a of t){const t=await this.rollScore(a,{event:e,skipMessage:!0});this.scores[a]={value:t.total}}this.doStats(e);const a=await this.rollScore("gold",{event:e,skipMessage:!0});this.gold=10*a.total,this.submit()}))}async _onSubmit(e,{updateData:t=null,preventClose:a=!1,preventRender:i=!1}={}){const s={...t,system:{scores:this.scores}};super._onSubmit(e,{updateData:s,preventClose:a,preventRender:i});const n=ChatMessage.getSpeaker({actor:this.object.actor}),l={config:CONFIG.OSE,scores:this.scores,title:game.i18n.localize("OSE.dialog.generator"),stats:this.object.stats,gold:this.gold},o=await renderTemplate(`${F.systemPath()}/templates/chat/roll-creation.html`,l);await ChatMessage.create({content:o,speaker:n});const r={name:game.i18n.localize("OSE.items.gp.short"),type:"item",img:`${F.assetsPath}/gold.png`,system:{treasure:!0,cost:1,weight:1,quantity:{value:this.gold}}};this.object.createEmbeddedDocuments("Item",[r])}async _updateObject(e,t){e.preventDefault(),await this.object.update(t),this.object.sheet.render(!0)}}class x extends FormApplication{constructor(e,t,a){super(e,a),this.object.preparedData=t}static get defaultOptions(){const e=super.defaultOptions;return e.classes=["ose","dialog","gp-cost"],e.id="sheet-gp-cost",e.template=`${F.systemPath()}/templates/actors/dialogs/gp-cost-dialog.html`,e.width=240,e}get title(){return`${this.object.name}: ${game.i18n.localize("OSE.dialog.shoppingCart")}`}async getData(){const e=await foundry.utils.deepClone(this.object.preparedData);return e.totalCost=await this.#e(e),e.user=game.user,this.inventory=this.object.items,e}async close(e){return super.close(e)}async _onSubmit(e,{preventClose:t=!1,preventRender:a=!1}={}){super._onSubmit(e,{preventClose:t,preventRender:a});const i=await this.#e(await this.getData()),s=await this.object.items.find((e=>{const t=e.system;return(e.name===game.i18n.localize("OSE.items.gp.short")||"GP"===e.name)&&t.treasure}));if(!s)return void ui.notifications.error(game.i18n.localize("OSE.error.noGP"));const n=s.system.quantity.value-i;n>=0?this.object.updateEmbeddedDocuments("Item",[{_id:s.id,"system.quantity.value":n}]):ui.notifications.error(game.i18n.localize("OSE.error.notEnoughGP"))}async#t(e,t){e.preventDefault();const a=ChatMessage.getSpeaker({actor:this}),i=await this.getData(),s=await renderTemplate(`${F.systemPath()}/templates/chat/inventory-list.html`,i);ChatMessage.create({content:s,speaker:a}),await this.object.update(t),this.object.sheet.render(!0)}async#e(e){let t=0;const a=new Set(["item","container","weapon","armor"]);return e.items.forEach((e=>{const i=e.system;a.has(e.type)&&!i.treasure&&(t+=i.quantity.max?i.cost:i.cost*i.quantity.value)})),t}activateListeners(e){super.activateListeners(e),e.find("a.auto-deduct").click((()=>{this.submit()}))}}class j extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.classes=["ose","dialog","modifiers"],e.id="sheet-modifiers",e.template=`${F.systemPath()}/templates/actors/dialogs/modifiers-dialog.html`,e.width=240,e}get title(){return`${this.object.name}: Modifiers`}getData(){const e=foundry.utils.deepClone(this.object);return e.user=game.user,e}activateListeners(e){super.activateListeners(e)}}const R=e=>game.settings.get(game.system.id,"invertedCtrlBehavior")?!(e&&(e.ctrlKey||e.metaKey)):e&&(e.ctrlKey||e.metaKey);class z extends FormApplication{static get defaultOptions(){const e=super.defaultOptions;return e.id="sheet-tweaks",e.classes=["sheet-tweaks"],e.template=`${F.systemPath()}/templates/actors/dialogs/tweaks-dialog.html`,e.width=380,e}get title(){return`${this.object.name}: ${game.i18n.localize("OSE.dialog.tweaks")}`}getData(){const e=foundry.utils.deepClone(this.object);return"character"===e.type&&(e.isCharacter=!0),e.user=game.user,e.config={...CONFIG.OSE,ascendingAC:game.settings.get(game.system.id,"ascendingAC")},e}activateListeners(e){super.activateListeners(e)}async _updateObject(e,t){e.preventDefault(),await this.object.update(t),await this.object.sheet._render(!0)}}class P extends ActorSheet{getData(){const e=foundry.utils.deepClone(super.getData().data);return e.owner=this.actor.isOwner,e.editable=this.actor.sheet.isEditable,e.config={...CONFIG.OSE,ascendingAC:game.settings.get(game.system.id,"ascendingAC"),initiative:"group"!==game.settings.get(game.system.id,"initiative"),encumbrance:game.settings.get(game.system.id,"encumbranceOption")},e.isNew=this.actor.isNew(),e}activateEditor(e,t,a){super.activateEditor(e,t,a)}_getItemFromActor(e){const t=e.currentTarget.closest(".item-entry");return this.actor.items.get(t.dataset.itemId)}_toggleItemCategory(e){e.preventDefault();const t=$(e.currentTarget).next(".item-list");if("none"===t.css("display")){const a=$(e.currentTarget).find(".fas.fa-caret-right");a.removeClass("fa-caret-right"),a.addClass("fa-caret-down"),t.slideDown(200)}else{const a=$(e.currentTarget).find(".fas.fa-caret-down");a.removeClass("fa-caret-down"),a.addClass("fa-caret-right"),t.slideUp(200)}}_toggleContainedItems(e){e.preventDefault();const t=$(e.target.closest(".container")),a=t.find(".item-list.contained-items");if("none"===a.css("display")){const e=t.find(".fas.fa-caret-right");e.removeClass("fa-caret-right"),e.addClass("fa-caret-down"),a.slideDown(200)}else{const e=t.find(".fas.fa-caret-down");e.removeClass("fa-caret-down"),e.addClass("fa-caret-right"),a.slideUp(200)}}_toggleItemSummary(e){e.preventDefault();const t=e.currentTarget.closest(".item-entry.item").querySelector(".item-summary");t.style.display=""===t.style.display?"block":""}async _displayItemInChat(e){const t=$(e.currentTarget).closest(".item-entry");this.actor.items.get(t.data("itemId")).show()}async _removeItemFromActor(e){if("ability"===e.type||"spell"===e.type)return this.actor.deleteEmbeddedDocuments("Item",[e._id]);if("container"!==e.type&&""!==e.system.containerId){const{containerId:t}=e.system,a=this.actor.items.get(t).system.itemIds.filter((t=>t!==e.id));await this.actor.updateEmbeddedDocuments("Item",[{_id:t,system:{itemIds:a}}])}if("container"===e.type&&e.system.itemIds){const t=e.system.itemIds.reduce(((e,t)=>(this.actor.items.get(t)&&e.push({_id:t,"system.containerId":""}),e)),[]);await this.actor.updateEmbeddedDocuments("Item",t)}this.actor.deleteEmbeddedDocuments("Item",[e._id])}_useConsumable(e,t){const a=this._getItemFromActor(e);if(!a)return null;let{quantity:{value:i}}=a.system;a.update({"system.quantity.value":t?--i:++i})}async _onSpellChange(e){e.preventDefault();const t=this._getItemFromActor(e);return"cast"===e.target.dataset.field?t.update({"system.cast":parseInt(e.target.value)}):"memorize"===e.target.dataset.field?t.update({"system.memorized":parseInt(e.target.value)}):void 0}async _resetSpells(e){$(e.currentTarget).closest(".inventory.spells").find(".item-entry").each(((e,t)=>{const{itemId:a}=t.dataset,i=this.actor.items.get(a),s=i?.system;i.update({_id:i.id,"system.cast":s.memorized})}))}async _rollAbility(e){const t=this._getItemFromActor(e),a=t?.system;"weapon"===t.type?("monster"===this.actor.type&&t.update({"system.counter.value":a.counter.value-1}),t.rollWeapon({skipDialog:R(e)})):"spell"==t.type?t.spendSpell({skipDialog:R(e)}):t.rollFormula({skipDialog:R(e)})}async _rollSave(e){const t=this.actor,a=e.currentTarget,{save:i}=a.parentElement.parentElement.dataset;t.rollSave(i,{event:e})}async _rollAttack(e){const t=this.actor,a=e.currentTarget,{attack:i}=a.parentElement.parentElement.dataset;t.targetAttack({roll:{}},i,{type:i,skipDialog:R(e)})}_onSortItem(e,t){const a=this.actor.items.get(t._id),i=this.actor.items.filter((e=>e.data._id!==a.data._id)),s=e.target.closest("[data-item-id]"),n=s?s.dataset.itemId:null,l=i.find((e=>e.data._id===n));if(!l)throw new Error(`Couldn't drop near ${e.target}`);const o=l?.system;"container"!==l?.type&&"container"!==l?.data?.type||""!==o.containerId?(""!==a?.system.containerId&&this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.containerId":""}]),super._onSortItem(e,t)):this.actor.updateEmbeddedDocuments("Item",[{_id:a.id,"system.containerId":l.id}])}_onDragStart(e){const t=e.currentTarget;let a,i=[];if(!e.target.classList.contains("content-link")){if(t.dataset.itemId){const e=this.actor.items.get(t.dataset.itemId);a=e.toDragData(),a.item=e,a.type="Item","container"===e.type&&e.system.itemIds.length>0&&(i=e.system.itemIds)}if(a.actorId=this.actor.id,a.sceneId=this.actor.isToken?canvas.scene?.id:null,a.tokenId=this.actor.isToken?this.actor.token.id:null,a.pack=this.actor.pack,t.dataset.effectId){const e=this.actor.effects.get(t.dataset.effectId);a.type="ActiveEffect",a.data=e.data}e.dataTransfer.setData("text/plain",JSON.stringify(a,((e,t)=>"itemIds"===e?JSON.stringify(i):t)))}}async _onDropFolder(e,t){const a=await fromUuid(t.uuid);if(!a||"Item"!==a.type)return;let i=a.contents||[];if(a.getSubfolders(!0).forEach((e=>{i.push(...e.contents)})),i.length>0&&i[0]?.uuid?.includes("Compendium")){const e=[];i.forEach((async t=>{e.push(await fromUuid(t.uuid))})),i=e}this._onDropItemCreate(i)}async _onDropItem(e,t){const a=e.target.closest(".item")?.dataset?.itemId,i=this.actor.items.get(a),s="container"===i?.type,n=await Item.implementation.fromDropData(t),l=n.toObject(),o=!!this.actor.items.get(n.id),r=this.actor.items.get(n.system.containerId);if(n.id!==a)return o||s?r?this._onContainerItemRemove(n,r):s?this._onContainerItemAdd(n,i):void 0:this._onDropItemCreate([l])}async _onContainerItemRemove(e,t){const a=t.system.itemIds.filter((t=>t!=e.id)),i=this.object.items.get(e.id);await t.update({system:{itemIds:a}}),await i.update({system:{containerId:""}})}async _onContainerItemAdd(e,t){const a=t.parent.items.find((t=>t.id===e.id));let i=e;if(!a){const t=await this._onDropItemCreate([e.toObject()]);i=t.pop()}if(!t.system.itemIds.find((e=>e.id===i.id))){const e=[...t.system.itemIds,i.id];await t.update({system:{itemIds:e}}),await i.update({system:{containerId:t.id}})}}async _onDropItemCreate(e,t=!1){if((Array.isArray(e)?e:[e]).forEach((t=>{if(t.system.containerId&&""!==t.system.containerId&&(t.system.containerId=""),"container"===t.type&&"string"==typeof t.system.itemIds){const a=JSON.parse(t.system.itemIds);a.forEach((e=>{e.system.containerId=""})),e.push(...a)}})),!t)return this.actor.createEmbeddedDocuments("Item",e);const{itemIds:a}=t.system;a.push(e.id);const i=this.actor.items.get(e[0].id);await i.update({system:{containerId:t.id}}),await t.update({system:{itemIds:a}})}async _chooseItemType(e=["weapon","armor","shield","gear"]){const t={types:e},a=await renderTemplate(`${F.systemPath()}/templates/items/entity-create.html`,t);return new Promise((e=>{new Dialog({title:game.i18n.localize("OSE.dialog.createItem"),content:a,buttons:{ok:{label:game.i18n.localize("OSE.Ok"),icon:'<i class="fas fa-check"></i>',callback:t=>{e({type:t.find('select[name="type"]').val(),name:t.find('input[name="name"]').val()})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("OSE.Cancel")}},default:"ok"}).render(!0)}))}_createItem(e){e.preventDefault();const t=e.currentTarget,{treasure:a,type:i,lvl:s}=t.dataset,n=(e,t)=>({name:t||`New ${e.capitalize()}`,type:e});if("choice"!==i){const e=n(i);return a&&(e.system={treasure:!0}),"spell"===i&&(e.system=s?{lvl:s}:{lvl:1}),this.actor.createEmbeddedDocuments("Item",[e],{})}{const e=t.dataset.choices.split(",");this._chooseItemType(e).then((e=>{const t=n(e.type,e.name);this.actor.createEmbeddedDocuments("Item",[t],{})}))}}async _updateItemQuantity(e){e.preventDefault();const t=this._getItemFromActor(e);return"value"===e.target.dataset.field?t.update({"system.quantity.value":parseInt(e.target.value)}):"max"===e.target.dataset.field?t.update({"system.quantity.max":parseInt(e.target.value)}):void 0}async _renderInner(...e){const t=await super._renderInner(...e);this.form=t[0];const a=t.find(".resizable");if(0!==a.length)return a.each(((e,t)=>{const a=this.position.height-this.options.height;t.style.height=`${a+parseInt(t.dataset.baseSize)}px`})),t}async _onResize(e){super._onResize(e);const t=$(this.form),a=t.find(".resizable");if(0===a.length)return;a.each(((e,t)=>{const a=this.position.height-this.options.height;t.style.height=`${a+parseInt(t.dataset.baseSize)}px`}));t.find(".editor").each(((e,t)=>{const a=t.closest(".resizable-editor");if(a){const e=this.position.height-this.options.height;t.style.height=`${e+parseInt(a.dataset.editorSize)}px`}}))}_onConfigureActor(e){e.preventDefault(),new z(this.actor,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}_getHeaderButtons(){let e=super._getHeaderButtons();const t=game.user.isGM||this.actor.isOwner;return this.options.editable&&t&&(e=[{label:game.i18n.localize("OSE.dialog.tweaks"),class:"configure-actor",icon:"fas fa-code",onclick:e=>this._onConfigureActor(e)}].concat(e)),e}activateListeners(e){super.activateListeners(e),e.find(".saving-throw .attribute-name a").click((e=>{this._rollSave(e)})),e.find(".attack a").click((e=>{this._rollAttack(e)})),e.find(".hit-dice .attribute-name").click((e=>{this.actor.rollHitDice({event:e})})),e.find(".item-rollable .item-image").click((async e=>{this._rollAbility(e)})),e.find(".inventory .item-category-title").click((e=>{this._toggleItemCategory(e)})),e.find(".inventory .item-category-title input").click((e=>{e.stopPropagation()})),e.find(".inventory .category-caret").click((e=>{this._toggleContainedItems(e)})),e.find(".item-name").click((e=>{this._toggleItemSummary(e)})),e.find(".item-controls .item-show").click((async e=>{this._displayItemInChat(e)})),this.options.editable&&(e.find(".item-create").click((e=>{this._createItem(e)})),e.find(".item-edit").click((e=>{this._getItemFromActor(e).sheet.render(!0)})),e.find(".item-delete").click((e=>{const t=this._getItemFromActor(e);if("container"!==t?.type||!t?.system?.itemIds?.length>0)return this._removeItemFromActor(t);Dialog.confirm({title:game.i18n.localize("OSE.dialog.deleteContainer"),content:game.i18n.localize("OSE.dialog.confirmDeleteContainer"),yes:()=>{this._removeItemFromActor(t)},defaultYes:!1})})),e.find(".quantity input").click((e=>e.target.select())).change(this._updateItemQuantity.bind(this)),e.find(".consumable-counter .full-mark").click((e=>{this._useConsumable(e,!0)})),e.find(".consumable-counter .empty-mark").click((e=>{this._useConsumable(e,!1)})),e.find(".memorize input").click((e=>e.target.select())).change(this._onSpellChange.bind(this)),e.find(".spells .item-reset[data-action='reset-spells']").click((e=>{this._resetSpells(e)})))}}class H extends P{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","sheet","actor","character"],template:`${F.systemPath()}/templates/actors/character-sheet.html`,width:450,height:530,resizable:!0,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"attributes"}],scrollY:[".inventory"]})}_prepareItems(e){e.owned={items:this.actor.system.items,armors:this.actor.system.armor,weapons:this.actor.system.weapons,treasures:this.actor.system.treasures,containers:this.actor.system.containers},e.treasure=this.actor.system.carriedTreasure,e.containers=this.actor.system.containers,e.abilities=this.actor.system.abilities,e.spells=this.actor.system.spells.spellList,e.slots=this.actor.system.spellSlots,e.system.usesAscendingAC=this.actor.system.usesAscendingAC,e.system.meleeMod=this.actor.system.meleeMod,e.system.rangedMod=this.actor.system.rangedMod,e.system.init=this.actor.system.init,[...Object.values(e.owned),...Object.values(e?.spells?.spellList||{}),e.abilities].forEach((e=>e.sort(((e,t)=>(e.sort||0)-(t.sort||0)))))}generateScores(){new N(this.actor,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}async getData(){const e=super.getData();return this._prepareItems(e),e.enrichedBiography=await TextEditor.enrichHTML(this.object.system.details.biography,{async:!0}),e.enrichedNotes=await TextEditor.enrichHTML(this.object.system.details.notes,{async:!0}),e}async _chooseLang(){const e={choices:CONFIG.OSE.languages},t=await renderTemplate(`${F.systemPath()}/templates/actors/dialogs/lang-create.html`,e);return new Promise((e=>{new Dialog({title:"",content:t,buttons:{ok:{label:game.i18n.localize("OSE.Ok"),icon:'<i class="fas fa-check"></i>',callback:t=>{e({choice:t.find('select[name="choice"]').val()})}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("OSE.Cancel")}},default:"ok"}).render(!0)}))}_pushLang(e){let t=this.actor.system[e];this._chooseLang().then((a=>{const i=CONFIG.OSE.languages[a.choice];t.value?t.value.push(i):t={value:[i]};const s={};return s[e]=t,this.actor.update({system:s})}))}_popLang(e,t){const a=this.actor.system[e].value.filter((e=>e!=t)),i={};return i[e]={value:a},this.actor.update({system:i})}_onShowModifiers(e){e.preventDefault(),new j(this.actor,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}async _onShowGpCost(e,t){e.preventDefault(),new x(this.actor,t,{top:this.position.top+40,left:this.position.left+(this.position.width-400)/2}).render(!0)}async _onShowItemTooltip(e){const t=await renderTemplate(`${F.systemPath()}/templates/actors/partials/character-item-tooltip.html`,{});document.querySelector(".game").append(t)}activateListeners(e){super.activateListeners(e),e.find(".ability-score .attribute-name a").click((e=>{const t=this.actor,a=e.currentTarget,{score:i}=a.parentElement.parentElement.dataset,{stat:s}=a.parentElement.parentElement.dataset;i?t.rollCheck(i,{event:e}):"lr"===s&&t.rollLoyalty(i,{event:e})})),e.find(".exploration .attribute-name a").click((e=>{const t=this.actor,a=e.currentTarget.parentElement.parentElement.dataset.exploration;t.rollExploration(a,{event:e})})),e.find("a[data-action='modifiers']").click((e=>{this._onShowModifiers(e)})),e.find("a[data-action='gp-cost']").click((e=>{this._onShowGpCost(e,this.getData())})),this.options.editable&&(e.find(".item-push").click((e=>{e.preventDefault();const t=e.currentTarget.dataset.array;this._pushLang(t)})),e.find(".item-pop").click((e=>{e.preventDefault();const t=e.currentTarget.dataset.array;this._popLang(t,$(e.currentTarget).closest(".item").data("lang"))})),e.find(".item-toggle").click((async e=>{const t=$(e.currentTarget).parents(".item"),a=this.actor.items.get(t.data("itemId"));await a.update({system:{equipped:!a.system.equipped}})})),e.find("a[data-action='generate-scores']").click((e=>{this.generateScores(e)})))}}var G,L,W,B,U,K,V,Y,X,J,Q,Z,ee,te,ae,ie,se,ne,le,oe,re,de,ue,ce,me,ve,ge,he,ye,pe,fe,be,we,qe,Se,Oe,ke,Ee,Te,Ie,Ce,Ae,De;class Me{constructor(e=!1,i=[],s=0,n=0){G.add(this),L.set(this,void 0),W.set(this,void 0),B.set(this,void 0),U.set(this,void 0),K.set(this,void 0),a(this,K,e,"f"),a(this,L,i,"f"),a(this,W,s,"f"),a(this,B,n,"f"),a(this,U,t(this,K,"f")?Me.propAscending:Me.propDescending,"f")}get base(){return t(this,K,"f")?Me.baseAscending:Me.baseDescending}get naked(){return t(this,K,"f")?this.base+t(this,W,"f"):this.base-t(this,W,"f")}get shield(){return t(this,G,"m",V).call(this)}get value(){const e=null===t(this,G,"a",Y)?this.naked:t(this,G,"a",Y);return t(this,K,"f")?e+this.shield+this.mod:e-this.shield-this.mod}set value(e){}get mod(){return t(this,B,"f")}set mod(e){a(this,B,e,"f")}}L=new WeakMap,W=new WeakMap,B=new WeakMap,U=new WeakMap,K=new WeakMap,G=new WeakSet,V=function(){var e;return(null===(e=t(this,L,"f").find((({system:{type:e}})=>"shield"===e)))||void 0===e?void 0:e.system[t(this,U,"f")].value)||0},Y=function(){var e;const a=null===(e=t(this,L,"f").find((({system:{type:e}})=>"shield"!==e)))||void 0===e?void 0:e.system[t(this,U,"f")].value;return a||0===a?t(this,K,"f")?a+t(this,W,"f"):a-t(this,W,"f"):null},Object.defineProperty(Me,"baseAscending",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(Me,"baseDescending",{enumerable:!0,configurable:!0,writable:!0,value:9}),Object.defineProperty(Me,"propAscending",{enumerable:!0,configurable:!0,writable:!0,value:"aac"}),Object.defineProperty(Me,"propDescending",{enumerable:!0,configurable:!0,writable:!0,value:"ac"});class Fe{constructor(e=new T,t=!0,i=Fe.baseMoveRate){X.add(this),J.set(this,void 0),Q.set(this,void 0),Z.set(this,void 0),ee.set(this,void 0),te.set(this,void 0),ae.set(this,void 0),ie.set(this,void 0),a(this,J,i,"f"),a(this,Q,t,"f"),a(this,Z,e.variant,"f"),a(this,ee,e.encumbered,"f"),a(this,te,e.atFirstBreakpoint,"f"),a(this,ae,e.atSecondBreakpoint,"f"),a(this,ie,e.atThirdBreakpoint,"f")}get base(){return t(this,Q,"f")&&"disabled"!==t(this,Z,"f")?t(this,X,"m",se).call(this):t(this,J,"f")}set base(e){a(this,J,e,"f")}get encounter(){return this.base/3}get overland(){return this.base/5}}J=new WeakMap,Q=new WeakMap,Z=new WeakMap,ee=new WeakMap,te=new WeakMap,ae=new WeakMap,ie=new WeakMap,X=new WeakSet,se=function(){return t(this,ee,"f")?0:t(this,ie,"f")?.25*t(this,J,"f"):t(this,ae,"f")?.5*t(this,J,"f"):t(this,te,"f")?.75*t(this,J,"f"):t(this,J,"f")},Object.defineProperty(Fe,"baseMoveRate",{enumerable:!0,configurable:!0,writable:!0,value:120});class $e{constructor({str:e,int:t,wis:i,dex:s,con:n,cha:l}){ne.add(this),le.set(this,{value:0,bonus:0}),oe.set(this,{value:0,bonus:0}),re.set(this,{value:0,bonus:0}),de.set(this,{value:0,bonus:0}),ue.set(this,{value:0,bonus:0}),ce.set(this,{value:0,bonus:0}),a(this,le,e,"f"),a(this,oe,t,"f"),a(this,re,i,"f"),a(this,de,s,"f"),a(this,ue,n,"f"),a(this,ce,l,"f")}static valueFromTable(e,t){let a;for(let i=0;i<=t;i+=1)void 0!==e[i]&&(a=e[i]);return a}get str(){return{value:t(this,le,"f").value,bonus:t(this,le,"f").bonus,mod:t(this,ne,"a",me),od:t(this,ne,"a",ve)}}set str(e){a(this,le,Object.assign(Object.assign({},t(this,le,"f")),e),"f")}get int(){return{value:t(this,oe,"f").value,bonus:t(this,oe,"f").bonus,mod:t(this,ne,"a",ge),literacy:t(this,ne,"a",he),spoken:t(this,ne,"a",ye)}}set int(e){a(this,oe,Object.assign(Object.assign({},t(this,oe,"f")),e),"f")}get wis(){return{value:t(this,re,"f").value,bonus:t(this,re,"f").bonus,mod:t(this,ne,"a",pe)}}set wis(e){a(this,re,Object.assign(Object.assign({},t(this,re,"f")),e),"f")}get dex(){return{value:t(this,de,"f").value,bonus:t(this,de,"f").bonus,mod:t(this,ne,"a",fe),init:t(this,ne,"a",be)}}set dex(e){a(this,de,Object.assign(Object.assign({},t(this,de,"f")),e),"f")}get con(){return{value:t(this,ue,"f").value,bonus:t(this,ue,"f").bonus,mod:t(this,ne,"a",we)}}set con(e){a(this,ue,Object.assign(Object.assign({},t(this,ue,"f")),e),"f")}get cha(){return{value:t(this,ce,"f").value,bonus:t(this,ce,"f").bonus,mod:t(this,ne,"a",qe),loyalty:t(this,ne,"a",ke),retain:t(this,ne,"a",Oe),npc:t(this,ne,"a",Se)}}set cha(e){a(this,ce,Object.assign(Object.assign({},t(this,ce,"f")),e),"f")}}le=new WeakMap,oe=new WeakMap,re=new WeakMap,de=new WeakMap,ue=new WeakMap,ce=new WeakMap,ne=new WeakSet,me=function(){return $e.valueFromTable($e.standardAttributeMods,t(this,le,"f").value)},ve=function(){return $e.valueFromTable($e.openDoorMods,t(this,le,"f").value)},ge=function(){return $e.valueFromTable($e.standardAttributeMods,t(this,oe,"f").value)},he=function(){return $e.valueFromTable($e.literacyMods,t(this,oe,"f").value)},ye=function(){return $e.valueFromTable($e.spokenMods,t(this,oe,"f").value)},pe=function(){return $e.valueFromTable($e.standardAttributeMods,t(this,re,"f").value)},fe=function(){return $e.valueFromTable($e.standardAttributeMods,t(this,de,"f").value)},be=function(){return $e.valueFromTable($e.cappedAttributeMods,t(this,de,"f").value)},we=function(){return $e.valueFromTable($e.standardAttributeMods,t(this,ue,"f").value)},qe=function(){return $e.valueFromTable($e.standardAttributeMods,t(this,ce,"f").value)},Se=function(){return $e.valueFromTable($e.cappedAttributeMods,t(this,ce,"f").value)},Oe=function(){return t(this,ne,"a",qe)+4},ke=function(){return t(this,ne,"a",qe)+7},Object.defineProperty($e,"standardAttributeMods",{enumerable:!0,configurable:!0,writable:!0,value:{0:-3,3:-3,4:-2,6:-1,9:0,13:1,16:2,18:3}}),Object.defineProperty($e,"cappedAttributeMods",{enumerable:!0,configurable:!0,writable:!0,value:{0:-2,3:-2,4:-1,6:-1,9:0,13:1,16:1,18:2}}),Object.defineProperty($e,"openDoorMods",{enumerable:!0,configurable:!0,writable:!0,value:{0:0,3:1,9:2,13:3,16:4,18:5}}),Object.defineProperty($e,"literacyMods",{enumerable:!0,configurable:!0,writable:!0,value:{0:"",3:"OSE.Illiterate",6:"OSE.LiteracyBasic",9:"OSE.Literate"}}),Object.defineProperty($e,"spokenMods",{enumerable:!0,configurable:!0,writable:!0,value:{0:"OSE.NativeBroken",3:"OSE.Native",13:"OSE.NativePlus1",16:"OSE.NativePlus2",18:"OSE.NativePlus3"}});class _e{constructor(e,i){var s,{enabled:n}=e,l=function(e,t){var a={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(a[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(e);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(e,i[s])&&(a[i[s]]=e[i[s]])}return a}(e,["enabled"]);void 0===i&&(i=[]),Ee.add(this),Te.set(this,{}),Ie.set(this,[]),Ce.set(this,void 0),a(this,Ie,i,"f"),a(this,Ce,n||!1,"f");const o=(null===(s=t(this,Ie,"f"))||void 0===s?void 0:s.reduce(t(this,Ee,"m",Ae),{}))||{};a(this,Te,Object.keys(l||{}).reduce(((e,a,i)=>t(this,Ee,"m",De).call(this,e,a,i,o,l)),{}),"f")}get enabled(){return t(this,Ce,"f")}set enabled(e){a(this,Ce,e,"f")}get spellList(){return t(this,Ie,"f").reduce(((e,t)=>((e,t)=>{const{lvl:a}=t.system,i=e[a]||[];return Object.assign(Object.assign({},e),{[a]:[...i,t].sort(((e,t)=>e.name.localeCompare(t.name)))})})(e,t)),{})}get slots(){return t(this,Te,"f")}}Te=new WeakMap,Ie=new WeakMap,Ce=new WeakMap,Ee=new WeakSet,Ae=function(e,t){const{lvl:a}=t.system;let{cast:i}=t.system;Number.isNaN(i)&&(i=0);const s=e[a]||0;return Object.assign(Object.assign({},e),{[a]:s+i})},De=function(e,t,a,i,s){var n;if("enabled"===t)return e;const l=a+1,o=(null===(n=s[l])||void 0===n?void 0:n.max)||0,r=i[l];return Object.assign(Object.assign({},e),{[l]:{used:r,max:o}})};const Ne=(e,t,a=null)=>e.items.filter((({type:e})=>e===t)).filter(a||(()=>!0));class xe extends foundry.abstract.TypeDataModel{prepareDerivedData(){this.scores=new $e(this.scores),this.encumbrance=new CONFIG.OSE.encumbrance(this.encumbrance.max,[...this.parent.items],{significantTreasure:game.settings.get(game.system.id,"significantTreasure"),scores:this.scores}),this.movement=new Fe(this.encumbrance,this.config.movementAuto,this.movement.base),this.ac=new Me(!1,[...Ne(this.parent,"armor",(e=>e.system.equipped))],this.scores.dex.mod,this.ac.mod),this.aac=new Me(!0,Ne(this.parent,"armor",(e=>e.system.equipped)),this.scores.dex.mod,this.aac.mod),this.spells=new _e(this.spells,this.#a)}static defineSchema(){const{StringField:e,NumberField:t,BooleanField:a,ObjectField:i,SchemaField:s}=foundry.data.fields;return{spells:new i,scores:new i,details:new i,ac:new i,aac:new i,encumbrance:new i,movement:new i,config:new i,initiative:new i,hp:new s({hd:new e,value:new t({integer:!0}),max:new t({integer:!0})}),thac0:new i,languages:new i,saves:new s({breath:new s({value:new t({integer:!0})}),death:new s({value:new t({integer:!0})}),paralysis:new s({value:new t({integer:!0})}),spell:new s({value:new t({integer:!0})}),wand:new s({value:new t({integer:!0})})}),exploration:new s({ft:new t({integer:!0,positive:!0}),ld:new t({integer:!0,positive:!0}),od:new t({integer:!0,positive:!0}),sd:new t({integer:!0,positive:!0})}),retainer:new s({enabled:new a,loyalty:new t({integer:!0}),wage:new e})}}get usesAscendingAC(){return game.settings.get(game.system.id,"ascendingAC")}get meleeMod(){const e=this.usesAscendingAC&&this.thac0.bba||0;return(this.scores.str?.mod||0)+(this.thac0?.mod?.melee||0)+e}get rangedMod(){const e=this.usesAscendingAC&&this.thac0.bba||0;return(this.scores.dex?.mod||0)+(this.thac0?.mod?.missile||0)+e}get isNew(){const{str:e,int:t,wis:a,dex:i,con:s,cha:n}=this.scores;return![e,t,a,i,s,n].reduce(((e,t)=>e+t.value),0)}get containers(){return Ne(this.parent,"container",(({system:{containerId:e}})=>!e))}get treasures(){return Ne(this.parent,"item",(({system:{treasure:e,containerId:t}})=>e&&!t))}get carriedTreasure(){const e=this.treasures.reduce(((e,{system:{quantity:t,cost:a}})=>e+t.value*a),0);return Math.round(100*e)/100}get items(){return Ne(this.parent,"item",(({system:{treasure:e,containerId:t}})=>!e&&!t))}get weapons(){return Ne(this.parent,"weapon",(({system:{containerId:e}})=>!e))}get armor(){return Ne(this.parent,"armor",(({system:{containerId:e}})=>!e))}get abilities(){return Ne(this.parent,"ability",(({system:{containerId:e}})=>!e)).sort(((e,t)=>(e.sort||0)-(t.sort||0)))}get#a(){return Ne(this.parent,"spell",(({system:{containerId:e}})=>!e))}get isSlow(){return 0!==this.weapons.length&&this.weapons.every((e=>!("weapon"!==e.type||!e.system.slow||!e.system.equipped)))}get init(){return"group"!==game.settings.get(game.system.id,"initiative")?(this.initiative.value||0)+(this.initiative.mod||0)+this.scores.dex.init:0}}const je=(e,t,a=null)=>e.items.filter((({type:e})=>e===t)).filter(a||(()=>!0));class Re extends foundry.abstract.TypeDataModel{prepareDerivedData(){this.encumbrance=new D,this.spells=new _e(this.spells,this.#a),this.movement=new Fe(this.encumbrance,this.config.movementAuto=!1,this.movement.base)}static defineSchema(){const{StringField:e,NumberField:t,BooleanField:a,ObjectField:i,SchemaField:s}=foundry.data.fields;return{spells:new i,details:new i,ac:new i,aac:new i,encumbrance:new s({value:new t({integer:!1}),max:new t({integer:!1})}),movement:new i,config:new i,initiative:new i,hp:new s({hd:new e,value:new t({integer:!0}),max:new t({integer:!0})}),thac0:new i,languages:new i,saves:new s({breath:new s({value:new t({integer:!0})}),death:new s({value:new t({integer:!0})}),paralysis:new s({value:new t({integer:!0})}),spell:new s({value:new t({integer:!0})}),wand:new s({value:new t({integer:!0})})}),retainer:new s({enabled:new a,loyalty:new t({integer:!0}),wage:new e})}}get usesAscendingAC(){return game.settings.get(game.system.id,"ascendingAC")}get isNew(){return!Object.values(this.saves).reduce(((e,t)=>e+(parseInt(t?.value,10)||0)),0)}get containers(){return je(this.parent,"container",(({system:{containerId:e}})=>!e))}get treasures(){return je(this.parent,"item",(({system:{treasure:e,containerId:t}})=>e&&!t)).sort(((e,t)=>e.name.localeCompare(t.name)))}get items(){return je(this.parent,"item",(({system:{treasure:e,containerId:t}})=>!e&&!t)).sort(((e,t)=>e.name.localeCompare(t.name)))}get weapons(){return je(this.parent,"weapon",(({system:{containerId:e}})=>!e)).sort(((e,t)=>e.name.localeCompare(t.name)))}get armor(){return je(this.parent,"armor",(({system:{containerId:e}})=>!e)).sort(((e,t)=>e.name.localeCompare(t.name)))}get abilities(){return je(this.parent,"ability",(({system:{containerId:e}})=>!e)).sort(((e,t)=>(e.sort||0)-(t.sort||0)))}get attackPatterns(){return[...this.weapons,...this.abilities].sort(((e,t)=>"transparent"!==e.system.pattern&&"transparent"===t.system.pattern?-1:t.type.localeCompare(e.type)||e.name.localeCompare(t.name))).reduce(((e,t)=>{const a={...e},{pattern:i}=t.system;return a[i]||(a[i]=[]),{...a,[i]:[...a[i],t]}}),{})}get#a(){return je(this.parent,"spell",(({system:{containerId:e}})=>!e))}get isSlow(){return 0!==this.weapons.length&&this.weapons.every((e=>!("weapon"!==e.type||!e.system.slow)))}get init(){return"group"!==game.settings.get(game.system.id,"initiative")?this.initiative.mod:0}}class ze extends Item{static get defaultIcons(){return{spell:`${F.assetsPath}/default/spell.png`,ability:`${F.assetsPath}/default/ability.png`,armor:`${F.assetsPath}/default/armor.png`,weapon:`${F.assetsPath}/default/weapon.png`,item:`${F.assetsPath}/default/item.png`,container:`${F.assetsPath}/default/bag.png`}}static async create(e,t={}){return void 0===e.img&&(e.img=this.defaultIcons[e.type]),super.create(e,t)}static migrateData(e){return""===e?.img&&e.type&&(e.img=this.defaultIcons(e.type)),void 0===e?.system?.itemslots&&((e?.system?.tags??[]).some((e=>"Two-handed"===e.value))&&"weapon"===e?.type&&(e.system.itemslots=2),"heavy"===e?.system?.type&&"armor"===e.type&&(e.system.itemslots=2)),e}prepareData(){super.prepareData()}async prepareDerivedData(){this.system.enrichedDescription=await TextEditor.enrichHTML(this.system.details?.description||this.system.description,{async:!0})}static chatListeners(e){e.on("click",".card-buttons button",this._onChatCardAction.bind(this)),e.on("click",".item-name",this._onChatCardToggleContent.bind(this))}async getChatData(e){const t=this.type,a=this.system,i=[];return"weapon"===t&&a.tags.forEach((e=>i.push(e.value))),"spell"===t&&i.push(`${a.class} ${a.lvl}`,a.range,a.duration),a.hasOwnProperty("equipped")&&i.push(a.equipped?"Equipped":"Not Equipped"),a.properties=i.filter((e=>!!e)),a}rollWeapon(e={}){const t="character"!=this.actor.type,a=this.system;let i=t?"attack":"melee";const s={item:this._source,actor:this.actor,roll:{save:a.save,target:null}};return a.missile&&a.melee&&!t?(new Dialog({title:"Choose Attack Range",content:"",buttons:{melee:{icon:'<i class="fas fa-fist-raised"></i>',label:"Melee",callback:()=>{this.actor.targetAttack(s,"melee",e)}},missile:{icon:'<i class="fas fa-bullseye"></i>',label:"Missile",callback:()=>{this.actor.targetAttack(s,"missile",e)}}},default:"melee"}).render(!0),!0):(a.missile&&!t&&(i="missile"),this.actor.targetAttack(s,i,e),!0)}async rollFormula(e={}){const t=this.system;if(!t.roll)throw new Error("This Item does not have a formula to roll!");const a=`${this.name}`,i=[t.roll],s=t.rollType,n={actor:this.actor,item:this._source,description:null,save:t.save,properties:this.system.autoTags,roll:{type:s,target:t.rollTarget,blindroll:t.blindroll}};return"spell"===this.type&&(n.description=t.description),_.Roll({event:e.event,parts:i,data:n,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.formula",{label:a}),title:game.i18n.format("OSE.roll.formula",{label:a})})}async spendSpell(){if("spell"!==this.type)throw new Error("Trying to spend a spell on an item that is not a spell.");const e=this.system;await this.update({system:{cast:e.cast-1}}),e.roll?await this.rollFormula():await this.show({skipDialog:!0})}_getRollTag(e){if(e.roll){const t=`${e.roll}${e.rollTarget?CONFIG.OSE.roll_type[e.rollType]:""}${e.rollTarget?e.rollTarget:""}`;return{label:`${game.i18n.localize("OSE.items.Roll")} ${t}`}}}_getSaveTag(e){if(e.save)return{label:CONFIG.OSE.saves_long[e.save],icon:"fa-skull"}}getAutoTagList(){const e=[],t=this.system;switch(this.type){case"container":case"item":break;case"weapon":e.push({label:t.damage,icon:"fa-tint"}),t.missile&&e.push({label:`${t.range.short}/${t.range.medium}/${t.range.long}`,icon:"fa-bullseye"}),t.tags.forEach((t=>{e.push({label:t.value})}));break;case"armor":e.push({label:CONFIG.OSE.armor[t.type],icon:"fa-tshirt"});break;case"spell":e.push({label:t.class},{label:t.range},{label:t.duration});break;case"ability":t.requirements.split(",").forEach((t=>e.push({label:t})));break}const a=this._getRollTag(t);a&&e.push(a);const i=this._getSaveTag(t);return i&&e.push(i),e}pushManualTag(e){const t=this?.system;let a=[];t.tags&&(a=t.tags);const i={},s=/\(([^)]+)\)/;return a?e.forEach((e=>{const t=s.exec(e);let n="";switch(t?(n=t[1],e=e.slice(0,Math.max(0,t.index)).trim()):n=e=e.trim(),e){case CONFIG.OSE.tags.melee:i.melee=!0;break;case CONFIG.OSE.tags.slow:i.slow=!0;break;case CONFIG.OSE.tags.missile:i.missile=!0}i.melee||i.slow||i.missile||a.push({title:n,value:e,label:e})})):a=e,i.tags=a,this.update({system:i})}popManualTag(e){const t=this.system,{tags:a}=t;if(!a)return;const i={tags:a.filter((t=>t.value!=e))};return this.update({system:i})}roll(e={}){const t=this.system;switch(this.type){case"weapon":this.rollWeapon(e);break;case"spell":this.spendSpell(e);break;case"ability":t.roll?this.rollFormula():this.show();break;case"item":case"armor":this.show()}}async show(){const e=this.type,{token:t}=this.actor,a={actor:this.actor,tokenId:t?`${t.parent.id}.${t.id}`:null,item:this._source,itemId:this._source.id,data:await this.getChatData(),labels:this.labels,isHealing:this.isHealing,hasDamage:this.hasDamage,isSpell:"spell"===e,hasSave:this.hasSave,config:CONFIG.OSE};a.rollFormula=new Roll(a.data.roll,a).formula,a.data.properties=this.system.autoTags;const i=`${F.systemPath()}/templates/chat/item-card.html`,s=await renderTemplate(i,a),n={user:game.user.id,type:CONST.CHAT_MESSAGE_STYLES.OTHER,content:s,speaker:{actor:this.actor.id,token:this.actor.token,alias:this.actor.name}},l=game.settings.get("core","rollMode");return["gmroll","blindroll"].includes(l)&&(n.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===l&&(n.whisper=[game.user.id]),"blindroll"===l&&(n.blind=!0),ChatMessage.create(n)}static _onChatCardToggleContent(e){e.preventDefault();const t=e.currentTarget.closest(".chat-card").querySelector(".card-content");"none"===t.style.display?$(t).slideDown(200):$(t).slideUp(200)}static async _onChatCardAction(e){e.preventDefault();const t=e.currentTarget;t.disabled=!0;const a=t.closest(".chat-card"),{messageId:i}=a.closest(".message").dataset,s=game.messages.get(i),{action:n}=t.dataset,l="save"===n;if(!(l||game.user.isGM||s.isAuthor))return;const o=this._getChatCardActor(a);if(!o)return;const r=o.items.get(a.dataset.itemId);if(!r)return ui.notifications.error(game.i18n.format("OSE.error.itemNoLongerExistsOnActor",{actorName:o.name,itemId:a.dataset.itemId}));let d=[];switch(l&&(d=this._getChatCardTargets(a)),n){case"damage":await r.rollDamage({event:e});break;case"formula":await r.rollFormula({event:e});break;case"save":if(0===d.length)return ui.notifications.error(game.i18n.localize("OSE.error.noTokenControlled")),t.disabled=!1;for(const a of d)await a.rollSave(t.dataset.save,{event:e})}t.disabled=!1}static _getChatCardActor(e){const t=e.dataset.tokenId;if(t){const[e,a]=t.split("."),i=game.scenes.get(e);if(!i)return null;const s=i.getEmbeddedDocument("Token",a);if(!s)return null;return new Token(s).actor}const{actorId:a}=e.dataset;return game.actors.get(a)||null}static _getChatCardTargets(e){const{character:t}=game.user,{controlled:a}=canvas.tokens,i=a.reduce(((e,t)=>t.actor?[...e,t.actor]:e),[]);return t&&0===a.length&&i.push(t),i}}const Pe=e=>e.reduce(((e,t)=>t?[...e,t]:e),[]);class He extends Actor{prepareDerivedData(){game.version.startsWith("10")&&this.system.prepareDerivedData?.()}static migrateData(e){return""===e?.img&&(e.img="icons/svg/mystery-man.svg"),""===e?.prototypeToken?.texture?.img&&(e.prototypeToken.texture.img="icons/svg/mystery-man.svg"),e?.system?.movement?.value&&!e?.system?.details.movement&&(e.system.details.movement=e.system.movement.value,delete e.system.movement.value),e}async update(e,t={}){const a={...e},{"system.ac.value":i,"system.aac.value":s,"system.thac0.bba":n,"system.thac0.value":l}=a;i?a["system.aac.value"]=19-i:s&&(a["system.ac.value"]=19-s),l?a["system.thac0.bba"]=19-l:n&&(a["system.thac0.value"]=19-n),super.update(a,t)}async createEmbeddedDocuments(e,t=[],a={}){return t.map((e=>{void 0===e.img&&(e.img=ze.defaultIcons[e.type])})),super.createEmbeddedDocuments(e,t,a)}getExperience(e,t={}){const a=this.system;if("character"!==this.type)return;const i=Math.floor(e+a.details.xp.bonus*e/100);return this.update({"system.details.xp.value":i+a.details.xp.value}).then((()=>{const e=ChatMessage.getSpeaker({actor:this});ChatMessage.create({content:game.i18n.format("OSE.messages.GetExperience",{name:this.name,value:i}),speaker:e})}))}isNew(){return this.system.isNew}generateSave(e){e=e.includes("+")?parseInt(e)+1:parseInt(e);let t={};for(let a=0;a<=e;a++){const e=CONFIG.OSE.monster_saves[a];e&&(t=e)}let a=20;Object.keys(CONFIG.OSE.monster_thac0).forEach((t=>{e<parseInt(t)||(a=CONFIG.OSE.monster_thac0[t])})),this.update({"system.thac0.value":a,"system.thac0.bba":19-a,"system.saves":{death:{value:t.d},wand:{value:t.w},paralysis:{value:t.p},breath:{value:t.b},spell:{value:t.s}}})}async rollHP(e={}){const{total:t}=await new Roll(this.system.hp.hd).roll({async:!0});return this.update({"system.hp":{max:t,value:t}})}rollSave(e,t={}){const a=game.i18n.localize(`OSE.saves.${e}.long`),i=this.system,s=this.type,n={actor:this,roll:{type:"above",target:i.saves[e].value,magic:"character"===s?i.scores.wis.mod:0},details:game.i18n.format("OSE.roll.details.save",{save:a})};return("character"===s?_.RollSave:_.Roll)({event:t.event,parts:["1d20"],data:n,skipDialog:t.fastForward||R(t.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.save",{save:a}),title:game.i18n.format("OSE.roll.save",{save:a}),chatMessage:t.chatMessage})}rollMorale(e={}){const t={actor:this,roll:{type:"below",target:this.system.details.morale}};return _.Roll({event:e.event,parts:["2d6"],data:t,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.localize("OSE.roll.morale"),title:game.i18n.localize("OSE.roll.morale")})}rollLoyalty(e={}){const t=game.i18n.localize("OSE.roll.loyalty"),a={actor:this,roll:{type:"below",target:this.system.retainer.loyalty}};return _.Roll({event:e.event,parts:["2d6"],data:a,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:t,title:t})}rollReaction(e={}){const t={actor:this,roll:{type:"table",table:{2:game.i18n.format("OSE.reaction.Hostile",{name:this.name}),3:game.i18n.format("OSE.reaction.Unfriendly",{name:this.name}),6:game.i18n.format("OSE.reaction.Neutral",{name:this.name}),9:game.i18n.format("OSE.reaction.Indifferent",{name:this.name}),12:game.i18n.format("OSE.reaction.Friendly",{name:this.name})}}};return _.Roll({event:e.event,parts:["2d6"],data:t,skipDialog:e.fastForward||R(e.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.localize("OSE.reaction.check"),title:game.i18n.localize("OSE.reaction.check")})}rollCheck(e,t={}){if("character"!==this.type)return;const a=this.system,i=game.i18n.localize(`OSE.scores.${e}.long`),s={actor:this,roll:{type:"check",target:a.scores[e].value},details:game.i18n.format("OSE.roll.details.attribute",{score:i})};return _.Roll({event:t.event,parts:["1d20"],data:s,skipDialog:t.fastForward||R(t.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.attribute",{attribute:i}),title:game.i18n.format("OSE.roll.attribute",{attribute:i}),chatMessage:t.chatMessage})}rollHitDice(e={}){const t=this.type,a=this.system,i=game.i18n.localize("OSE.roll.hd"),s=[a.hp.hd];"character"===t&&s.push(a.scores.con.mod*a.details.level);const n={actor:this,roll:{type:"hitdice"}};return _.Roll({event:e.event,parts:s,data:n,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:i,title:i})}rollAppearing(e={}){if("monster"!==this.type)return;const t=this.system,a=[];let i="";"wilderness"===e.check?(a.push(t.details.appearing.w),i="(2)"):(a.push(t.details.appearing.d),i="(1)");const s={actor:this,roll:{type:{type:"appearing"}}};return _.Roll({event:e.event,parts:a,data:s,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.appearing",{type:i}),title:game.i18n.format("OSE.roll.appearing",{type:i})})}rollExploration(e,t={}){if("character"!==this.type)return;const a=this.system,i=game.i18n.localize(`OSE.exploration.${e}.long`),s={actor:this,roll:{type:"below",target:a.exploration[e],blindroll:!0},details:game.i18n.format("OSE.roll.details.exploration",{expl:i})};return _.Roll({event:t.event,parts:["1d6"],data:s,skipDialog:t.fastForward||R(t.event),speaker:ChatMessage.getSpeaker({actor:this}),flavor:game.i18n.format("OSE.roll.exploration",{exploration:i}),title:game.i18n.format("OSE.roll.exploration",{exploration:i})})}rollDamage(e,t={}){const a=this.system,i={actor:this,item:e.item,roll:{type:"damage"}},s=[];e.roll.dmg?s.push(e.roll.dmg):s.push("1d6"),"melee"===e.roll.type&&a.scores.str.mod&&s.push(a.scores.str.mod),_.Roll({event:t.event,parts:s,data:i,skipDialog:!0,speaker:ChatMessage.getSpeaker({actor:this}),flavor:`${e.label} - ${game.i18n.localize("OSE.Damage")}`,title:`${e.label} - ${game.i18n.localize("OSE.Damage")}`})}async targetAttack(e,t,a){if(game.user.targets.size>0)for(const i of game.user.targets.values())e.roll.target=i,await this.rollAttack(e,{type:t,skipDialog:a.skipDialog});else this.rollAttack(e,{type:t,skipDialog:a.skipDialog})}rollAttack(e,t={}){const a=this.system,i=e.item?game.i18n.format("OSE.roll.attacksWith",{name:e.item.name}):game.i18n.format("OSE.roll.attacks",{name:this.name}),s=Pe([e.item?.system?.damage??"1d6"]);!this.system.config?.ignoreBonusDamage&&e.item?.system?.bonus&&s.push(e.item?.system?.bonus);const n=["1d20"];game.settings.get(game.system.id,"ascendingAC")&&a.thac0.bba&&n.push(a.thac0.bba);let l=[];"melee"===t.type&&(l=[a.scores.str.mod,a.thac0.mod.melee]),s.push(...Pe(l)),"missile"===t.type&&(l=[a.scores.dex.mod,a.thac0.mod.missile]),e.item&&l.push(e.item?.system?.bonus),n.push(...Pe(l));const o={actor:this,item:e.item,itemId:e.item?._id,roll:{type:t.type,thac0:a.thac0.value,dmg:s,save:e.roll.save,target:e.roll.target}};return _.Roll({event:t.event,parts:n,data:o,skipDialog:t.skipDialog,speaker:ChatMessage.getSpeaker({actor:this}),flavor:i,flags:{ose:{roll:"attack",itemId:e.item?._id}},title:i})}async applyDamage(e=0,t=1){e=Math.floor(parseInt(e)*t);const{value:a,max:i}=this.system.hp;return this.update({"system.hp.value":Math.clamp(a-e,0,i)})}}class Ge extends P{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","sheet","monster","actor"],template:`${F.systemPath()}/templates/actors/monster-sheet.html`,width:450,height:560,resizable:!0,tabs:[{navSelector:".tabs",contentSelector:".sheet-body",initial:"attributes"}]})}_prepareItems(e){e.owned={weapons:this.actor.system.weapons,items:this.actor.system.items,containers:this.actor.system.containers,armors:this.actor.system.armor,treasures:this.actor.system.treasures},e.attackPatterns=this.actor.system.attackPatterns,e.spells=this.actor.system.spells.spellList}async getData(){const e=super.getData();this._prepareItems(e);const t=e?.system;return e.config.morale=game.settings.get(game.system.id,"morale"),t.details.treasure.link=await TextEditor.enrichHTML(t.details.treasure.table,{async:!0}),e.isNew=this.actor.isNew(),foundry.utils.isNewerVersion(game.version,"10.264")&&(e.enrichedBiography=await TextEditor.enrichHTML(this.object.system.details.biography,{async:!0})),e}async generateSave(){const e={choices:CONFIG.OSE.monster_saves},t=await renderTemplate(`${F.systemPath()}/templates/actors/dialogs/monster-saves.html`,e);new Dialog({title:game.i18n.localize("OSE.dialog.generateSaves"),content:t,buttons:{ok:{label:game.i18n.localize("OSE.Ok"),icon:'<i class="fas fa-check"></i>',callback:e=>{const t=e.find('input[name="hd"]').val();this.actor.generateSave(t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("OSE.Cancel")}},default:"ok"},{width:250}).render(!0)}async _onDrop(e){let t;super._onDrop(e);try{if(t=JSON.parse(e.dataTransfer.getData("text/plain")),"RollTable"!==t.type)return}catch(e){return!1}let a="";if(t.pack){const e=game.packs.get(t.pack).index.find((e=>e._id===t.id));a=`@UUID[${t.uuid}]{${e.name}}`}else a=`@UUID[${t.uuid}]`;this.actor.update({"system.details.treasure.table":a})}async _resetAttacks(e){return Promise.all(this.actor.items.filter((e=>"weapon"===e.type)).map((e=>e.update({"system.counter.value":parseInt(e.system.counter.max)}))))}async _updateAttackCounter(e){e.preventDefault();const t=this._getItemFromActor(e);return"value"===e.target.dataset.field?t.update({"system.counter.value":parseInt(e.target.value)}):"max"===e.target.dataset.field?t.update({"system.counter.max":parseInt(e.target.value)}):void 0}_cycleAttackPatterns(e){const t=super._getItemFromActor(e),a=t.system.pattern,i=Object.keys(CONFIG.OSE.colors);i.push("transparent");let s=i.indexOf(a);s+1===i.length?s=0:s++,t.update({"system.pattern":i[s]})}activateListeners(e){super.activateListeners(e),e.find(".morale-check a").click((e=>{this.actor.rollMorale({event:e})})),e.find(".reaction-check a").click((e=>{this.actor.rollReaction({event:e})})),e.find(".appearing-check a").click((e=>{const t=this.actor,a=$(e.currentTarget).closest(".check-field").data("check");t.rollAppearing({event:e,check:a})})),e.find(".treasure-table a").contextmenu((e=>{this.actor.update({"system.details.treasure.table":null})})),this.options.editable&&(e.find(".item-reset[data-action='reset-attacks']").click((e=>{this._resetAttacks(e)})),e.find(".counter input").click((e=>e.target.select())).change(this._updateAttackCounter.bind(this)),e.find(".hp-roll").click((e=>{this.actor.rollHP({event:e})})),e.find(".item-pattern").click((e=>this._cycleAttackPatterns(e))),e.find('button[data-action="generate-saves"]').click((()=>this.generateSave())))}}const Le={rollTagFormula({actor:e={},data:t={roll:""}}={}){const a={actor:e,data:t};return new Roll(t.roll,a).formula},rollTagTarget:({rollType:e="",rollTarget:t=null}={})=>null===t?"":` ${CONFIG.OSE.roll_type[e]}${t}`};class We extends foundry.abstract.TypeDataModel{static defineSchema(){const{StringField:e,NumberField:t,BooleanField:a,ArrayField:i,ObjectField:s}=foundry.data.fields;return{save:new e,pattern:new e,requirements:new e,roll:new e,rollType:new e,rollTarget:new t,blindroll:new a,description:new e,tags:new i(new s)}}get#i(){if(!this.roll)return null;return{label:`${game.i18n.localize("OSE.items.Roll")} ${Le.rollTagFormula({actor:this.parent.actor,data:this._source})}${Le.rollTagTarget({rollType:this.rollType,rollTarget:this.rollTarget})}`}}get#s(){return this.save?{label:CONFIG.OSE.saves_long[this.save],icon:"fa-skull"}:null}get manualTags(){return this.tags||[]}get autoTags(){return[...this.requirements.split(",").map((e=>({label:e.trim()}))),this.#i,this.#s].filter((e=>!!e))}}class Be extends foundry.abstract.TypeDataModel{static ArmorTypes={unarmored:"OSE.armor.unarmored",light:"OSE.armor.light",heavy:"OSE.armor.heavy",shield:"OSE.armor.shield"};static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,BooleanField:i,ArrayField:s,ObjectField:n}=foundry.data.fields;return{type:new t({initial:"light",choices:Object.keys(Be.ArmorTypes)}),ac:new e({value:new a({initial:9})}),aac:new e({value:new a({initial:10})}),description:new t,tags:new s(new n),equipped:new i,cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0,initial:0}),max:new a({min:0,initial:0})}),weight:new a({min:0,initial:0}),itemslots:new a({min:0,initial:1})}}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t))).map((({title:e,value:t})=>({title:e,value:t,label:t})))}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags),t=this.tags.map((({value:t})=>e.find((({label:e})=>t===e))));return[{label:Be.ArmorTypes[this.type],icon:"fa-tshirt"},...t,...this.manualTags].flat().filter((e=>!!e))}}class Ue extends foundry.abstract.TypeDataModel{static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,ArrayField:i,ObjectField:s,BooleanField:n}=foundry.data.fields;return{itemIds:new i(new t),description:new t,tags:new i(new s),equipped:new n,cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0,initial:0}),max:new a({min:0,initial:0})}),weight:new a({min:0,initial:0}),itemslots:new a({min:0,initial:1})}}get contents(){if(!this.itemIds)return null;if(!this?.parent?.parent?.items)return null;const{id:e}=this.parent;return this.parent.parent.items.filter((({system:{containerId:t}})=>e===t))}get totalWeight(){return this.contents.reduce(((e,{system:{weight:t,quantity:a}})=>e+t*(a?.value||1)),0)}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t))).map((({title:e,value:t})=>({title:e,value:t,label:t})))}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags);return[...this.tags.map((({value:t})=>e.find((({label:e})=>t===e)))),...this.manualTags].flat().filter((e=>!!e))}}class Ke extends foundry.abstract.TypeDataModel{static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,BooleanField:i,ArrayField:s,ObjectField:n}=foundry.data.fields;return{treasure:new i,description:new t,tags:new s(new n),equipped:new i,cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0,initial:1}),max:new a({min:0,initial:0})}),weight:new a({min:0,initial:0}),itemslots:new a({min:0,initial:0})}}get cumulativeWeight(){return this.weight*this.quantity.value}get cumulativeCost(){return this.cost*this.quantity.value}get cumulativeItemslots(){return Math.ceil(this.itemslots*this.quantity.value)}static migrateData(e){return e.details?.description&&!e.description&&(e.description=e.details.description),e}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t))).map((({title:e,value:t})=>({title:e,value:t,label:t})))}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags);return[...this.tags.map((({value:t})=>e.find((({label:e})=>t===e)))),...this.manualTags].flat().filter((e=>!!e))}}class Ve extends foundry.abstract.TypeDataModel{static defineSchema(){const{StringField:e,NumberField:t,ArrayField:a,ObjectField:i}=foundry.data.fields;return{save:new e,lvl:new t({positive:!0,min:0}),class:new e,duration:new e,range:new e,roll:new e,memorized:new t({min:0}),cast:new t({min:0}),description:new e,tags:new a(new i)}}get#i(){if(!this.roll)return null;return{label:`${game.i18n.localize("OSE.items.Roll")} ${Le.rollTagFormula({actor:this.parent.actor,data:this._source})}`}}get#s(){return this.save?{label:CONFIG.OSE.saves_long[this.save],icon:"fa-skull"}:null}get manualTags(){return this.tags||[]}get autoTags(){return[{label:this.class},{label:this.range},{label:this.duration},this.#i,this.#s].filter((e=>!!e))}}class Ye extends foundry.abstract.TypeDataModel{static defineSchema(){const{SchemaField:e,StringField:t,NumberField:a,BooleanField:i,ArrayField:s,ObjectField:n}=foundry.data.fields;return{damage:new t,description:new t,tags:new s(new n),equipped:new i,save:new t,range:new e({short:new a({integer:!0,min:0,initial:0}),medium:new a({integer:!0,min:0,initial:0}),long:new a({integer:!0,min:0,initial:0})}),bonus:new a({}),pattern:new t,missile:new i,melee:new i,slow:new i,counter:new e({value:new a({integer:!0,min:0,initial:0}),max:new a({integer:!0,min:0,initial:0})}),cost:new a({min:0,initial:0}),containerId:new t,quantity:new e({value:new a({min:0}),max:new a({min:0})}),weight:new a({min:0}),itemslots:new a({min:0,initial:1})}}get#n(){return this.missile?[CONFIG.OSE.auto_tags.missile,{label:`${this.range.short}/${this.range.medium}/${this.range.long}`,icon:"fa-bullseye"}]:null}get#l(){return this.melee?CONFIG.OSE.auto_tags.melee:null}get#o(){return this.slow?CONFIG.OSE.auto_tags.slow:null}get#s(){return this.save?{label:CONFIG.OSE.saves_long[this.save],icon:"fa-skull"}:null}get manualTags(){if(!this.tags)return null;const e=new Set(Object.values(CONFIG.OSE.auto_tags).map((({label:e})=>e)));return this.tags.filter((({value:t})=>!e.has(t)))}get qualities(){return[...this.autoTags.filter((e=>!!e.image)).map((e=>({...e,title:e.label}))),...this.manualTags]}get autoTags(){const e=Object.values(CONFIG.OSE.auto_tags),t=this.tags.map((({value:t})=>e.find((({label:e})=>t===e))));return[{label:this.damage,icon:"fa-tint"},this.#l,this.#n,this.#o,...t,this.#s].flat().filter((e=>!!e))}}class Xe extends ItemSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","sheet","item"],width:520,height:390,resizable:!0,tabs:[{navSelector:".tabs",contentSelector:".sheet-body",initial:"description"}]})}get template(){return`${`${F.systemPath()}/templates/items`}/${this.item.type}-sheet.html`}async getData(){const{data:e}=super.getData();return e.editable=this.document.sheet.isEditable,e.config={...CONFIG.OSE,encumbrance:game.settings.get(game.system.id,"encumbranceOption")},e.enriched={description:await TextEditor.enrichHTML(this.item.system?.description||"",{async:!0})},e}activateListeners(e){e.find('input[data-action="add-tag"]').keypress((e=>{if(13===e.which){const t=$(e.currentTarget).val().split(",");this.object.pushManualTag(t)}})),e.find(".tag-delete").click((e=>{const t=e.currentTarget.parentElement.dataset.tag;this.object.popManualTag(t)})),e.find("a.melee-toggle").click((()=>{this.object.update({"system.melee":!this.object.system.melee})})),e.find("a.missile-toggle").click((()=>{this.object.update({"system.missile":!this.object.system.missile})})),super.activateListeners(e)}}function Je(t,a){var i,s;const n=t.find(".dice-total").last().text(),l=game.settings.get(game.system.id,"applyDamageOption");if(l===CONFIG.OSE.apply_damage_options.originalTarget){const i=t.find(".chat-target").last().data("id");(()=>{e(this,void 0,void 0,(function*(){var e;const t=null===(e=yield fromUuid(i||""))||void 0===e?void 0:e.actor;yield Qe(t,n,a,(null==t?void 0:t.name)||i||"original target")}))})()}l===CONFIG.OSE.apply_damage_options.targeted&&(null===(i=game.user)||void 0===i||i.targets.forEach((e=>Qe(e.actor,n,a,e.name)))),l===CONFIG.OSE.apply_damage_options.selected&&(null===(s=canvas.tokens)||void 0===s||s.controlled.forEach((e=>Qe(e.actor,n,a,e.name))))}function Qe(t,a,i,s){var n,l;return e(this,void 0,void 0,(function*(){(null===(n=game.user)||void 0===n?void 0:n.isGM)&&t instanceof He?yield t.applyDamage(a,i):null===(l=ui.notifications)||void 0===l||l.error(game.i18n.format("OSE.error.cantDealDamageTo",{nameOrId:s}))}))}const Ze=e=>et(e)&&!!e.find(".dice-roll").length;function et(e){var t,a,i,s;if(!e.find(".dice-total").length)return!1;const n=game.settings.get(game.system.id,"applyDamageOption");switch(n){case CONFIG.OSE.apply_damage_options.originalTarget:return!!e.find(".chat-target").last().data("id");case CONFIG.OSE.apply_damage_options.targeted:return!!(null===(a=null===(t=game.user)||void 0===t?void 0:t.targets)||void 0===a?void 0:a.size);case CONFIG.OSE.apply_damage_options.selected:return!!(null===(i=canvas.tokens)||void 0===i?void 0:i.controlled.length);default:return null===(s=ui.notifications)||void 0===s||s.error(game.i18n.format("OSE.error.unexpectedSettings",{configName:"applyDamageOption",configValue:n})),!1}}const tt={STATUS_SLOW:-789,STATUS_DIZZY:-790,debounce(e,t){let a=null;return(...i)=>{window.clearTimeout(a),a=window.setTimeout((()=>{e.apply(null,i)}),t)}},async rollInitiative(e,t){t.combatants=[];const a={},i=e?.combatants;i.forEach((e=>{const i=e.getFlag(game.system.id,"group");a[i]={present:!0},t.combatants.push(e)}));for(const e in a){const t=new Roll("1d6");await t.evaluate(),await t.toMessage({flavor:game.i18n.format("OSE.roll.initiative",{group:CONFIG.OSE.colors[e]})}),a[e].initiative=t.total}for(let e=0;e<t.combatants.length;++e)if(game.user.isGM){if(!t.combatants[e].actor)return;const i=t.combatants[e].actor?.system;if(i.isSlow)await t.combatants[e].update({initiative:tt.STATUS_SLOW});else{const i=t.combatants[e].getFlag(game.system.id,"group");this.debounce(t.combatants[e].update({initiative:a[i].initiative}),500)}}await e.setupTurns()},async resetInitiative(e,t){const a=game.settings.get(game.system.id,"rerollInitiative");["reset","reroll"].includes(a)&&e.resetAll()},async individualInitiative(e,t){const a=[],i=[],s=e?.combatants;for(let t=0;t<s.size;t++){const n=s.contents[t];if(n?.initiative&&0===e.round)continue;const l=await n._getInitiativeFormula(n),o=await n.getInitiativeRoll(l);i.push(o);const r={_id:n.id};a.push(r)}const n=PoolTerm.fromRolls(i),l=await Roll.fromTerms([n]),o=await l.toMessage({},{create:!1}),r=l.terms[0].rolls;let d="";for(const[t,i]of r.entries()){const s=game.combats.viewed.combatants.find((e=>e.id===a[t]._id));let n=s.actor?.system?.isSlow?tt.STATUS_SLOW:i.total;e.settings.skipDefeated&&s.isDefeated&&(n=tt.STATUS_DIZZY),a[t].initiative=n;const l=`${F.systemPath()}/templates/chat/roll-individual-initiative.html`,o={name:s.name,formula:i.formula,result:i.result,total:i.total};d+=await renderTemplate(l,o)}o.content=`\n    <details>\n    <summary>${game.i18n.localize("OSE.roll.individualInitGroup")}</summary>\n    ${d}\n    </details>`,ChatMessage.create(o),game.user.isGM&&await e.updateEmbeddedDocuments("Combatant",a),t.turn=0},format(e,t,a){t.find(".initiative").each(((e,t)=>{t.innerHTML=t.innerHTML===`${tt.STATUS_SLOW}`?'<i class="fas fa-weight-hanging"></i>':t.innerHTML,t.innerHTML=t.innerHTML===`${tt.STATUS_DIZZY}`?'<i class="fas fa-dizzy"></i>':t.innerHTML})),t.find(".combatant").each(((t,a)=>{const i=$(a).find(".combatant-controls .combatant-control"),s=e.viewed.combatants.get(a.dataset.combatantId),n=s.getFlag(game.system.id,"moveInCombat"),l=s.getFlag(game.system.id,"prepareSpell"),o=n?"active":"";i.eq(1).after(`<a class='combatant-control move-combat ${o}' title="${game.i18n.localize("OSE.CombatFlag.RetreatFromMeleeDeclared")}"><i class='fas fa-walking'></i></a>`);const r=l?"active":"";i.eq(1).after(`<a class='combatant-control prepare-spell ${r}' title="${game.i18n.localize("OSE.CombatFlag.SpellDeclared")}"><i class='fas fa-magic'></i></a>`)})),tt.announceListener(t);if(!("group"===game.settings.get(game.system.id,"initiative")))return;t.find('.combat-control[data-control="rollNPC"]').remove(),t.find('.combat-control[data-control="rollAll"]').remove();const i=t.find('.encounters .combat-control[data-control="endCombat"]');$('<a class="combat-control" data-control="reroll"><i class="fas fa-dice"></i></a>').insertBefore(i),t.find(".combatant").each(((t,a)=>{$(a).find(".roll").remove();const i=e.viewed.combatants.get(a.dataset.combatantId).getFlag(game.system.id,"group");$(a).find(".combatant-controls").prepend(`<a class='combatant-control flag' style='color:${i}' title="${CONFIG.OSE.colors[i]}"><i class='fas fa-flag'></i></a>`)})),tt.addListeners(t)},updateCombatant(e,t){const a=game.settings.get(game.system.id,"initiative"),i=e.actor?.system;if(i.isSlow)t.initiative=-789;else if(t.initiative&&"group"===a){const a=t.initiative,i=e.getFlag(game.system.id,"group");game.combats.viewed.combatants.forEach((s=>{const n=s.getFlag(game.system.id,"group");s.initiative&&"-789.00"!=s.initiative&&s.id!=t.id&&n===i&&game.user.isGM&&e.update({initiative:parseInt(a)})}))}},announceListener(e){e.find(".combatant-control.prepare-spell").click((e=>{e.preventDefault();const t=$(e.currentTarget).closest(".combatant")[0].dataset.combatantId,a=e.currentTarget.classList.contains("active");game.combat.combatants.get(t).setFlag(game.system.id,"prepareSpell",!a)})),e.find(".combatant-control.move-combat").click((e=>{e.preventDefault();const t=$(e.currentTarget).closest(".combatant")[0].dataset.combatantId,a=e.currentTarget.classList.contains("active"),i=game.combat.combatants.get(t);game.user.isGM&&i.setFlag(game.system.id,"moveInCombat",!a)}))},addListeners(e){e.find(".combatant-control.flag").click((e=>{if(!game.user.isGM)return;const t=e.currentTarget.style.color,a=Object.keys(CONFIG.OSE.colors);let i=a.indexOf(t);i+1===a.length?i=0:i++;const s=$(e.currentTarget).closest(".combatant")[0].dataset.combatantId,n=game.combat.combatants.get(s);game.user.isGM&&n.setFlag(game.system.id,"group",a[i])})),e.find('.combat-control[data-control="reroll"]').click((e=>{if(!game.combat)return;const t={};tt.rollInitiative(game.combat,t),game.user.isGM&&game.combat.update({data:t}).then((()=>{game.combat.setupTurns()}))}))},addCombatant(e,t,a,i){const s=canvas.tokens.get(t.tokenId);let n="black";switch(s?.disposition||s?.data?.disposition){case-1:n="red";break;case 0:n="yellow";break;case 1:n="green"}t.flags={ose:{group:n}},e.updateSource({flags:{ose:{group:n}}})},activateCombatant(e){const t=game.combat.turns.findIndex((t=>t.id===e.data("combatant-id")));game.user.isGM&&game.combat.update({turn:t})},addContextEntry(e,t){t.unshift({name:"Set Active",icon:'<i class="fas fa-star-of-life"></i>',callback:tt.activateCombatant})},async preUpdateCombat(e,t,a,i){const s=game.settings.get(game.system.id,"initiative"),n=game.settings.get(game.system.id,"rerollInitiative");if(t.round){if(1!==t.round){if("reset"===n)return void tt.resetInitiative(e,t,a,i);if("keep"===n)return}"group"===s?tt.rollInitiative(e,t,a,i):"individual"===s&&tt.individualInitiative(e,t,a,i)}}};async function at(e,t){if(t.treasure={},e.getFlag(game.system.id,"treasure"))e.results.forEach((async e=>{if(await(async e=>{const t=new Roll("1d100");return await t.evaluate(),t.total<=e})(e.weight)){const a=e.getChatText(e);if(t.treasure[e.id]={img:e.img,text:TextEditor.enrichHTML(a,{async:!1})},e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT&&"RollTable"===e.collection){const a=game.tables.get(e.resultId);await at(a,t.treasure[e.id])}}}));else{const{results:a}=await e.roll();a.forEach((e=>{t.treasure[e.id]={img:e.img,text:e.text}}))}return t}async function it(e,t={}){const a=await at(e,{}),i={treasure:a.treasure,table:e};if(t.event){$(t.event.currentTarget.parentElement).prev().find(".table-result").each(((e,t)=>{t.classList.remove("active"),a.treasure[t.dataset.resultId]&&t.classList.add("active")}))}const s={content:await renderTemplate(`${F.systemPath()}/templates/chat/roll-treasure.html`,i)},n=game.settings.get("core","rollMode");["gmroll","blindroll"].includes(n)&&(s.whisper=ChatMessage.getWhisperRecipients("GM")),"selfroll"===n&&(s.whisper=[game.user._id]),"blindroll"===n&&(s.blind=!0),ChatMessage.create(s)}const st={drawTreasure:at,rollTreasure:it};async function nt(e,t){if("Macro"===e.type)return game.user.assignHotbarMacro(await fromUuid(e.uuid),t);if("RollTable"===e.type){const a=`game.ose.rollTableMacro("${e.uuid}");`,i=await fromUuid(e.uuid),s=await Macro.create({name:i.name,type:"script",img:i.img,command:a,flags:{"ose.tableMacro":!0}});return game.user.assignHotbarMacro(s,t)}if("Item"!==e.type)return ui.notifications.warn(game.i18n.localize("OSE.warn.macrosNotAnItem"));if(e.uuid.indexOf("Item.")<=0)return ui.notifications.warn(game.i18n.localize("OSE.warn.macrosOnlyForOwnedItems"));const{item:a}=e,i=`game.ose.rollItemMacro("${a.name}");`;let s=game.macros.contents.find((e=>e.name===a.name&&e.command===i));return s&&void 0!==s.ownership[game.userId]||(s=await Macro.create({name:a.name,type:"script",img:a.img,command:i,flags:{"ose.itemMacro":!0}})),game.user.assignHotbarMacro(s,t)}function lt(e){const t=ChatMessage.getSpeaker();if(!t.actor||!t.scene)return ui.notifications.warn(game.i18n.localize("OSE.warn.macrosNoTokenOwnedInScene"));let a;t.token&&(a=game.actors.tokens[t.token]),a||(a=game.actors.get(t.actor));const i=a?a.items.filter((t=>t.name===e)):[];if(i.length>1)ui.notifications.warn(game.i18n.format("OSE.warn.moreThanOneItemWithName",{actorName:a.name,itemName:e}));else if(0===i.length)return ui.notifications.error(game.i18n.format("OSE.error.noItemWithName",{actorName:a.name,itemName:e}));return i[0].roll()}function ot(e){fromUuid(e).then((t=>null===t?ui.notifications.error(game.i18n.format("OSE.error.noRollTableWithUuId",{uuid:e})):t.getFlag(game.system.id,"treasure")?it(t):t.draw({displayChat:!0})))}const rt={get currentParty(){return game.actors.filter((e=>"character"===e.type&&e.flags[game.system.id]&&!0===e.flags[game.system.id].party))}};class dt extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","dialog","party-xp"],template:`${F.systemPath()}/templates/apps/party-xp.html`,width:300,height:"auto",resizable:!1,closeOnSubmit:!0})}get title(){return game.i18n.localize("OSE.dialog.xp.deal")}getData(){return{actors:rt.currentParty,data:this.object,config:CONFIG.OSE,user:game.user,settings:game.settings}}_onDrop(e){let t;e.preventDefault();try{if(t=JSON.parse(e.dataTransfer.getData("text/plain")),"Item"!==t.type)return}catch(e){return!1}}_updateObject(e){this._dealXP(e)}_calculateShare(){const{currentParty:e}=rt,t=$(this.form),a=t.find('input[name="total"]').val(),i=parseFloat(a)/e.length;e.forEach((e=>{const a=e?.system,s=Math.floor(a.details.xp.share/100*i);t.find(`li[data-actor-id='${e.id}'] input`).val(s)}))}_dealXP(){$(this.form).find(".actor").each(((e,t)=>{const a=$(t),i=a.find("input").val(),s=a.data("actorId"),n=rt.currentParty.find((e=>e.id===s));i&&n.getExperience(Math.floor(parseInt(i,10)))}))}activateListeners(e){super.activateListeners(e);e.find('input[name="total"]').on("input",this._calculateShare.bind(this)),e.find('button[data-action="deal-xp"').click((e=>{super.submit(e)}))}}const ut={partySheet:void 0};class ct extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ose","dialog","party-sheet"],template:`${F.systemPath()}/templates/apps/party-sheet.html`,width:280,height:400,resizable:!0,dragDrop:[{dragSelector:".actor-list .actor",dropSelector:".party-members"}],closeOnSubmit:!1})}static init(){ut.partySheet=new ct}static showPartySheet(e={}){ct.partySheet.render(!0,{focus:!0,...e})}static get partySheet(){return ut.partySheet}get title(){return game.i18n.localize("OSE.dialog.partysheet")}getData(){const e={ascending:game.settings.get(game.system.id,"ascendingAC")};return{partyActors:rt.currentParty,config:CONFIG.OSE,user:game.user,settings:e}}async _addActorToParty(e){"character"===e.type&&await e.setFlag(game.system.id,"party",!0)}async _removeActorFromParty(e){await e.setFlag(game.system.id,"party",!1)}_onDrop(e){let t;e.preventDefault();try{switch(t=JSON.parse(e.dataTransfer.getData("text/plain")),t.type){case"Actor":return this._onDropActor(e,t);case"Folder":return this._onDropFolder(e,t)}}catch(e){return!1}}async _onDropActor(e,t){if("Actor"!==t.type)return;game;const a=await fromUuid(t.uuid);this._addActorToParty(a)}_recursiveAddFolder(e){e.contents.forEach((e=>this._addActorToParty(e))),e.children.forEach((e=>this._recursiveAddFolder(e.folder)))}async _onDropFolder(e,t){if("Actor"!==t.documentName)return;const a=await fromUuid(t.uuid);a&&this._recursiveAddFolder(a)}async _onDragStart(e){try{const{uuid:t}=e.currentTarget.dataset,a=(await fromUuid(t)).toDragData();e.dataTransfer.setData("text/plain",JSON.stringify(a))}catch(e){return!1}return!0}async _dealXP(e){new dt(this.object,{}).render(!0)}activateListeners(e){super.activateListeners(e),e.find(".header #deal-xp").click(this._dealXP.bind(this));const t=e=>{const t=e.currentTarget.closest(".actor").dataset.actorId;return game.actors.get(t)};e.find(".field-img button[data-action='open-sheet']").click((e=>{t(e).sheet.render(!0)})),e.find(".field-img button[data-action='remove-actor']").click((async e=>{await this._removeActorFromParty(t(e))}))}}const mt=e=>{null!==e.getFlag(game.system.id,"party")&&ct.partySheet.render()},vt=e=>new Promise((t=>{setTimeout(t,e)})),gt=()=>{var e,t;(null===(e=game.messages)||void 0===e?void 0:e.size)&&(null===(t=game.messages)||void 0===t||t.documentClass.deleteDocuments([],{deleteAll:!0}))},ht=()=>vt(120),yt=e=>Object.values(ui.windows).filter((t=>t.options.classes.includes(e))),pt=()=>Object.values(ui.windows).filter((e=>e.options.classes.includes("dialog"))),ft=()=>e(void 0,void 0,void 0,(function*(){var t;null===(t=pt())||void 0===t||t.forEach((t=>e(void 0,void 0,void 0,(function*(){yield t.close()}))))})),bt=()=>e(void 0,void 0,void 0,(function*(){yt("sheet").forEach((t=>e(void 0,void 0,void 0,(function*(){return t.close()})))),ht()})),wt=(t,a={},i="")=>e(void 0,void 0,void 0,(function*(){return Actor.create(Object.assign(Object.assign({},a),{name:`Test Actor ${i}`,type:t}))})),qt=(t,a=`New World Test ${t.capitalize()}`)=>e(void 0,void 0,void 0,(function*(){return Item.create({type:t,name:a})})),St=(t,a,i=`New Actor Test ${a.capitalize()}`,s={})=>e(void 0,void 0,void 0,(function*(){return null==t?void 0:t.createEmbeddedDocuments("Item",[Object.assign({type:a,name:i},s)])})),Ot=()=>e(void 0,void 0,void 0,(function*(){return Macro.create({name:`Mock Macro ${foundry.utils.randomID()}`,type:"script",command:"console.log('Testing Macro');"})})),kt=()=>e(void 0,void 0,void 0,(function*(){return Scene.create({name:"Mock Scene",tokenVision:!0})})),Et=t=>e(void 0,void 0,void 0,(function*(){var e;return null===(e=game.actors)||void 0===e?void 0:e.getName(`Test Actor ${t}`)})),Tt=()=>e(void 0,void 0,void 0,(function*(){var t;const a=null===(t=game.macros)||void 0===t?void 0:t.filter((e=>{var t;return null===(t=e.name)||void 0===t?void 0:t.includes("Mock Macro")}));return null==a||a.forEach((t=>e(void 0,void 0,void 0,(function*(){return yield t.delete()})))),!0})),It=t=>e(void 0,void 0,void 0,(function*(){var a;null===(a=game.actors)||void 0===a||a.filter((e=>e.name===`Test Actor ${t}`)).forEach((t=>e(void 0,void 0,void 0,(function*(){return yield t.delete()}))))})),Ct=()=>e(void 0,void 0,void 0,(function*(){var t;null===(t=game.items)||void 0===t||t.filter((e=>{var t;return null===(t=null==e?void 0:e.name)||void 0===t?void 0:t.includes("New World Test")})).forEach((t=>e(void 0,void 0,void 0,(function*(){return yield t.delete()}))))})),At=()=>e(void 0,void 0,void 0,(function*(){var t;null===(t=game.scenes)||void 0===t||t.filter((e=>"Mock Scene"===e.name)).forEach((t=>e(void 0,void 0,void 0,(function*(){return yield t.delete()}))))})),Dt=new Set(["spell","ability","armor","weapon","item","container"]),Mt="ose.actor.datamodel.character",Ft={displayName:"OSE: Actor: Data Model: Character"},$t=()=>wt("character",{},Mt);var _t=({describe:t,it:a,expect:i,after:s,before:n})=>{const l=new xe,o=game.settings.get(game.system.id,"ascendingAC"),r=game.settings.get(game.system.id,"initiative"),d=game.settings.get(game.system.id,"encumbranceOption");s((()=>{game.settings.set(game.system.id,"ascendingAC",o),game.settings.set(game.system.id,"initiative",r),game.settings.set(game.system.id,"encumbranceOption",d),It(Mt)})),t("prepareDerivedData()",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"encumbranceOption","detailed"),yield $t()})))),a("has scores",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system.scores).not.undefined,i(null==e?void 0:e.system.scores.str).not.undefined,i(null==e?void 0:e.system.scores.str.od).not.undefined,i(null==e?void 0:e.system.scores.int).not.undefined,i(null==e?void 0:e.system.scores.int.literacy).not.undefined,i(null==e?void 0:e.system.scores.int.spoken).not.undefined,i(null==e?void 0:e.system.scores.wis).not.undefined,i(null==e?void 0:e.system.scores.dex).not.undefined,i(null==e?void 0:e.system.scores.dex.init).not.undefined,i(null==e?void 0:e.system.scores.con).not.undefined,i(null==e?void 0:e.system.scores.cha).not.undefined,i(null==e?void 0:e.system.scores.cha.loyalty).not.undefined,i(null==e?void 0:e.system.scores.cha.retain).not.undefined,i(null==e?void 0:e.system.scores.cha.npc).not.undefined})))),a("has encumbrance",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system.encumbrance).not.undefined,i(null==e?void 0:e.system.encumbrance.variant).not.undefined,i(null==e?void 0:e.system.encumbrance.enabled).not.undefined,i(null==e?void 0:e.system.encumbrance.pct).not.undefined,i(null==e?void 0:e.system.encumbrance.encumbered).not.undefined,i(null==e?void 0:e.system.encumbrance.steps).not.undefined,i(null==e?void 0:e.system.encumbrance.value).not.undefined,i(null==e?void 0:e.system.encumbrance.max).not.undefined,i(null==e?void 0:e.system.encumbrance.steps).not.undefined})))),a("has movement",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system.movement).not.undefined,i(null==e?void 0:e.system.movement.base).not.undefined,i(null==e?void 0:e.system.movement.encounter).not.undefined,i(null==e?void 0:e.system.movement.overland).not.undefined})))),a("has ac",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system.ac).not.undefined,i(null==e?void 0:e.system.ac.base).not.undefined,i(null==e?void 0:e.system.ac.naked).not.undefined,i(null==e?void 0:e.system.ac.shield).not.undefined,i(null==e?void 0:e.system.ac.value).not.undefined,i(null==e?void 0:e.system.ac.mod).not.undefined})))),a("has aac",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system.aac).not.undefined,i(null==e?void 0:e.system.aac.base).not.undefined,i(null==e?void 0:e.system.aac.naked).not.undefined,i(null==e?void 0:e.system.aac.shield).not.undefined,i(null==e?void 0:e.system.aac.value).not.undefined,i(null==e?void 0:e.system.aac.mod).not.undefined})))),t("has spells",(()=>{const t=new Set(["1","2","3","4","5","6"]);a("has spells",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system.spells).not.undefined,i(null==e?void 0:e.system.spells.enabled).not.undefined,i(null==e?void 0:e.system.spells.spellList).not.undefined,i(null==e?void 0:e.system.spells.slots).not.undefined})))),t.forEach((t=>{a(`has spell level ${t}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system.spells.slots[t]).not.undefined,i(Object.keys(null==e?void 0:e.system.spells.slots[t])).contain("used"),i(Object.keys(null==e?void 0:e.system.spells.slots[t])).contain("max")}))))}))})),s((()=>{It(Mt)}))})),t("defineSchema()",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield $t()}))));["config","initiative","thac0","languages"].forEach((t=>{a(`has ${t}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system[t]).not.undefined}))))}));[{field:"hp",subFields:["hd","value","max"]},{field:"exploration",subFields:["ft","ld","od","sd"]},{field:"retainer",subFields:["enabled","loyalty","wage"]}].forEach((({field:t,subFields:s})=>{s.forEach((s=>{a(`${t} field has ${s} subfield`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system[t]).not.undefined,i(null==e?void 0:e.system[t][s]).not.undefined}))))}))}));[{field:"saves",subFields:[{subField:"breath",subSubField:["value"]},{subField:"death",subSubField:["value"]},{subField:"paralysis",subSubField:["value"]},{subField:"spell",subSubField:["value"]},{subField:"wand",subSubField:["value"]}]}].forEach((({field:t,subFields:s})=>{s.forEach((({subField:s,subSubField:n})=>{a(`${t} field has ${s} subfield, which has ${n} field`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Mt);i(null==e?void 0:e.system[t]).not.undefined,i(null==e?void 0:e.system[t][s]).not.undefined,i(null==e?void 0:e.system[t][s][n]).not.undefined}))))}))})),s((()=>{It(Mt)}))})),t("usesAscendingAC()",(()=>{a("successfully reads from settings",(()=>{i(l.usesAscendingAC).equal(game.settings.get(game.system.id,"ascendingAC"))}))})),t("meleeMod()",(()=>{t("ascendingAC on",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!0)})))),a("without scores, return 0 if bba undefined",(()=>{i(l.meleeMod).equal(0)})),a("without scores, return thac0.bba when bba defined",(()=>{l.thac0.bba=12,i(l.meleeMod).equal(12),l.thac0.bba=0,i(l.thac0.bba).equal(0)}))})),t("ascendingAC off",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!1)})))),a("without scores, return 0",(()=>e(void 0,void 0,void 0,(function*(){i(l.meleeMod).equal(0)}))))})),a("adds str modifier",(()=>{l.scores.str={mod:10},i(l.meleeMod).equal(10),l.scores.str.mod=0,i(l.scores.str.mod).equal(0)})),a("adds thac0 melee modifier",(()=>{l.thac0.mod={melee:5},i(l.meleeMod).equal(5),l.thac0.mod.melee=0,i(l.thac0.mod.melee).equal(0)}))})),t("rangedMod()",(()=>{t("ascendingAC on",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!0)})))),a("without scores, return 0 if bba undefined",(()=>{i(l.rangedMod).equal(0)})),a("without scores, return thac0.bba when bba defined",(()=>{l.thac0.bba=12,i(l.rangedMod).equal(12),l.thac0.bba=0,i(l.thac0.bba).equal(0)}))})),t("ascendingAC off",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!1)})))),a("without scores, return 0",(()=>e(void 0,void 0,void 0,(function*(){i(l.rangedMod).equal(0)}))))})),a("adds dex modifier",(()=>{l.scores.dex={mod:10},i(l.rangedMod).equal(10),l.scores.dex.mod=0,i(l.scores.dex.mod).equal(0)})),a("adds thac0 missile modifier",(()=>{l.thac0.mod={missile:5},i(l.rangedMod).equal(5),l.thac0.mod.missile=0,i(l.thac0.mod.missile).equal(0)}))})),t("isNew()",(()=>{a("New when all ability scores are at 0",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("character",{system:{scores:{str:{value:0},int:{value:0},wis:{value:0},dex:{value:0},con:{value:0},cha:{value:0}}}},Mt);i(null==e?void 0:e.system.isNew).to.be.true})))),a("Not new when any ability score is above 0",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("character",{system:{scores:{str:{value:10},int:{value:0},wis:{value:0},dex:{value:0},con:{value:0},cha:{value:0}}}},Mt);i(null==e?void 0:e.system.isNew).to.be.false})))),a("New when all saves are at 0",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("monster",{system:{saves:{breath:{value:0},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Mt);i(null==e?void 0:e.system.isNew).to.be.true})))),a("Not new when any save is above 0",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("monster",{system:{saves:{breath:{value:10},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Mt);i(null==e?void 0:e.system.isNew).to.be.false}))))})),t("containers()",(()=>{a("returns all containers",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.containers.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test container");const t=null==e?void 0:e.items.contents[0].id;i(null==e?void 0:e.system.containers.length).equal(1),i(null==e?void 0:e.system.containers[0]._id).equal(t),null==e||e.delete()})))),s((()=>{It(Mt)}))})),t("treasures()",(()=>{a("returns treasures on actor",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.treasures.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test treasure"),i(null==e?void 0:e.items.contents[0].system.treasure).is.true;const t=null==e?void 0:e.items.contents[0].id;i(null==e?void 0:e.system.treasures.length).equal(1),i(null==e?void 0:e.system.treasures[0]._id).equal(t),null==e||e.delete()})))),a("doesn't returns treasures on actor if in container",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.treasures.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]);const t=null==e?void 0:e.items.getName("test container");yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,containerId:null==t?void 0:t.id}}]),i(null==e?void 0:e.items.contents.length).equal(2),i(null==e?void 0:e.items.contents[0].name).equal("test container"),i(null==e?void 0:e.items.contents[1].name).equal("test treasure"),i(null==e?void 0:e.items.contents[1].system.treasure).is.true,i(null==e?void 0:e.items.contents[1].system.containerId).equal(null==t?void 0:t.id),i(null==e?void 0:e.system.treasures.length).equal(0),null==e||e.delete()})))),s((()=>{It(Mt)}))})),t("carriedTreasure()",(()=>{a("return treasure value on actor",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.carriedTreasure).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:1},cost:10}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test treasure"),i(null==e?void 0:e.items.contents[0].system.treasure).is.true,i(null==e?void 0:e.system.carriedTreasure).equal(10),null==e||e.delete()})))),a("return multiple treasure value on actor",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.carriedTreasure).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:1},cost:10}},{type:"item",name:"test treasure 2",system:{treasure:!0,quantity:{value:3},cost:4}}]),i(null==e?void 0:e.items.contents.length).equal(2),i(null==e?void 0:e.items.contents[0].name).equal("test treasure"),i(null==e?void 0:e.items.contents[0].system.treasure).is.true,i(null==e?void 0:e.items.contents[1].name).equal("test treasure 2"),i(null==e?void 0:e.items.contents[1].system.treasure).is.true,i(null==e?void 0:e.system.carriedTreasure).equal(22),null==e||e.delete()})))),a("doesn't returns treasure value on actor if in container",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.carriedTreasure).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]);const t=null==e?void 0:e.items.getName("test container");yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,containerId:null==t?void 0:t.id,quantity:{value:1},cost:10}}]),i(null==e?void 0:e.items.contents.length).equal(2),i(null==e?void 0:e.items.contents[0].name).equal("test container"),i(null==e?void 0:e.items.contents[1].name).equal("test treasure"),i(null==e?void 0:e.items.contents[1].system.treasure).is.true,i(null==e?void 0:e.items.contents[1].system.containerId).equal(null==t?void 0:t.id),i(null==e?void 0:e.system.carriedTreasure).equal(0),null==e||e.delete()})))),s((()=>{It(Mt)}))})),t("items()",(()=>{a("only returns other items than treasure",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.items.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test item"},{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:3},cost:4}}]),i(null==e?void 0:e.items.contents.length).equal(2),i(null==e?void 0:e.items.contents[0].name).equal("test item"),i(null==e?void 0:e.items.contents[1].name).equal("test treasure"),i(null==e?void 0:e.items.contents[1].system.treasure).is.true,i(null==e?void 0:e.system.items.length).equal(1),i(null==e?void 0:e.system.items[0].name).equal("test item"),null==e||e.delete()})))),a("only returns other items than stored in containers",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.items.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]);const t=null==e?void 0:e.items.getName("test container");yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test item in container",system:{containerId:null==t?void 0:t.id}},{type:"item",name:"test item"}]),i(null==e?void 0:e.items.contents.length).equal(3),i(null==e?void 0:e.items.contents[0].name).equal("test container"),i(null==e?void 0:e.items.contents[1].name).equal("test item in container"),i(null==e?void 0:e.items.contents[2].name).equal("test item"),i(null==e?void 0:e.system.items.length).equal(1),i(null==e?void 0:e.system.items[0].name).equal("test item"),null==e||e.delete()}))))}));[{type:"weapon",getter:"weapons"},{type:"ability",getter:"abilities"},{type:"armor",getter:"armor"},{type:"spell",getter:"#spellList"}].forEach((({type:n,getter:l})=>{t(`${l}()`,(()=>{a(`returns all ${l}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system[l].length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:n,name:`test ${n}`}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal(`test ${n}`);const t=null==e?void 0:e.items.contents[0].id;i(null==e?void 0:e.system[l].length).equal(1),i(null==e?void 0:e.system[l][0]._id).equal(t),null==e||e.delete()})))),a(`returns all ${l} except ones in container`,(()=>e(void 0,void 0,void 0,(function*(){if("abilities"===l)return;const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system[l].length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]);const t=null==e?void 0:e.items.getName("test container");yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:n,name:`test ${n} in container`,system:{containerId:null==t?void 0:t.id}},{type:n,name:`test ${n}`}]),i(null==e?void 0:e.items.contents.length).equal(3),i(null==e?void 0:e.items.contents[0].name).equal("test container"),i(null==e?void 0:e.items.contents[1].name).equal(`test ${n} in container`),i(null==e?void 0:e.items.contents[2].name).equal(`test ${n}`);const a=null==e?void 0:e.items.contents[2].id;i(null==e?void 0:e.system[l].length).equal(1),i(null==e?void 0:e.system[l][0]._id).equal(a),null==e||e.delete()})))),s((()=>{It(Mt)}))}))})),t("isSlow()",(()=>{a("returns false if no weapons",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.system.isSlow).is.false,null==e||e.delete()})))),a("returns false if weapon that has slow tag and not equipped",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!0,equipped:!1}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test weapon"),i(null==e?void 0:e.system.isSlow).is.false,null==e||e.delete()})))),a("returns false if weapon that doesn't have slow tag and not equipped",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!1,equipped:!0}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test weapon"),i(null==e?void 0:e.system.isSlow).is.false,null==e||e.delete()})))),a("returns true if weapon that has slow tag and is equipped",(()=>e(void 0,void 0,void 0,(function*(){const e=yield $t();i(null==e?void 0:e.items.contents.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!0,equipped:!0}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test weapon"),i(null==e?void 0:e.system.isSlow).is.true,null==e||e.delete()})))),s((()=>{It(Mt)}))})),t("init()",(()=>{t("group inititative",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"initiative","group")})))),a("returns 0",(()=>{i(l.init).equal(0)})),a("returns 0 with initiative value set",(()=>e(void 0,void 0,void 0,(function*(){l.initiative.value=12,i(l.init).equal(0),l.initiative.value=0,i(l.initiative.value).equal(0)})))),a("returns 0 with initiative mod set",(()=>e(void 0,void 0,void 0,(function*(){l.initiative.mod=10,i(l.init).equal(0),l.initiative.mod=0,i(l.initiative.mod).equal(0)})))),a("returns 0 with dex mod init set",(()=>e(void 0,void 0,void 0,(function*(){l.dex={mod:{init:5}},i(l.init).equal(0),l.dex.mod.init=0,i(l.dex.mod.init).equal(0)}))))})),t("individual inititative",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"initiative","individual")})))),a("returns 0 by default",(()=>{i(l.initiative.value).equal(0),i(l.initiative.mod).equal(0),i(l.scores.dex.init).equal(0),i(l.init).equal(0)})),a("returns correctly with initiative value set",(()=>e(void 0,void 0,void 0,(function*(){l.initiative.value=12,i(l.init).equal(12),l.initiative.value=0,i(l.initiative.value).equal(0)})))),a("returns correctly with initiative mod set",(()=>e(void 0,void 0,void 0,(function*(){l.initiative.mod=10,i(l.init).equal(10),l.initiative.mod=0,i(l.initiative.mod).equal(0)})))),a("returns correctly with dex mod init set",(()=>e(void 0,void 0,void 0,(function*(){l.scores.dex={init:5},i(l.init).equal(5),l.scores.dex.init=0,i(l.scores.dex.init).equal(0)}))))}))}))};const Nt={displayName:"OSE: Actor: Data Model: Character AC"};var xt=({describe:e,it:t,expect:a})=>{const i=new Item.implementation({name:"Armor",type:"armor",system:{ac:{value:4},aac:{value:4},type:"light",equipped:!0}}),s=new Item.implementation({name:"Shield",type:"armor",system:{ac:{value:2},aac:{value:2},type:"shield",equipped:!0}}),n=[i],l=[s],o=[i,s],r=-1,d=-4;e("Naked AC values",(()=>{e("Returns the default base AC",(()=>{t("When ascending",(()=>{const e=new Me(!0);a(e.value).to.equal(Me.baseAscending)})),t("When descending",(()=>{const e=new Me;a(e.value).to.equal(Me.baseDescending)}))}))})),e("Armored AC values",(()=>{e("Returns the expected AC, provided equipment",(()=>{e("With armor",(()=>{t("When ascending",(()=>{const e=new Me(!0,n);a(e.value).to.equal(4)})),t("When descending",(()=>{const e=new Me(!1,n);a(e.value).to.equal(4)}))})),e("With shield",(()=>{t("When ascending",(()=>{const e=new Me(!0,l);a(e.value).to.equal(Me.baseAscending+2)})),t("When descending",(()=>{const e=new Me(!1,l);a(e.value).to.equal(Me.baseDescending-2)}))})),e("With armor and shield",(()=>{t("When ascending",(()=>{const e=new Me(!0,o);a(e.value).to.equal(6)})),t("When descending",(()=>{const e=new Me(!1,o);a(e.value).to.equal(2)}))}))}))})),e("With a dexterity modifier",(()=>{e("Positive modifier",(()=>{e("When ascending",(()=>{const e=Me.baseAscending;t("Unarmored, no shield",(()=>{const t=new Me(!0,[],3);a(t.value).to.equal(e+3)})),t("Armored, no shield",(()=>{const e=new Me(!0,n,3);a(e.value).to.equal(7)})),t("Unarmored, shield",(()=>{const t=new Me(!0,l,3);a(t.value).to.equal(e+2+3)})),t("Armored, shield",(()=>{const e=new Me(!0,o,3);a(e.value).to.equal(9)}))})),e("When descending",(()=>{const e=Me.baseDescending;t("Unarmored, no shield",(()=>{const t=new Me(!1,[],3);a(t.value).to.equal(e-3)})),t("Armored, no shield",(()=>{const e=new Me(!1,n,3);a(e.value).to.equal(1)})),t("Unarmored, shield",(()=>{const t=new Me(!1,l,3);a(t.value).to.equal(e-2-3)})),t("Armored, shield",(()=>{const e=new Me(!1,o,3);a(e.value).to.equal(-1)}))}))})),e("Negative modifier",(()=>{e("When ascending",(()=>{const e=Me.baseAscending;t("Unarmored, no shield",(()=>{const t=new Me(!0,[],r);a(t.value).to.equal(e+r)})),t("Armored, no shield",(()=>{const e=new Me(!0,n,r);a(e.value).to.equal(3)})),t("Unarmored, shield",(()=>{const t=new Me(!0,l,r);a(t.value).to.equal(e+2+r)})),t("Armored, shield",(()=>{const e=new Me(!0,o,r);a(e.value).to.equal(5)}))})),e("When descending",(()=>{const e=Me.baseDescending;t("Unarmored, no shield",(()=>{const t=new Me(!1,[],r);a(t.value).to.equal(e-r)})),t("Armored, no shield",(()=>{const e=new Me(!1,n,r);a(e.value).to.equal(5)})),t("Unarmored, shield",(()=>{const t=new Me(!1,l,r);a(t.value).to.equal(e-2-r)})),t("Armored, shield",(()=>{const e=new Me(!1,o,r);a(e.value).to.equal(3)}))}))}))})),e("With an arbitrary modifier",(()=>{e("Positive modifier",(()=>{e("When ascending",(()=>{const e=Me.baseAscending;t("Unarmored, no shield",(()=>{const t=new Me(!0,[],0,2);a(t.value).to.equal(e+2)})),t("Armored, no shield",(()=>{const e=new Me(!0,n,0,2);a(e.value).to.equal(6)})),t("Unarmored, shield",(()=>{const t=new Me(!0,l,0,2);a(t.value).to.equal(e+2+2)})),t("Armored, shield",(()=>{const e=new Me(!0,o,0,2);a(e.value).to.equal(8)}))})),e("When descending",(()=>{const e=Me.baseDescending;t("Unarmored, no shield",(()=>{const t=new Me(!1,[],0,2);a(t.value).to.equal(e-2)})),t("Armored, no shield",(()=>{const e=new Me(!1,n,0,2);a(e.value).to.equal(2)})),t("Unarmored, shield",(()=>{const t=new Me(!1,l,0,2);a(t.value).to.equal(e-2-2)})),t("Armored, shield",(()=>{const e=new Me(!1,o,0,2);a(e.value).to.equal(0)}))}))})),e("Negative modifier",(()=>{e("When ascending",(()=>{const e=Me.baseAscending;t("Unarmored, no shield",(()=>{const t=new Me(!0,[],0,d);a(t.value).to.equal(e+d)})),t("Armored, no shield",(()=>{const e=new Me(!0,n,0,d);a(e.value).to.equal(0)})),t("Unarmored, shield",(()=>{const t=new Me(!0,l,0,d);a(t.value).to.equal(e+2+d)})),t("Armored, shield",(()=>{const e=new Me(!0,o,0,d);a(e.value).to.equal(2)}))})),e("When descending",(()=>{const e=Me.baseDescending;t("Unarmored, no shield",(()=>{const t=new Me(!1,[],0,d);a(t.value).to.equal(e-d)})),t("Armored, no shield",(()=>{const e=new Me(!1,n,0,d);a(e.value).to.equal(8)})),t("Unarmored, shield",(()=>{const t=new Me(!1,l,0,d);a(t.value).to.equal(e-2-d)})),t("Armored, shield",(()=>{const e=new Me(!1,o,0,d);a(e.value).to.equal(6)}))}))}))}))};const jt={displayName:"OSE: Actor: Data Model: Character Encumbrance"},Rt=(e,t)=>Math.clamp(100*e/t,0,100),zt=(e,t,a,i={})=>new Item.implementation({name:`Mock ${e} ${foundry.utils.randomID()}`,type:e,system:Object.assign(Object.assign({},i),{weight:t,quantity:{value:a}})});var Pt=({describe:e,it:t,expect:a})=>{e("Disabled Encumbrance",(()=>{t("Is disabled",(()=>{let e=new T;a(e.enabled).to.be.false,e=new D,a(e.enabled).to.be.false}))})),e("Basic Encumbrance",(()=>{t("Is enabled",(()=>{const e=new I;a(e.enabled).to.be.true})),t("Returns the appropriate encumbrance steps",(()=>{const e=new I,t=[100*game.settings.get(game.system.id,"significantTreasure")/e.max];a(e.steps).to.have.members(t)})),e("Returns current carried weight",(()=>{t("As Percentage",(()=>{const e=1600;let t=new I(e,[zt("item",400,1,{treasure:!0})]);a(t.pct).to.equal(Rt(400,e)),t=new I(e,[zt("item",800,1,{treasure:!0})]),a(t.pct).to.equal(Rt(800,e)),t=new I(e,[zt("item",1200,1,{treasure:!0})]),a(t.pct).to.equal(Rt(1200,e)),t=new I(e,[zt("item",e,1,{treasure:!0})]),a(t.pct).to.equal(100),t=new I(e,[zt("item",e,1,{treasure:!1})]),a(t.pct).to.equal(0)})),t("As Value",(()=>{const e=1600;let t=new I(e,[zt("item",400,1,{treasure:!0})]);a(t.value).to.equal(400),t=new I(e,[zt("item",800,1,{treasure:!0})]),a(t.value).to.equal(800),t=new I(e,[zt("item",1200,1,{treasure:!0})]),a(t.value).to.equal(1200),t=new I(e,[zt("item",e,1,{treasure:!0})]),a(t.value).to.equal(e),t=new I(e,[zt("item",e,1,{treasure:!1})]),a(t.value).to.equal(0)})),e("As fully encumbered flag",(()=>{t("Encumbered over full load (1600.1)",(()=>{const e=new I(1600,[zt("item",1600.1,1,{treasure:!0})]);a(e.encumbered).to.be.true})),e("Not encumbered",(()=>{t("from non-treasure items",(()=>{const e=new I(1600,[zt("weapon",1600.1,1),zt("armor",1600.1,1),zt("container",1600.1,1),zt("item",1600.1,1)]);a(e.encumbered).to.be.false})),t("from a partial load",(()=>{const e=new I(1600,[zt("item",400,1,{treasure:!0})]);a(e.encumbered).to.be.false}))}))})),t('As "over significant treasure threshold" flag',(()=>{let e=new I(1600,[zt("item",400,1,{treasure:!0})]);a(e.overSignificantTreasureThreshold).to.be.false,e=new I(1600,[zt("item",800,1,{treasure:!0})]),a(e.overSignificantTreasureThreshold).to.be.true,e=new I(1600,[zt("weapon",800,1)]),a(e.overSignificantTreasureThreshold).to.be.false}))})),t("Returns max carry weight",(()=>{let e=new I(2e3);a(e.max).to.equal(2e3),e=new I,a(e.max).to.equal(T.baseEncumbranceCap)}))})),e("Detailed Encumbrance",(()=>{t("Is enabled",(()=>{const e=new A;a(e.enabled).to.be.true})),t("Returns the appropriate encumbrance steps",(()=>{const e=new A;a(e.steps).to.have.members(Object.values(T.encumbranceSteps))})),e("Returns current carried weight",(()=>{t("As Percentage",(()=>{const e=1600;let t=new A(e,[zt("item",400,1,{treasure:!0})]);a(t.pct).to.equal(Rt(400,e)),t=new A(e,[zt("item",800,1,{treasure:!0})]),a(t.pct).to.equal(Rt(800,e)),t=new A(e,[zt("item",1200,1,{treasure:!0})]),a(t.pct).to.equal(Rt(1200,e)),t=new A(e,[zt("item",e,1,{treasure:!0})]),a(t.pct).to.equal(100),t=new A(e,[zt("item",e,1,{treasure:!1})]),a(t.pct).to.equal(Rt(A.gearWeight,e))})),t("As Value",(()=>{const e=1600;let t=new A(e,[zt("item",400,1,{treasure:!0})]);a(t.value).to.equal(400),t=new A(e,[zt("item",800,1,{treasure:!0})]),a(t.value).to.equal(800),t=new A(e,[zt("item",1200,1,{treasure:!0})]),a(t.value).to.equal(1200),t=new A(e,[zt("item",e,1,{treasure:!0})]),a(t.value).to.equal(e),t=new A(e,[zt("item",e,1,{treasure:!1})]),a(t.value).to.equal(A.gearWeight)})),e("As fully encumbered flag",(()=>{t("Encumbered over full load (1600.1)",(()=>{const e=new A(1600,[zt("item",1600.1,1,{treasure:!0})]);a(e.encumbered).to.be.true})),e("Not encumbered",(()=>{t("from non-treasure items",(()=>{const e=new A(1600,[zt("item",1600.1,1)]);a(e.encumbered).to.be.false,a(e.value).to.equal(80)})),t("from a partial load",(()=>{const e=new A(1600,[zt("item",400,1,{treasure:!0})]);a(e.encumbered).to.be.false}))}))}))})),t("Returns max carry weight",(()=>{let e=new A(2e3);a(e.max).to.equal(2e3),e=new A,a(e.max).to.equal(T.baseEncumbranceCap)}))})),e("Complete Encumbrance",(()=>{t("Is enabled",(()=>{const e=new C;a(e.enabled).to.be.true})),t("Returns the appropriate encumbrance steps",(()=>{const e=new C;a(e.steps).to.have.members(Object.values(T.encumbranceSteps))})),e("Returns current carried weight",(()=>{t("As Percentage",(()=>{const e=1600;let t=new C(e,[zt("item",400,1,{treasure:!0})]);a(t.pct).to.equal(Rt(400,e)),t=new C(e,[zt("item",800,1,{treasure:!0})]),a(t.pct).to.equal(Rt(800,e)),t=new C(e,[zt("item",1200,1,{treasure:!0})]),a(t.pct).to.equal(Rt(1200,e)),t=new C(e,[zt("item",e,1,{treasure:!0})]),a(t.pct).to.equal(100),t=new C(e,[zt("item",e,1,{treasure:!1})]),a(t.pct).to.equal(100)})),t("As Value",(()=>{const e=1600;let t=new C(e,[zt("item",400,1,{treasure:!0})]);a(t.value).to.equal(400),t=new C(e,[zt("item",800,1,{treasure:!0})]),a(t.value).to.equal(800),t=new C(e,[zt("item",1200,1,{treasure:!0})]),a(t.value).to.equal(1200),t=new C(e,[zt("item",e,1,{treasure:!0})]),a(t.value).to.equal(e),t=new C(e,[zt("item",e,1,{treasure:!1})]),a(t.value).to.equal(e)})),e("As fully encumbered flag",(()=>{t("Encumbered over full load (1600.1)",(()=>{let e=new C(1600,[zt("item",1600.1,1,{treasure:!0})]);a(e.encumbered).to.be.true,e=new C(1600,[zt("item",1600.1,1,{treasure:!1})]),a(e.encumbered).to.be.true})),e("Not encumbered",(()=>{t("from a partial load",(()=>{const e=new C(1600,[zt("item",400,1,{treasure:!0})]);a(e.encumbered).to.be.false})),t("from a full load",(()=>{let e=new C(1600,[zt("item",1600,1,{treasure:!0})]);a(e.encumbered).to.be.false,e=new C(1600,[zt("item",1600,1,{treasure:!1})]),console.info(e),a(e.encumbered).to.be.false}))}))}))})),t("Returns max carry weight",(()=>{let e=new C(2e3);a(e.max).to.equal(2e3),e=new C,a(e.max).to.equal(T.baseEncumbranceCap)}))})),e("Item-based Encumbrance",(()=>{t("Is enabled",(()=>{const e=new M;a(e.enabled).to.be.true})),t("Returns the appropriate encumbrance steps",(()=>{const e=new M;a(e.steps).to.have.members(Object.values(T.encumbranceSteps))})),e("Returns current carried weight",(()=>{t("As Percentage",(()=>{const e=1600;let t=new M(e,[zt("item",400,1,{treasure:!0})]);a(t.pct).to.equal(Rt(400,e)),t=new M(e,[zt("item",800,1,{treasure:!0})]),a(t.pct).to.equal(Rt(800,e)),t=new M(e,[zt("item",1200,1,{treasure:!0})]),a(t.pct).to.equal(Rt(1200,e)),t=new M(e,[zt("item",e,1,{treasure:!0})]),a(t.pct).to.equal(100),t=new M(e,[zt("item",e,1,{treasure:!1})]),a(t.pct).to.equal(100)})),t("As Value",(()=>{const e=1600;let t=new M(e,[zt("item",400,1,{treasure:!0})]);a(t.value).to.equal(400),t=new M(e,[zt("item",800,1,{treasure:!0})]),a(t.value).to.equal(800),t=new M(e,[zt("item",1200,1,{treasure:!0})]),a(t.value).to.equal(1200),t=new M(e,[zt("item",e,1,{treasure:!0})]),a(t.value).to.equal(e),t=new M(e,[zt("item",e,1,{treasure:!1})]),a(t.value).to.equal(e)})),e("As fully encumbered flag",(()=>{t("Encumbered over full load (1600.1)",(()=>{let e=new M(1600,[zt("item",1600.1,1,{treasure:!0})]);a(e.encumbered).to.be.true,e=new M(1600,[zt("item",1600.1,1,{treasure:!1})]),a(e.encumbered).to.be.true})),e("Not encumbered",(()=>{t("from a partial load",(()=>{const e=new M(1600,[zt("item",400,1,{treasure:!0})]);a(e.encumbered).to.be.false})),t("from a full load",(()=>{let e=new M(1600,[zt("item",1600,1,{treasure:!0})]);a(e.encumbered).to.be.false,e=new M(1600,[zt("item",1600,1,{treasure:!1})]),console.info(e),a(e.encumbered).to.be.false}))}))}))})),t("Returns max carry weight",(()=>{let e=new M(2e3);a(e.max).to.equal(2e3),e=new M,a(e.max).to.equal(T.baseEncumbranceCap)}))}))};const Ht={displayName:"OSE: Actor: Data Model: Character Movement"},Gt=(e,t,a,i={})=>new Item.implementation({name:`Mock ${e} ${foundry.utils.randomID()}`,type:e,system:Object.assign(Object.assign({},i),{weight:t,quantity:{value:a}})});var Lt=({describe:e,it:t,expect:a})=>{e("Prevent autocalculation when...",(()=>{t("Autocalculation is off",(()=>{const e=new I,t=new Fe(e,!1);a(t.base).to.equal(Fe.baseMoveRate)})),t("Encumbrance is disabled",(()=>{const e=new T("disabled"),t=new Fe(e);a(t.base).to.equal(Fe.baseMoveRate)})),t("Encumbrance is not provided",(()=>{const e=new Fe;a(e.base).to.equal(Fe.baseMoveRate)}))})),e("Correctly calculates from Basic Encumbrance",(()=>{t("While unarmored",(()=>{let e=new I,t=new Fe(e);a(t.base).to.equal(Fe.baseMoveRate),e=new I(void 0,[Gt("armor",100,1,{type:"unarmored",equipped:!0}),Gt("armor",100,1,{type:"light",equipped:!1}),Gt("armor",100,1,{type:"heavy",equipped:!1})]),t=new Fe(e),a(t.base).to.equal(Fe.baseMoveRate),a(t.encounter).to.equal(Fe.baseMoveRate/3),a(t.overland).to.equal(Fe.baseMoveRate/5)})),t("While lightly armored",(()=>{const e=new I(void 0,[Gt("armor",100,1,{type:"unarmored",equipped:!1}),Gt("armor",100,1,{type:"light",equipped:!0}),Gt("armor",100,1,{type:"heavy",equipped:!1})]),t=new Fe(e);a(t.base).to.equal(.75*Fe.baseMoveRate),a(t.encounter).to.equal(.75*Fe.baseMoveRate/3),a(t.overland).to.equal(.75*Fe.baseMoveRate/5)})),t("While heavily armored",(()=>{const e=new I(void 0,[Gt("armor",100,1,{type:"unarmored",equipped:!1}),Gt("armor",100,1,{type:"light",equipped:!1}),Gt("armor",100,1,{type:"heavy",equipped:!0})]),t=new Fe(e);a(t.base).to.equal(.5*Fe.baseMoveRate),a(t.encounter).to.equal(.5*Fe.baseMoveRate/3),a(t.overland).to.equal(.5*Fe.baseMoveRate/5)})),t("While carrying a significant amount of treasure",(()=>{let e=new I(void 0,[Gt("item",I.significantTreasure-1,1,{treasure:!0})]),t=new Fe(e);a(t.base).to.equal(Fe.baseMoveRate),a(t.encounter).to.equal(Fe.baseMoveRate/3),a(t.overland).to.equal(Fe.baseMoveRate/5),e=new I(void 0,[Gt("item",I.significantTreasure,1,{treasure:!0})]),t=new Fe(e),a(t.base).to.equal(Fe.baseMoveRate-30),a(t.encounter).to.equal((Fe.baseMoveRate-30)/3),a(t.overland).to.equal((Fe.baseMoveRate-30)/5)}))})),e("Correctly calculates from Detailed Encumbrance",(()=>{t("At unencumbered",(()=>{const e=Fe.baseMoveRate,t=e/3,i=e/5;let s=new A,n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i),s=new A(void 0,[Gt("item",800,1)]),n=new Fe(s),a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 12.5% encumbered (100% moverate)",(()=>{const e=Fe.baseMoveRate,t=e/3,i=e/5,s=new A(void 0,[Gt("item",.125*T.baseEncumbranceCap,1,{treasure:!0})]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 25% encumbered (100% moverate)",(()=>{const e=Fe.baseMoveRate,t=e/3,i=e/5,s=new A(void 0,[Gt("item",.25*T.baseEncumbranceCap,1,{treasure:!0})]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 25.1% encumbered (75% moverate)",(()=>{const e=.75*Fe.baseMoveRate,t=e/3,i=e/5;let s=new A(void 0,[Gt("item",.251*T.baseEncumbranceCap,1,{treasure:!0})]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 37.5% encumbered (75% moverate)",(()=>{const e=.75*Fe.baseMoveRate,t=e/3,i=e/5;let s=new A(void 0,[Gt("item",.375*T.baseEncumbranceCap,1,{treasure:!0})]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 37.51% encumbered (50% moverate)",(()=>{const e=.5*Fe.baseMoveRate,t=e/3,i=e/5;let s=new A(void 0,[Gt("item",.3751*T.baseEncumbranceCap,1,{treasure:!0})]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 50% encumbered (50% moverate)",(()=>{const e=.5*Fe.baseMoveRate,t=e/3,i=e/5;let s=new A(void 0,[Gt("item",.5*T.baseEncumbranceCap,1,{treasure:!0})]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 50.1% encumbered (25% moverate)",(()=>{const e=.25*Fe.baseMoveRate,t=e/3,i=e/5;let s=new A(void 0,[Gt("item",.501*T.baseEncumbranceCap,1,{treasure:!0})]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 100% encumbered (25% moverate)",(()=>{const e=.25*Fe.baseMoveRate,t=e/3,i=e/5;let s=new A(void 0,[Gt("item",T.baseEncumbranceCap,1,{treasure:!0})]);const n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 100.1% encumbered (0% moverate)",(()=>{let e=new A(void 0,[Gt("item",T.baseEncumbranceCap,1.001,{treasure:!0})]),t=new Fe(e);a(t.base).to.equal(0),a(t.encounter).to.equal(0),a(t.overland).to.equal(0)}))})),e("Correctly calculates from Complete Encumbrance",(()=>{t("At 0% encumbered (100% moverate)",(()=>{const e=Fe.baseMoveRate,t=e/3,i=e/5,s=new C,n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 12.5% encumbered (100% moverate)",(()=>{const e=Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",.125*T.baseEncumbranceCap,1)]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 25% encumbered (100% moverate)",(()=>{const e=Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",.25*T.baseEncumbranceCap,1)]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 25.1% encumbered (75% moverate)",(()=>{const e=.75*Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",.251*T.baseEncumbranceCap,1)]);const n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 37.5% encumbered (75% moverate)",(()=>{const e=.75*Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",.375*T.baseEncumbranceCap,1)]);const n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 37.51% encumbered (50% moverate)",(()=>{const e=.5*Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",.3751*T.baseEncumbranceCap,1)]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 50% encumbered (50% moverate)",(()=>{const e=.5*Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",.5*T.baseEncumbranceCap,1)]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 50.1% encumbered (25% moverate)",(()=>{const e=.25*Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",.501*T.baseEncumbranceCap,1)]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 100% encumbered (25% moverate)",(()=>{const e=.25*Fe.baseMoveRate,t=e/3,i=e/5;let s=new C(void 0,[Gt("item",T.baseEncumbranceCap,1)]),n=new Fe(s);a(n.base).to.equal(e),a(n.encounter).to.equal(t),a(n.overland).to.equal(i)})),t("At 100.1% encumbered (0% moverate)",(()=>{let e=new C(void 0,[Gt("item",T.baseEncumbranceCap,1.001)]);const t=new Fe(e);a(t.base).to.equal(0),a(t.encounter).to.equal(0),a(t.overland).to.equal(0)}))}))};const Wt={displayName:"OSE: Actor: Data Model: Character Ability Scores"};var Bt=({describe:e,it:t,expect:a})=>{const i=Array.from({length:21},((e,t)=>t)),s=["str","int","wis","dex","con","cha"],n=[$e.standardAttributeMods,$e.cappedAttributeMods,$e.openDoorMods,$e.literacyMods,$e.spokenMods],l=(e,t)=>$e.valueFromTable(n[e],t),o=e=>Object.fromEntries(s.map((t=>[t,{value:e,bonus:0}]))),r=(e,i,s,n)=>{const r=o(e),d=new $e(r);return t(`${e}`,(()=>{a(d[i][s]).to.equal(l(n,e))}))},d=(e,i,s,n,r)=>{const d=o(e),u=new $e(d);return t(`${e}`,(()=>{a(u[i][s]).to.equal(l(n,e)+r)}))};e("Standard attribute modifiers",(()=>{return t="Attribute",s.map((a=>e(`${t}: ${a}`,(()=>i.map((e=>r(e,a,"mod",0)))))));var t})),e("Strength modifiers",(()=>{e("Open Doors",(()=>i.map((e=>r(e,"str","od",2)))))})),e("Intelligence modifiers",(()=>{e("Literacy",(()=>i.map((e=>r(e,"int","literacy",3))))),e("Spoken Languages",(()=>i.map((e=>r(e,"int","spoken",4)))))})),e("Dexterity modifiers",(()=>{e("Initiative",(()=>i.map((e=>r(e,"dex","init",1)))))})),e("Charisma modifiers",(()=>{e("NPC Reaction",(()=>i.map((e=>r(e,"cha","npc",1))))),e("Loyalty",(()=>i.map((e=>d(e,"cha","retain",0,4))))),e("Number of Retainers",(()=>i.map((e=>d(e,"cha","loyalty",0,7)))))}))};const Ut={displayName:"OSE: Actor: Data Model: Character Spells"},Kt=(e,t)=>new Item.implementation({name:`Mock Spell ${foundry.utils.randomID()}`,type:"spell",system:Object.assign(Object.assign({},t),{lvl:e})}),Vt=[1,2,3,4,5,6,7,8,9];var Yt=({describe:e,it:t,expect:a})=>{e("Spell levels",(()=>{t("Sorts the incoming spell list into an object with spell level keys",(()=>{const e=((e,...t)=>t.reduce(((t,a,i)=>[...t,...Array.from({length:a},(()=>Kt(i+1,e)))]),[]))({},...Vt),t=new _e({},e);Vt.forEach((e=>{a(t.spellList[e].length).to.equal(e)}))}))})),e("Spell slots",(()=>{e("Shows committed and max spell slots per level",(()=>{t("with no spells prepared",(()=>{const e=[Kt(1)],t=new _e({1:{max:1}},e);a(t.slots[1].used).to.equal(0),a(t.slots[1].max).to.equal(1)})),t("with spells prepared, not cast",(()=>{const e=[Kt(1,{memorized:1,cast:1})],t=new _e({1:{max:1}},e);a(t.slots[1].used).to.equal(1),a(t.slots[1].max).to.equal(1)})),t("with spells prepared and cast",(()=>{const e=[Kt(1,{memorized:1,cast:0})],t=new _e({1:{max:1}},e);a(t.slots[1].used).to.equal(0),a(t.slots[1].max).to.equal(1)}))}))})),e("Checking for spellcasting",(()=>{t("Can cast spells when spellcasting is enabled",(()=>{const e=new _e({enabled:!0},[]);a(e.enabled).to.be.true})),t("Cannot cast spells when spellcasting is disabled",(()=>{const e=new _e({enabled:!1},[]);a(e.enabled).to.be.false})),t("Can toggle between being able and unable to cast spells",(()=>{const e=new _e({enabled:!0},[]);a(e.enabled).to.be.true,e.enabled=!1,a(e.enabled).to.be.false}))}))};const Xt="ose.actor.datamodel.monster",Jt={displayName:"OSE: Actor: Data Model: Monster"},Qt=()=>wt("monster",{},Xt);var Zt=({describe:t,it:a,expect:i,after:s,afterEach:n,before:l})=>{const o=new Re,r=game.settings.get(game.system.id,"ascendingAC"),d=game.settings.get(game.system.id,"initiative");s((()=>{game.settings.set(game.system.id,"ascendingAC",r),game.settings.set(game.system.id,"initiative",d),It(Xt)})),t("prepareDerivedData()",(()=>{n((()=>{It(Xt)})),a("doesnt have scores",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.scores).is.undefined})))),a("has encumbrance",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.encumbrance).not.undefined,i(null==e?void 0:e.system.encumbrance.variant).not.undefined,i(null==e?void 0:e.system.encumbrance.enabled).not.undefined,i(null==e?void 0:e.system.encumbrance.pct).not.undefined,i(null==e?void 0:e.system.encumbrance.encumbered).not.undefined,i(null==e?void 0:e.system.encumbrance.steps).not.undefined,i(null==e?void 0:e.system.encumbrance.value).not.undefined,i(null==e?void 0:e.system.encumbrance.max).not.undefined,i(null==e?void 0:e.system.encumbrance.atHalfEncumbered).not.undefined,i(null==e?void 0:e.system.encumbrance.atQuarterEncumbered).not.undefined,i(null==e?void 0:e.system.encumbrance.atEighthEncumbered).not.undefined})))),a("have movement",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.movement).not.undefined,i(null==e?void 0:e.system.movement.base).not.undefined})))),a("have ac",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.ac).not.undefined,i(null==e?void 0:e.system.ac.value).not.undefined,i(null==e?void 0:e.system.ac.mod).not.undefined})))),a("have aac",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.aac).not.undefined,i(null==e?void 0:e.system.aac.value).not.undefined,i(null==e?void 0:e.system.aac.mod).not.undefined})))),t("has spells",(()=>{const t=new Set(["1","2","3","4","5","6"]);a("has spells",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.spells).not.undefined,i(null==e?void 0:e.system.spells.enabled).not.undefined,i(null==e?void 0:e.system.spells.spellList).not.undefined,i(null==e?void 0:e.system.spells.slots).not.undefined})))),t.forEach((t=>{a(`has spell level ${t}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.spells.slots[t]).not.undefined,i(Object.keys(null==e?void 0:e.system.spells.slots[t])).contain("used"),i(Object.keys(null==e?void 0:e.system.spells.slots[t])).contain("max")}))))}))}))})),t("defineSchema()",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){yield Qt()}))));["config","initiative","thac0","languages"].forEach((t=>{a(`has ${t}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Xt);i(null==e?void 0:e.system[t]).not.undefined}))))}));[{field:"hp",subFields:["hd","value","max"]},{field:"retainer",subFields:["enabled","loyalty","wage"]}].forEach((({field:t,subFields:s})=>{s.forEach((s=>{a(`${t} field has ${s} subfield`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Xt);i(null==e?void 0:e.system[t]).not.undefined,i(null==e?void 0:e.system[t][s]).not.undefined}))))}))}));[{field:"saves",subFields:[{subField:"breath",subSubField:["value"]},{subField:"death",subSubField:["value"]},{subField:"paralysis",subSubField:["value"]},{subField:"spell",subSubField:["value"]},{subField:"wand",subSubField:["value"]}]}].forEach((({field:t,subFields:s})=>{s.forEach((({subField:s,subSubField:n})=>{a(`${t} field has ${s} subfield, which has ${n} field`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(Xt);i(null==e?void 0:e.system[t]).not.undefined,i(null==e?void 0:e.system[t][s]).not.undefined,i(null==e?void 0:e.system[t][s][n]).not.undefined}))))}))})),s((()=>{It(Xt)}))})),t("isNew()",(()=>{a("New when all saves are at 0",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("monster",{system:{saves:{breath:{value:0},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Xt);i(null==e?void 0:e.system.isNew).to.be.true})))),a("Not new when any save is above 0",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("monster",{system:{saves:{breath:{value:10},death:{value:0},paralysis:{value:0},spell:{value:0},wand:{value:0}}}},Xt);i(null==e?void 0:e.system.isNew).to.be.false}))))})),t("containers()",(()=>{a("returns all containers",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.containers.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test container");const t=null==e?void 0:e.items.contents[0].id;i(null==e?void 0:e.system.containers.length).equal(1),i(null==e?void 0:e.system.containers[0]._id).equal(t),null==e||e.delete()})))),s((()=>{It(Xt)}))})),t("treasures()",(()=>{a("returns treasures on actor",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.treasures.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test treasure"),i(null==e?void 0:e.items.contents[0].system.treasure).is.true;const t=null==e?void 0:e.items.contents[0].id;i(null==e?void 0:e.system.treasures.length).equal(1),i(null==e?void 0:e.system.treasures[0]._id).equal(t),null==e||e.delete()})))),a("doesn't returns treasures on actor if in container",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.treasures.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]);const t=null==e?void 0:e.items.getName("test container");yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test treasure",system:{treasure:!0,containerId:null==t?void 0:t.id}}]),i(null==e?void 0:e.items.contents.length).equal(2),i(null==e?void 0:e.items.contents[0].name).equal("test container"),i(null==e?void 0:e.items.contents[1].name).equal("test treasure"),i(null==e?void 0:e.items.contents[1].system.treasure).is.true,i(null==e?void 0:e.items.contents[1].system.containerId).equal(null==t?void 0:t.id),i(null==e?void 0:e.system.treasures.length).equal(0),null==e||e.delete()})))),s((()=>{It(Xt)}))})),t("items()",(()=>{a("only returns other items than treasure",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.items.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test item"},{type:"item",name:"test treasure",system:{treasure:!0,quantity:{value:3},cost:4}}]),i(null==e?void 0:e.items.contents.length).equal(2),i(null==e?void 0:e.items.contents[0].name).equal("test item"),i(null==e?void 0:e.items.contents[1].name).equal("test treasure"),i(null==e?void 0:e.items.contents[1].system.treasure).is.true,i(null==e?void 0:e.system.items.length).equal(1),i(null==e?void 0:e.system.items[0].name).equal("test item"),null==e||e.delete()})))),a("only returns other items than stored in containers",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system.items.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]);const t=null==e?void 0:e.items.getName("test container");yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"item",name:"test item in container",system:{containerId:null==t?void 0:t.id}},{type:"item",name:"test item"}]),i(null==e?void 0:e.items.contents.length).equal(3),i(null==e?void 0:e.items.contents[0].name).equal("test container"),i(null==e?void 0:e.items.contents[1].name).equal("test item in container"),i(null==e?void 0:e.items.contents[2].name).equal("test item"),i(null==e?void 0:e.system.items.length).equal(1),i(null==e?void 0:e.system.items[0].name).equal("test item"),null==e||e.delete()}))))}));[{type:"weapon",getter:"weapons"},{type:"ability",getter:"abilities"},{type:"armor",getter:"armor"}].forEach((({type:n,getter:l})=>{t(`${l}()`,(()=>{a(`returns all ${l}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system[l].length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:n,name:`test ${n}`}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal(`test ${n}`);const t=null==e?void 0:e.items.contents[0].id;i(null==e?void 0:e.system[l].length).equal(1),i(null==e?void 0:e.system[l][0]._id).equal(t),null==e||e.delete()})))),a(`returns all ${l} except ones in container`,(()=>e(void 0,void 0,void 0,(function*(){if("abilities"===l)return;const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),i(null==e?void 0:e.system[l].length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"container",name:"test container"}]);const t=null==e?void 0:e.items.getName("test container");yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:n,name:`test ${n} in container`,system:{containerId:null==t?void 0:t.id}},{type:n,name:`test ${n}`}]),i(null==e?void 0:e.items.contents.length).equal(3),i(null==e?void 0:e.items.contents[0].name).equal("test container"),i(null==e?void 0:e.items.contents[1].name).equal(`test ${n} in container`),i(null==e?void 0:e.items.contents[2].name).equal(`test ${n}`);const a=null==e?void 0:e.items.contents[2].id;i(null==e?void 0:e.system[l].length).equal(1),i(null==e?void 0:e.system[l][0]._id).equal(a),null==e||e.delete()}))))})),s((()=>{It(Xt)}))})),t("attackPatterns()",(()=>{a("returns all weapons and abilities in transparent when no pattern set",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"ability",name:"test ability"},{type:"weapon",name:"test weapon"}]),i(Object.keys(null==e?void 0:e.system.attackPatterns).length).equal(1),i(Object.keys(null==e?void 0:e.system.attackPatterns)).contain("transparent"),i(null==e?void 0:e.system.attackPatterns.transparent.length).equal(2),i(null==e?void 0:e.system.attackPatterns.transparent[0].name).equal("test weapon"),i(null==e?void 0:e.system.attackPatterns.transparent[1].name).equal("test ability")})))),a("returns separated weapons and abilities whith patterns patterns",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"ability",name:"test ability green",system:{pattern:"green"}},{type:"weapon",name:"test weapon green",system:{pattern:"green"}},{type:"ability",name:"test ability"},{type:"weapon",name:"test weapon"}]),i(Object.keys(null==e?void 0:e.system.attackPatterns).length).equal(2),i(Object.keys(null==e?void 0:e.system.attackPatterns)).contain("transparent"),i(Object.keys(null==e?void 0:e.system.attackPatterns)).contain("green"),i(null==e?void 0:e.system.attackPatterns.transparent.length).equal(2),i(null==e?void 0:e.system.attackPatterns.transparent[0].name).equal("test ability"),i(null==e?void 0:e.system.attackPatterns.transparent[1].name).equal("test weapon"),i(null==e?void 0:e.system.attackPatterns.green.length).equal(2),i(null==e?void 0:e.system.attackPatterns.green[0].name).equal("test weapon green"),i(null==e?void 0:e.system.attackPatterns.green[1].name).equal("test ability green")}))))})),t("isSlow()",(()=>{a("returns false if no weapons",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.system.isSlow).is.false,null==e||e.delete()})))),a("returns false if weapon that doesn't have slow tag",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!1}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test weapon"),i(null==e?void 0:e.system.isSlow).is.false,null==e||e.delete()})))),a("returns true if weapon that has slow tag",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Qt();i(null==e?void 0:e.items.contents.length).equal(0),yield null==e?void 0:e.createEmbeddedDocuments("Item",[{type:"weapon",name:"test weapon",system:{slow:!0}}]),i(null==e?void 0:e.items.contents.length).equal(1),i(null==e?void 0:e.items.contents[0].name).equal("test weapon"),i(null==e?void 0:e.system.isSlow).is.true,null==e||e.delete()})))),s((()=>{It(Xt)}))})),t("init()",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"initiative","individual")})))),a("returns 0 by default",(()=>{i(o.initiative.value).equal(0),i(o.initiative.mod).equal(0),i(o.scores.dex.init).equal(0),i(o.init).equal(0)})),a("returns correctly with initiative value set",(()=>e(void 0,void 0,void 0,(function*(){o.initiative.value=12,i(o.init).equal(12),o.initiative.value=0,i(o.initiative.value).equal(0)})))),a("returns correctly with initiative mod set",(()=>e(void 0,void 0,void 0,(function*(){o.initiative.mod=10,i(o.init).equal(10),o.initiative.mod=0,i(o.initiative.mod).equal(0)})))),a("returns correctly with dex mod init set",(()=>e(void 0,void 0,void 0,(function*(){o.scores.dex={init:5},i(o.init).equal(5),o.scores.dex.init=0,i(o.scores.dex.init).equal(0)}))))}))};const ea="ose.actor.entity",ta={displayName:"OSE: Actor: Entity",preSelected:!0},aa=t=>e(void 0,void 0,void 0,(function*(){return He.create({name:`Test Actor ${ea}`,type:t})}));var ia=({describe:t,it:a,expect:i,after:s,afterEach:n,before:l,assert:o})=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt(),It(ea),Ct()})))),t("update(data, options)",(()=>{a("AAC to AC",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");i(null==e?void 0:e.system.ac.value).equal(12),i(null==e?void 0:e.system.aac.value).equal(7),yield null==e?void 0:e.system.update({ac:{value:15}}),yield ht(),i(null==e?void 0:e.system.ac.value).equal(15),i(null==e?void 0:e.system.aac.value).equal(4)})))),a("AC to AAC",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");i(null==e?void 0:e.system.ac.value).equal(12),i(null==e?void 0:e.system.aac.value).equal(7),yield null==e?void 0:e.system.update({aac:{value:15}}),yield ht(),i(null==e?void 0:e.system.aac.value).equal(15),i(null==e?void 0:e.system.ac.value).equal(4)})))),a("THAC0 to BBA",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");i(null==e?void 0:e.system.thac0.value).equal(12),i(null==e?void 0:e.system.thac0.value).equal(7),yield null==e?void 0:e.system.update({thac0:{value:15}}),yield ht(),i(null==e?void 0:e.system.thac0.value).equal(15),i(null==e?void 0:e.system.thac0.value).equal(4)})))),a("BBA to THAC0",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");i(null==e?void 0:e.system.thac0.value).equal(12),i(null==e?void 0:e.system.thac0.value).equal(7),yield null==e?void 0:e.system.update({thac0:{bba:15}}),yield ht(),i(null==e?void 0:e.system.thac0.value).equal(15),i(null==e?void 0:e.system.thac0.value).equal(4)}))))})),t("createEmbeddedDocuments(embeddedName, data, context)",(()=>{s((()=>e(void 0,void 0,void 0,(function*(){var e;null===(e=game.items)||void 0===e||e.filter((e=>{var t;return(null===(t=null==e?void 0:e.name)||void 0===t?void 0:t.indexOf(`Test ${ea}`))>=0})).forEach((e=>e.delete()))})))),Dt.forEach((t=>{a(`Creates ${t.capitalize()} with correct default icon`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character"),a=yield ze.create({name:`Test ${ea} ${t.capitalize()}`,type:t});yield null==e?void 0:e.createEmbeddedDocuments("Item",[a]);const s=null==e?void 0:e.items.getName(null==a?void 0:a.name);i(null==s?void 0:s.img).equal(ze.defaultIcons[t]),null==a||a.delete()}))))}))})),t("getExperience(value, options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("Adding positive XP adds to experience",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null==a?void 0:a.system.details.xp.value).equal(0),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield null==a?void 0:a.getExperience(10),i(null==a?void 0:a.system.details.xp.value).equal(10),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield null==a?void 0:a.delete()})))),a("Adding negative XP subtracts from experience",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null==a?void 0:a.system.details.xp.value).equal(0),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield null==a?void 0:a.getExperience(-10),i(null==a?void 0:a.system.details.xp.value).equal(-10),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield null==a?void 0:a.delete()})))),a("Adding positive XP adds to experience modified by bonus",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");yield null==a?void 0:a.update({system:{details:{xp:{bonus:10}}}}),i(null==a?void 0:a.system.details.xp.value).equal(0),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield null==a?void 0:a.getExperience(10),i(null==a?void 0:a.system.details.xp.value).equal(11),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield null==a?void 0:a.delete()}))))})),t("isNew()",(()=>{a("character",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");i(null==e?void 0:e.isNew()).equal(!0),yield null==e?void 0:e.delete()})))),a("monster",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("monster");i(null==e?void 0:e.isNew()).equal(!0),yield null==e?void 0:e.delete()}))))})),t("generateSave(hd)",(()=>e(void 0,void 0,void 0,(function*(){const e=[{low:-99,high:1,death:14,wands:15,paralysis:16,breath:17,spell:18},{low:1,high:3,death:12,wands:13,paralysis:14,breath:15,spell:16},{low:4,high:6,death:10,wands:11,paralysis:12,breath:13,spell:14},{low:7,high:9,death:8,wands:9,paralysis:10,breath:10,spell:12},{low:10,high:12,death:6,wands:7,paralysis:8,breath:8,spell:10},{low:10,high:12,death:6,wands:7,paralysis:8,breath:8,spell:10},{low:13,high:15,death:4,wands:5,paralysis:6,breath:5,spell:8},{low:16,high:18,death:2,wands:3,paralysis:4,breath:3,spell:6},{low:19,high:21,death:2,wands:2,paralysis:2,breath:2,spell:4},{low:22,high:99,death:2,wands:2,paralysis:2,breath:2,spell:2}],t=[{low:-100,high:0,value:20},{low:0,high:1,value:19},{low:1,high:2,value:18},{low:2,high:3,value:17},{low:3,high:4,value:16},{low:4,high:5,value:15},{low:5,high:6,value:14},{low:6,high:7,value:13},{low:7,high:9,value:12},{low:9,high:11,value:11},{low:11,high:13,value:1},{low:13,high:15,value:9},{low:15,high:17,value:8},{low:17,high:19,value:7},{low:19,high:21,value:6},{low:21,high:100,value:5}],s=Array.from({length:23},((e,t)=>t+1)),n=yield aa("monster");s.forEach((s=>{const l=e.find((e=>s>=e.low&&s<=e.high)),o=t.find((e=>s>=e.low&&s<=e.high)),r=t.find((e=>s+1>=e.low&&s+1<=e.high));null==n||n.generateSave(`${s}`),a(`hd ${s} generates correct saves`,(()=>{i(null==n?void 0:n.system.saves.death.value).equal(null==l?void 0:l.death),i(null==n?void 0:n.system.saves.wand.value).equal(null==l?void 0:l.wands),i(null==n?void 0:n.system.saves.paralysis.value).equal(null==l?void 0:l.paralysis),i(null==n?void 0:n.system.saves.breath.value).equal(null==l?void 0:l.breath),i(null==n?void 0:n.system.saves.spell.value).equal(null==l?void 0:l.spell)})),a(`hd ${s} generates correct thac0`,(()=>{i(null==n?void 0:n.system.thac0.value).equal(null==o?void 0:o.value),i(null==n?void 0:n.system.thac0.bba).equal(19-(null==o?void 0:o.value))})),null==n||n.generateSave(`${s}+`),a(`hd ${s}+ generates correct thac0`,(()=>{i(null==n?void 0:n.system.thac0.value).equal(null==r?void 0:r.value),i(null==n?void 0:n.system.thac0.bba).equal(19-(null==r?void 0:r.value))}))})),yield null==n?void 0:n.delete()})))),t("rollHP(options)",(()=>e(void 0,void 0,void 0,(function*(){const t=yield aa("monster"),i=Array.from({length:20},((e,t)=>t+1)),s=[-3,-3,-3,-2,-2,-1,-1,-1,0,0,0,0,1,1,1,2,2,3,3,3],n=[4,6,8,10,12,20];i.forEach(((i,l)=>{n.forEach((n=>{a(`${n} hd with ${i} Con correctly rolls HP`,(()=>e(void 0,void 0,void 0,(function*(){yield null==t?void 0:t.update({system:{hp:{hd:`1d${n}`},scores:{con:{value:i}}}}),yield null==t?void 0:t.rollHP(),o((null==t?void 0:t.system.hp.max)-s[l]>=1),o((null==t?void 0:t.system.hp.value)-s[l]>=1),o((null==t?void 0:t.system.hp.max)-s[l]>=n),o((null==t?void 0:t.system.hp.value)-s[l]>=n)}))))}))})),yield null==t?void 0:t.delete()})))),t("rollSave(save, options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()}))));["death","wand","paralysis","breath","spell"].forEach((t=>{a(`is functional for ${t} saves on character`,(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield null==s?void 0:s.rollSave(t,{fastForward:!0}),yield ht(),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1),yield null==s?void 0:s.delete()})))),a(`is functional for ${t} saves on monster`,(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollSave(t,{fastForward:!0}),yield ht(),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1),yield null==s?void 0:s.delete()}))))}))})),t("rollMorale(options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("for character",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollMorale(),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield null==a?void 0:a.delete()})))),a("for monster",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollMorale(),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield null==a?void 0:a.delete()}))))})),t("rollLoyalty(options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("for character",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollLoyalty(),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield null==a?void 0:a.delete()})))),a("for monster",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollLoyalty(),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield null==a?void 0:a.delete()}))))})),t("rollReaction(options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("for character",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollReaction({fastForward:!0}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield a.delete()})))),a("for monster",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollReaction({fastForward:!0}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield a.delete()}))))})),t("rollCheck(score, options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),["str","int","dex","wis","con","cha"].forEach((t=>{a(`${t} for character`,(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollCheck(t,{fastForward:!0}),yield ht(),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1),yield s.delete()})))),a(`${t} for character`,(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollCheck(t,{fastForward:!0}),yield ht(),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(0),yield s.delete()}))))}))})),t("rollHitDice(options)",(()=>{const t=Array.from({length:20},((e,t)=>t+1)),s=[-3,-3,-3,-2,-2,-1,-1,-1,0,0,0,0,1,1,1,2,2,3,3,3],n=Array.from({length:9},((e,t)=>t+1));t.forEach(((t,l)=>{const o=s[l],r=o>=0?5:6,d=o<0?"-":"+",u="-"===d?-1*o:o;n.forEach((s=>{a(`constructs the roll terms correctly with level ${s} and con ${t}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield null==e?void 0:e.update({system:{details:{level:s},scores:{con:{value:t}}}});const a=yield e.rollHitDice();i(a.terms.length).equal(r),i(a.terms[0].expression).equal(null==e?void 0:e.system.hp.hd),o<0&&i(a.terms[r-5].operator).equal("+"),i(a.terms[r-4].operator).equal(d),i(a.terms[r-3].expression).equal(u.toString()),i(a.terms[r-2].operator).equal("+"),i(a.terms[r-1].expression).equal(s.toString()),i(null==e?void 0:e.system.scores.con.mod).equal(o),yield null==e?void 0:e.delete()}))))}))}))})),t("rollAppearing(options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("for character",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollAppearing(),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(0),yield a.delete()})))),t("for monster",(()=>{a("in wilderness",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;const s=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollAppearing({check:"wilderness"}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),i(null===(a=game.messages)||void 0===a?void 0:a.contents[0].content).contain(game.i18n.format("OSE.roll.appearing",{type:"(2)"})),yield s.delete()})))),a("in other",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;const s=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollAppearing({check:"other"}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),i(null===(a=game.messages)||void 0===a?void 0:a.contents[0].content).contain(game.i18n.format("OSE.roll.appearing",{type:"(1)"})),yield s.delete()}))))}))})),t("rollExploration(expl, options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()}))));["ld","od","sd","fs"].forEach((t=>{a("for character",(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollExploration(t,{fastForward:!0}),yield ht(),i(null===(a=game.messages)||void 0===a?void 0:a.contents[0].content).contain(game.i18n.format("OSE.roll.exploration",{exploration:game.i18n.localize(`OSE.exploration.${t}.long`)})),yield s.delete()}))))})),a("for monster",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield a.rollExploration("ld",{fastForward:!0}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(0),yield a.delete()}))))})),t("rollDamage(attData, options)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("for character",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;const s=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollDamage({label:"test"}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),i(null===(a=game.messages)||void 0===a?void 0:a.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),yield s.delete()})))),a("for monster",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;const s=yield aa("monster");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield s.rollDamage({label:"test"}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),i(null===(a=game.messages)||void 0===a?void 0:a.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),yield s.delete()})))),a("Adds roll.dmg to damage parts if provided",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s;const n=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield n.rollDamage({label:"test",roll:{dmg:"15"}}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),i(null===(a=game.messages)||void 0===a?void 0:a.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),i(null===(s=game.messages)||void 0===s?void 0:s.contents[0].content).contain("15"),yield n.delete()})))),a("Adds strength bonus if melee damage roll",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s;const n=yield aa("character");yield null==n?void 0:n.update({system:{scores:{str:{value:1}}}}),i(n.system.scores.str.value).equal(1),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield n.rollDamage({label:"test",roll:{dmg:"15",type:"melee"}}),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),i(null===(a=game.messages)||void 0===a?void 0:a.contents[0].content).contain(`test - ${game.i18n.localize("OSE.Damage")}`),i(null===(s=game.messages)||void 0===s?void 0:s.contents[0].content).contain("15 +  - 3"),yield n.delete()}))))})),t("targetAttack(data, type, options)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){const e=yield kt();yield null==e?void 0:e.activate()})))),n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("One target causes one attack roll",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n,l,o,r,d,u,c;const m=yield aa("character"),v=yield m.getTokenDocument();yield null===(e=canvas.scene)||void 0===e?void 0:e.createEmbeddedDocuments("Token",[v]),yield ht(),i(null===(t=game.user)||void 0===t?void 0:t.targets.size).equal(0),null===(a=canvas.tokens)||void 0===a||a.placeables.forEach((e=>e.setTarget(!0,{releaseOthers:!1,groupSelection:!0}))),i(null===(s=canvas.tokens)||void 0===s?void 0:s.placeables[0].actor).not.null,i(null===(l=null===(n=canvas.tokens)||void 0===n?void 0:n.placeables[0].actor)||void 0===l?void 0:l.system.ac.value).not.null,i(null===(o=game.user)||void 0===o?void 0:o.targets.size).equal(1),i(null===(r=game.messages)||void 0===r?void 0:r.size).equal(0),yield m.targetAttack({roll:{target:{}}},"melee",{skipDialog:!0}),yield ht(),i(null===(d=game.messages)||void 0===d?void 0:d.size).equal(1),null===(u=canvas.tokens)||void 0===u||u.placeables[0].setTarget(!1,{releaseOthers:!0}),i(null===(c=game.user)||void 0===c?void 0:c.targets.size).equal(0),yield m.delete()})))),a("Multiple target causes multiple attack rolls",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n,l,o,r;const d=yield aa("character"),u=yield d.getTokenDocument();yield null===(e=canvas.scene)||void 0===e?void 0:e.createEmbeddedDocuments("Token",[u]),yield ht(),i(null===(t=game.user)||void 0===t?void 0:t.targets.size).equal(0),null===(a=canvas.tokens)||void 0===a||a.placeables.forEach((e=>e.setTarget(!0,{releaseOthers:!1,groupSelection:!0}))),i(null===(s=game.user)||void 0===s?void 0:s.targets.size).equal(2),i(null===(n=game.messages)||void 0===n?void 0:n.size).equal(0),yield d.targetAttack({roll:{target:{}}},"melee",{skipDialog:!0}),yield ht(),i(null===(l=game.messages)||void 0===l?void 0:l.size).equal(2),null===(o=canvas.tokens)||void 0===o||o.placeables[0].setTarget(!1,{releaseOthers:!0}),i(null===(r=game.user)||void 0===r?void 0:r.targets.size).equal(0),yield d.delete()})))),a("If no target is given, just roll attack",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;const s=yield aa("character");i(null===(e=game.user)||void 0===e?void 0:e.targets.size).equal(0),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(0),yield s.targetAttack({roll:{blindroll:!1,dmg:["1d6"],thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}},"melee",{skipDialog:!0}),yield ht(),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1),yield s.delete()})))),s((()=>{At()}))})),t("rollAttack(attdata, options)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("rolls a d20 if supplied no data",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const s=yield a.rollAttack({roll:{}},{skipDialog:!0});i(s.formula).equal("1d20"),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield a.delete()})))),a("Provided an item, adds item damage to dmgParts",(()=>e(void 0,void 0,void 0,(function*(){})))),a("If missile attack, add dex mod to attack roll",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const s=yield a.rollAttack({roll:{}},{type:"missile",skipDialog:!0});i(s.formula).equal("1d20 +  - 3 + 0"),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield a.delete()})))),a("If melee attack, add str mod to attack roll",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character");yield a.update({system:{scores:{str:{value:18}}}}),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const s=yield a.rollAttack({roll:{}},{type:"melee",skipDialog:!0});i(s.formula).equal("1d20 + 3 + 0"),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield a.delete()})))),a("If melee attack, add str mod to damage roll",(()=>e(void 0,void 0,void 0,(function*(){})))),a("If item provided with a bonus, it is added as bonus to attack roll",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield aa("character"),s=yield qt("weapon");yield null==s?void 0:s.update({system:{bonus:18}}),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const n=yield a.rollAttack({roll:{},item:s},{skipDialog:!0});i(n.formula).equal("1d20 + 18"),yield ht(),i(null===(t=game.messages)||void 0===t?void 0:t.size).equal(1),yield a.delete()}))))})),t("applyDamage(amount, multiplier)",(()=>{a("doesn't remove hp if no variables are given",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:10,max:10}}}),i(e.system.hp.value).equal(10),yield e.applyDamage(),i(e.system.hp.value).equal(10),yield e.delete()})))),a("calculates the amount with amount",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:10,max:10}}}),i(e.system.hp.value).equal(10),yield e.applyDamage(3),i(e.system.hp.value).equal(7),yield e.delete()})))),a("calculates the amount with amount and multiplier",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:10,max:10}}}),i(e.system.hp.value).equal(10),yield e.applyDamage(3,2),i(e.system.hp.value).equal(4),yield e.delete()})))),a("calculates the amount with amount and negative multiplier",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:1,max:10}}}),i(e.system.hp.value).equal(1),yield e.applyDamage(3,-2),i(e.system.hp.value).equal(7),yield e.delete()})))),a("calculates the amount with negative amount",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:1,max:10}}}),i(e.system.hp.value).equal(1),yield e.applyDamage(-3),i(e.system.hp.value).equal(4),yield e.delete()})))),a("doesn't reduce lower than 0 hp with only amount",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:10,max:10}}}),i(e.system.hp.value).equal(10),yield e.applyDamage(20),i(e.system.hp.value).equal(0),yield e.delete()})))),a("doesn't reduce lower than 0 hp with amount and multiplier",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:10,max:10}}}),i(e.system.hp.value).equal(10),yield e.applyDamage(4,3),i(e.system.hp.value).equal(0),yield e.delete()})))),a("doesn't increase higher than max hp with only amount",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:1,max:10}}}),i(e.system.hp.value).equal(1),yield e.applyDamage(-20),i(e.system.hp.value).equal(10),yield e.delete()})))),a("doesn't increase higher than max hp with amount and multiplier",(()=>e(void 0,void 0,void 0,(function*(){const e=yield aa("character");yield e.update({system:{hp:{value:1,max:10}}}),i(e.system.hp.value).equal(1),yield e.applyDamage(4,-3),i(e.system.hp.value).equal(10),yield e.delete()}))))}))};const sa="ose.actor.sheet",na={displayName:"OSE: Actor: Sheet",preSelected:!0},la=()=>e(void 0,void 0,void 0,(function*(){var e;return null===(e=game.actors)||void 0===e?void 0:e.getName(`Test Actor ${sa}`)}));var oa=({describe:t,it:a,expect:i,after:s,afterEach:n,before:l})=>{const o=game.settings.get(game.system.id,"invertedCtrlBehavior");s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield bt(),game.settings.set(game.system.id,"invertedCtrlBehavior",o)})))),t("getData()",(()=>{a("returns the expected data",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa),a=new P(t).getData();i(a.owner).equal(null==t?void 0:t.isOwner),i(a.editable).equal(null===(e=null==t?void 0:t.sheet)||void 0===e?void 0:e.isEditable),i(Object.keys(a.config)).contain("ascendingAC"),i(Object.keys(a.config)).contain("initiative"),i(Object.keys(a.config)).contain("encumbrance"),i(a.isNew).equal(null==t?void 0:t.isNew())}))))})),t("_getItemFromActor(event)",(()=>{Dt.forEach((t=>{a(`Can get an ${t.capitalize()} item`,(()=>e(void 0,void 0,void 0,(function*(){var e,a,s;const n=yield wt("character",{},sa);yield null==n?void 0:n.update({system:{spells:{enabled:!0}}}),null===(e=null==n?void 0:n.sheet)||void 0===e||e.render(!0),yield vt(200);const l=yield St(n,t);yield ht(),i(null==n?void 0:n.items.size).equal(1);const o=null==l?void 0:l.pop();i(null==n?void 0:n.items.contents.find((e=>e.id===(null==o?void 0:o.id)))).not.undefined;let r="";switch(t){case"spell":r=".tab[data-tab=spells]";break;case"ability":r=".tab[data-tab=abilities]";break;default:r=".tab[data-tab=inventory]"}const d=document.querySelector(`${r} .item-name`),u=null===(s=null===(a=null==d?void 0:d.parentElement)||void 0===a?void 0:a.nextElementSibling)||void 0===s?void 0:s.style;i(u.display).equal(""),$(`${r} .item-name`).trigger("click"),yield vt(200),i(u.display).equal("block"),yield null==n?void 0:n.delete()})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield bt()}))))}))})),t("_toggleItemCategory(event)",(()=>{const t=()=>e(void 0,void 0,void 0,(function*(){$(".tab[data-tab=inventory] .item-category-title").trigger("click"),yield vt(220)}));l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield t.update({system:{spells:{enabled:!0}}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield vt(220)})))),a("clicking the category name hides the item cateogry",(()=>e(void 0,void 0,void 0,(function*(){const e=yt("sheet");i(e.length).equal(1);const a=document.querySelector(".tab[data-tab=inventory] .item-list");i(null==a?void 0:a.style.display).equal(""),yield t(),i(null==a?void 0:a.style.display).equal("none")})))),a("clicking the category name again shows the item cateogry",(()=>e(void 0,void 0,void 0,(function*(){const e=yt("sheet");i(e.length).equal(1);const a=document.querySelector(".tab[data-tab=inventory] .item-list");i(null==a?void 0:a.style.display).equal("none"),yield t(),i(null==a?void 0:a.style.display).equal("")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield bt()}))))})),t("_toggleContainedItems(event)",(()=>{const t=()=>e(void 0,void 0,void 0,(function*(){$(".tab[data-tab=inventory] .container .category-caret").trigger("click"),yield vt(220)}));l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield St(t,"container"),yield St(t,"weapon");const a=null==t?void 0:t.items.getName("New Actor Test Weapon"),i=null==t?void 0:t.items.getName("New Actor Test Container");yield null==a?void 0:a.update({system:{containerId:null==i?void 0:i.id}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0)})))),a("clicking container caret will hide the content",(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yt("sheet");i(s.length).equal(1);const n=yield la();i(null==n?void 0:n.items.size).equal(2);const l=null===(e=null==n?void 0:n.items)||void 0===e?void 0:e.getName("New Actor Test Container");i(null===(a=null==n?void 0:n.items.getName("New Actor Test Weapon"))||void 0===a?void 0:a.system.containerId).equal(null==l?void 0:l.id);const o=document.querySelector(".tab[data-tab=inventory] .container .contained-items");i(null==o?void 0:o.style.display).equal(""),yield t(),i(null==o?void 0:o.style.display).equal("none")})))),a("clicking container caret again will show the content",(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yt("sheet");i(s.length).equal(1);const n=yield la();i(null==n?void 0:n.items.size).equal(2);const l=null===(e=null==n?void 0:n.items)||void 0===e?void 0:e.getName("New Actor Test Container");i(null===(a=null==n?void 0:n.items.getName("New Actor Test Weapon"))||void 0===a?void 0:a.system.containerId).equal(null==l?void 0:l.id);const o=document.querySelector(".tab[data-tab=inventory] .container .contained-items");i(null==o?void 0:o.style.display).equal("none"),yield t(),i(null==o?void 0:o.style.display).equal("")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield bt()}))))})),t("_toggleItemSummary(event)",(()=>{const n=t=>e(void 0,void 0,void 0,(function*(){$(`${t} .item-name`).trigger("click"),yield vt(220)}));l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield null==t?void 0:t.update({system:{spells:{enabled:!0}}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield vt(220)})))),Dt.forEach((o=>e(void 0,void 0,void 0,(function*(){let r="";switch(o){case"spell":r=".tab[data-tab=spells]";break;case"ability":r=".tab[data-tab=abilities]";break;default:r=".tab[data-tab=inventory]"}t(`for type ${o}`,(()=>{l((()=>e(void 0,void 0,void 0,(function*(){const e=yield la();yield St(e,o)})))),a("clicking item name will show the content",(()=>e(void 0,void 0,void 0,(function*(){const e=yt("sheet");i(e.length).equal(1);const t=yield la();i(null==t?void 0:t.items.size).equal(1);const a=document.querySelector(`${r} .item-summary`);i(null==a?void 0:a.style.display).equal(""),yield n(r),i(null==a?void 0:a.style.display).equal("block")})))),a("clicking item name again will hide the content",(()=>e(void 0,void 0,void 0,(function*(){const e=yt("sheet");i(e.length).equal(1);const t=yield la();i(null==t?void 0:t.items.size).equal(1);const a=document.querySelector(`${r} .item-summary`);i(null==a?void 0:a.style.display).equal("block"),yield n(r),i(null==a?void 0:a.style.display).equal("")})))),a("item containing description still shows the summary",(()=>e(void 0,void 0,void 0,(function*(){const e=yield la(),t=null==e?void 0:e.items.getName(`New Actor Test ${o.capitalize()}`);yield n(r),yield null==t?void 0:t.update({system:{description:"hello world"}}),yield ht(),i(null==t?void 0:t.system.description).equal("hello world");const a=document.querySelector(`${r} .item-summary`);i((null==a?void 0:a.innerHTML.indexOf("hello world"))>=0).is.true,yield null==t?void 0:t.update({system:{description:""}})})))),a("item containing macro reference still shows the summary, Issue #353",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Ot(),t=`<p>@UUID[${null==e?void 0:e.uuid}]{Mock Macro}</p>`,a=yield la(),s=null==a?void 0:a.items.getName(`New Actor Test ${o.capitalize()}`);yield null==s?void 0:s.update({system:{description:t}}),yield ht();const n=document.querySelector(`${r} .item-summary`);i(null==n?void 0:n.innerHTML).equal(""),i((null==n?void 0:n.innerHTML.indexOf(t))>=0).true,yield null==e?void 0:e.delete(),yield null==s?void 0:s.update({system:{description:""}})})))),s((()=>e(void 0,void 0,void 0,(function*(){const t=yield la();null==t||t.items.forEach((t=>e(void 0,void 0,void 0,(function*(){yield t.delete()})))),yield Tt()}))))}))})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield bt()}))))})),t("_displayItemInChat(event)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield null==t?void 0:t.update({system:{spells:{enabled:!0}}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield vt(220)})))),Dt.forEach((t=>{let n="";switch(t){case"spell":n=".tab[data-tab=spells]";break;case"ability":n=".tab[data-tab=abilities]";break;default:n=".tab[data-tab=inventory]"}a(`can show ${t}`,(()=>e(void 0,void 0,void 0,(function*(){var a,s,l;yield gt();const o=yield la();yield St(o,t),yield ht(),yield(t=>e(void 0,void 0,void 0,(function*(){$(`${t} .item-show`).trigger("click"),yield vt(220)})))(n),yield ht(),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1),i(null===(l=null===(s=game.messages)||void 0===s?void 0:s.contents[0])||void 0===l?void 0:l.content).contain(`New Actor Test ${t.capitalize()}`),null==o||o.items.forEach((e=>e.delete()))})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))}))})),t("_removeItemFromActor(item)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield null==t?void 0:t.update({system:{spells:{enabled:!0}}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0)})))),Dt.forEach((n=>{t(`${n} item`,(()=>{a("can remove item outside container",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield la();i(null==t?void 0:t.items.size).equal(0),yield St(t,n),yield ht();const a=null==t?void 0:t.items.getName(`New Actor Test ${n.capitalize()}`);i(null==t?void 0:t.items.size).equal(1),yield null===(e=null==t?void 0:t.sheet)||void 0===e?void 0:e._removeItemFromActor(a),yield ht(),i(null==t?void 0:t.items.size).equal(0)})))),"container"!==n&&"spell"!==n&&"ability"!==n&&(a("can remove item inside container",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;const s=yield la();i(null==s?void 0:s.items.size).equal(0),yield St(s,"container"),yield St(s,n),yield ht(),i(null==s?void 0:s.items.size).equal(2);const l=null==s?void 0:s.items.getName(`New Actor Test ${n.capitalize()}`),o=null==s?void 0:s.items.getName("New Actor Test Container");i(l).not.undefined,i(o).not.undefined,yield null===(e=null==s?void 0:s.sheet)||void 0===e?void 0:e._onContainerItemAdd(l,o),yield ht(),yield null===(t=null==s?void 0:s.sheet)||void 0===t?void 0:t._removeItemFromActor(l),yield ht(),i(null==s?void 0:s.items.size).equal(1),i(null==o?void 0:o.system.itemIds.length).equal(0),yield null===(a=null==s?void 0:s.sheet)||void 0===a?void 0:a._removeItemFromActor(o),yield ht(),i(null==s?void 0:s.items.size).equal(0)})))),a("removing container with item inside deletes just container",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield la();i(null==a?void 0:a.items.size).equal(0),yield St(a,"container"),yield St(a,n),yield ht(),i(null==a?void 0:a.items.size).equal(2);const s=null==a?void 0:a.items.getName(`New Actor Test ${n.capitalize()}`),l=null==a?void 0:a.items.getName("New Actor Test Container");i(s).not.undefined,i(l).not.undefined,i(null==a?void 0:a.items.size).equal(2),yield null===(e=null==a?void 0:a.sheet)||void 0===e?void 0:e._removeItemFromActor(l),yield ht(),i(null==a?void 0:a.items.size).equal(1),yield null===(t=null==a?void 0:a.sheet)||void 0===t?void 0:t._removeItemFromActor(s),yield ht(),i(null==a?void 0:a.items.size).equal(0)})))))})),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))}))})),t("_useConsumable(event, decrement)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield St(t,"item"),yield ht();const a=null==t?void 0:t.items.contents[0];null==a||a.update({system:{quantity:{max:6,value:3}}}),yield ht(),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield vt(220)})))),a("can decrease value",(()=>e(void 0,void 0,void 0,(function*(){const t=yield la(),a=null==t?void 0:t.items.contents[0];i(null==a?void 0:a.system.quantity.value).equal(3),yield e(void 0,void 0,void 0,(function*(){return $(".tab[data-tab=inventory] .full-mark").trigger("click")})),yield ht(),i(null==a?void 0:a.system.quantity.value).equal(2)})))),a("can increase value",(()=>e(void 0,void 0,void 0,(function*(){const t=yield la(),a=null==t?void 0:t.items.contents[0];i(null==a?void 0:a.system.quantity.value).equal(2),yield e(void 0,void 0,void 0,(function*(){return $(".tab[data-tab=inventory] .empty-mark").trigger("click")})),yield ht(),i(null==a?void 0:a.system.quantity.value).equal(3)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))})),t("_onSpellChange(event)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield null==t?void 0:t.update({system:{spells:{enabled:!0}}}),yield St(t,"spell"),yield ht(),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0)})))),a("changing the input for cast changes spell cast data",(()=>e(void 0,void 0,void 0,(function*(){$("input[data-field=cast]").val(3),yield ht();const e=yield la(),t=null==e?void 0:e.items.contents[0];i(null==t?void 0:t.system.cast).equal(3)})))),a("changing the input for memorize changes spell memorize data",(()=>e(void 0,void 0,void 0,(function*(){$("input[data-field=cast]").val(3),yield ht();const e=yield la(),t=null==e?void 0:e.items.contents[0];i(null==t?void 0:t.system.memorized).equal(3)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))})),t("_resetSpells(event)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield null==t?void 0:t.update({system:{spells:{enabled:!0}}}),yield St(t,"spell"),yield ht(),null==t||t.items.contents[0].update({system:{cast:1,memorized:3}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0)})))),a("resetting spells resets the cast field to maximum",(()=>e(void 0,void 0,void 0,(function*(){const e=yield la();$("a[data-action=reset-spells]").trigger("click"),yield ht(),i(null==e?void 0:e.items.contents[0].system.cast).equal(null==e?void 0:e.items.contents[0].system.memorized)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))})),t("_rollAbility(event) ",(()=>{const t=t=>e(void 0,void 0,void 0,(function*(){$(`.tab[data-tab=${t}] .item-image`).trigger("click"),yield vt(220)}));l((()=>e(void 0,void 0,void 0,(function*(){game.settings.set(game.system.id,"invertedCtrlBehavior",!0),yield gt()})))),n((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield gt()})))),a("rolling weapon on monster updates the counter value",(()=>e(void 0,void 0,void 0,(function*(){var e,a,s,n;i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const l=yield wt("monster",{},sa);yield St(l,"weapon"),yield ht(),yield null==l?void 0:l.items.contents[0].update({system:{counter:{value:3,max:3}}}),i(null==l?void 0:l.items.size).equal(1),null===(a=null==l?void 0:l.sheet)||void 0===a||a.render(!0),yield ht(),yield t("attributes"),i(null===(s=game.messages)||void 0===s?void 0:s.size).equal(1),i(null===(n=game.messages)||void 0===n?void 0:n.contents[0].content).contain("<h2>Attacks with New Actor Test Weapon</h2>"),i(null==l?void 0:l.items.contents[0].system.counter.value).equal(2)})))),a("rolling weapon on character rolls weapon",(()=>e(void 0,void 0,void 0,(function*(){var e,a,s,n;i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const l=yield wt("character",{},sa);yield St(l,"weapon"),yield ht(),i(null==l?void 0:l.items.size).equal(1),null===(a=null==l?void 0:l.sheet)||void 0===a||a.render(!0),yield ht(),yield t("inventory"),i(null===(s=game.messages)||void 0===s?void 0:s.size).equal(1),i(null===(n=game.messages)||void 0===n?void 0:n.contents[0].content).contain("<h2>Attacks with New Actor Test Weapon</h2>")})))),a("rolling spell rolls and spends the spell",(()=>e(void 0,void 0,void 0,(function*(){var e,a,s,n;i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const l=yield wt("character",{},sa);yield null==l?void 0:l.update({system:{spells:{enabled:!0}}}),yield St(l,"spell"),yield ht(),i(null==l?void 0:l.items.size).equal(1),null===(a=null==l?void 0:l.sheet)||void 0===a||a.render(!0),yield ht(),yield t("spells"),i(null===(s=game.messages)||void 0===s?void 0:s.size).equal(1),i(null===(n=game.messages)||void 0===n?void 0:n.contents[0].content).contain("<h2>New Actor Test Spell</h2>")})))),a("rolling anything else rolls the formula",(()=>e(void 0,void 0,void 0,(function*(){var e,a,s,n;i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const l=yield wt("character",{},sa);yield null==l?void 0:l.update({system:{spells:{enabled:!0}}}),yield St(l,"ability"),yield ht(),i(null==l?void 0:l.items.size).equal(1),yield null==l?void 0:l.items.contents[0].update({system:{roll:"1d6"}}),yield ht(),i(null==l?void 0:l.items.contents[0].system.roll).equal("1d6"),null===(a=null==l?void 0:l.sheet)||void 0===a||a.render(!0),yield ht(),yield t("abilities"),i(null===(s=game.messages)||void 0===s?void 0:s.size).equal(1),i(null===(n=game.messages)||void 0===n?void 0:n.contents[0].content).contain("<h2>New Actor Test Ability roll</h2>")})))),a("rolling anything else, without a formula, does nothing",(()=>e(void 0,void 0,void 0,(function*(){var e,a,s;i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0);const n=yield wt("character",{},sa);yield null==n?void 0:n.update({system:{spells:{enabled:!0}}}),yield St(n,"spell"),yield ht(),i(null==n?void 0:n.items.size).equal(1),null===(a=null==n?void 0:n.sheet)||void 0===a||a.render(!0),yield ht(),yield t("inventory"),i(null===(s=game.messages)||void 0===s?void 0:s.size).equal(0)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield gt()}))))})),t("_rollSave(event)",(()=>{const n=["death","wand","paralysis","breath","spell"],o=t=>e(void 0,void 0,void 0,(function*(){$(`li[data-save=${t}] a`).trigger("click"),yield vt(220)}));t("character can roll",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield null===(e=null==t?void 0:t.sheet)||void 0===e?void 0:e.render(!0),game.settings.set(game.system.id,"invertedCtrlBehavior",!0),yield gt(),yield vt(200)})))),n.forEach((t=>{a(`${t} save`,(()=>e(void 0,void 0,void 0,(function*(){var e,a,s;yield gt(),yield vt(200),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield o(t),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1),i(null===(s=game.messages)||void 0===s?void 0:s.contents[0].content).contain(game.i18n.format("OSE.roll.save",{save:game.i18n.localize(`OSE.saves.${t}.long`)}))}))))})),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield gt(),yield vt(200)}))))})),t("monster can roll",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("monster",{},sa);yield null===(e=null==t?void 0:t.sheet)||void 0===e?void 0:e.render(!0)})))),n.forEach((t=>{a(`${t} save`,(()=>e(void 0,void 0,void 0,(function*(){var e,a,s;yield gt(),yield vt(200),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),yield o(t),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1),i(null===(s=game.messages)||void 0===s?void 0:s.contents[0].content).contain(game.i18n.format("OSE.roll.save",{save:game.i18n.localize(`OSE.saves.${t}.long`)}))}))))})),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa),yield gt(),yield vt(200)}))))}))})),t("_rollAttack(event)",(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var e;game.settings.set(game.system.id,"invertedCtrlBehavior",!0);const t=yield wt("character",{},sa);null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield gt()})))),["melee","missile"].forEach((t=>{a(`can attack with ${t}`,(()=>e(void 0,void 0,void 0,(function*(){var a,s,n;const l=yield la();var o;i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(0),yield(o=t,e(void 0,void 0,void 0,(function*(){$(`li[data-attack=${o}] a`).trigger("click"),yield vt(200)}))),i(null===(s=game.messages)||void 0===s?void 0:s.size).equal(1),i(null===(n=game.messages)||void 0===n?void 0:n.contents[0].content).contain(game.i18n.format("OSE.roll.attacks",{name:null==l?void 0:l.name})),yield gt()}))))})),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))}));const r=(e,t)=>{var a,s,n,l;i(t.source.item).not.undefined,i(null===(a=t.source.item)||void 0===a?void 0:a.documentName).equal("Item"),i(null===(s=t.source.item)||void 0===s?void 0:s.name).equal(e),i(null===(n=t.source.item)||void 0===n?void 0:n.system.containerId).equal(""),i(null===(l=t.target.item)||void 0===l?void 0:l.system.itemIds.length).equal(0)},d=(e,t)=>{var a,s,n,l,o,r,d,u,c;i(null===(a=t.target.item)||void 0===a?void 0:a.system.itemIds.length).equal(1),i(null===(s=t.target.item)||void 0===s?void 0:s.system.itemIds).contain(null===(n=t.source.item)||void 0===n?void 0:n.id),i(null===(l=t.source.item)||void 0===l?void 0:l.system.containerId).equal(null===(o=t.target.item)||void 0===o?void 0:o.id);const m="armor"===(null===(r=t.source.item)||void 0===r?void 0:r.type)?null===(d=t.source.item)||void 0===d?void 0:d.type:`${null===(u=t.source.item)||void 0===u?void 0:u.type}s`,v="containers"===m?1:0;i(null===(c=e.actor)||void 0===c?void 0:c.system[m].length).equal(v)};t("_onContainerItemAdd(item, target)",(()=>{Dt.forEach((t=>{if("spell"===t)return;if("ability"===t)return;const n={},o={source:{},target:{}};l((()=>e(void 0,void 0,void 0,(function*(){n.actor=yield wt("character",{},sa),[o.target.item]=yield St(n.actor,"container","TargetContainer")})))),a(`add ${t} to container`,(()=>e(void 0,void 0,void 0,(function*(){var e,a;((e,t)=>{var a,s,n;i(e.actor).not.undefined,i(null===(a=e.actor)||void 0===a?void 0:a.documentName).equal("Actor"),i(t.target.item).not.undefined,i(null===(s=t.target.item)||void 0===s?void 0:s.documentName).equal("Item"),i(null===(n=t.target.item)||void 0===n?void 0:n.name).equal("TargetContainer")})(n,o),[o.source.item]=yield St(n.actor,t);const s=`New Actor Test ${t.capitalize()}`;r(s,o),yield null===(a=null===(e=n.actor)||void 0===e?void 0:e.sheet)||void 0===a?void 0:a._onContainerItemAdd(o.source.item,o.target.item),d(n,o)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))}))})),t("_onContainerItemRemove(item, container)",(()=>{Dt.forEach((t=>{if("spell"===t)return;if("ability"===t)return;const i={},n={source:{},target:{}};l((()=>e(void 0,void 0,void 0,(function*(){var e,a;i.actor=yield wt("character",{},sa),[n.target.item]=yield St(i.actor,"container","TargetContainer"),[n.source.item]=yield St(i.actor,t),yield null===(a=null===(e=i.actor)||void 0===e?void 0:e.sheet)||void 0===a?void 0:a._onContainerItemAdd(n.source.item,n.target.item)})))),a(`remove ${t} from container`,(()=>e(void 0,void 0,void 0,(function*(){var e,a;d(i,n),yield null===(a=null===(e=i.actor)||void 0===e?void 0:e.sheet)||void 0===a?void 0:a._onContainerItemRemove(n.source.item,n.target.item);const s=`New Actor Test ${t.capitalize()}`;r(s,n)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))}))})),t("_onDropItemCreate(droppedItem, targetContainer)",(()=>{Dt.forEach((t=>{if("spell"===t)return;if("ability"===t)return;const n={},o={source:{},target:{}};l((()=>e(void 0,void 0,void 0,(function*(){n.actor=yield wt("character",{},sa)})))),a(`add non-actor ${t} to sheet`,(()=>e(void 0,void 0,void 0,(function*(){var e,a,s;o.source.item=yield qt(t);const l=o.source.item.name||"test";yield null===(a=null===(e=n.actor)||void 0===e?void 0:e.sheet)||void 0===a?void 0:a._onDropItemCreate([o.source.item]),o.source.item=null===(s=n.actor)||void 0===s?void 0:s.items.getName(l),i(o.source.item).not.undefined})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))}))})),t("_chooseItemType(choices)",(()=>{const t=["weapon","armor","shield","gear"];a("can create standard dialog",(()=>e(void 0,void 0,void 0,(function*(){var e;const a=yield wt("monster",{},sa);null===(e=null==a?void 0:a.sheet)||void 0===e||e._chooseItemType(),yield ht();const s=pt();i(s.length).equal(1),t.forEach((e=>{i(s[0].data.content).contain(`<option value="${e}"`)})),yield s[0].close()})))),a("can create custom dialog",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=["test","test2","test3"],a=yield wt("monster",{},sa);null===(e=null==a?void 0:a.sheet)||void 0===e||e._chooseItemType(t),yield ht();const s=pt();i(s.length).equal(1),t.forEach((e=>{i(s[0].data.content).contain(`<option value="${e}"`)})),yield s[0].close()})))),n((()=>e(void 0,void 0,void 0,(function*(){yield ft(),yield It(sa)}))))})),t("_createItem(event)",(()=>{Dt.forEach((t=>{a(`can create ${t}`,(()=>e(void 0,void 0,void 0,(function*(){var e;const a=yield wt("character",{},sa);yield null==a?void 0:a.update({system:{spells:{enabled:!0}}}),yield null===(e=null==a?void 0:a.sheet)||void 0===e?void 0:e.render(!0),yield vt(200),i(null==a?void 0:a.items.size).equal(0),$(`.sheet .item-create[data-type="${t}"]`).trigger("click"),yield ht(),i(null==a?void 0:a.items.size).equal(1)}))))})),n((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))})),t("_updateItemQuantity(event)",(()=>{const t=(e,t)=>{e.value=String(parseInt(e.value,10)+t);const a=new InputEvent("change");e.dispatchEvent(a)};a("can add to the quantity",(()=>e(void 0,void 0,void 0,(function*(){var e;const a=yield wt("character",{},sa);null===(e=null==a?void 0:a.sheet)||void 0===e||e.render(!0);const[s]=yield St(a,"item");s.update({system:{quantity:{value:2,max:4}}}),yield ht();const n=document.querySelector(`.sheet .item[data-item-id="${s.id}"] input[data-field="value"]`);i(s.system.quantity.value).equal(2),t(n,1),yield ht(),i(s.system.quantity.value).equal(3)})))),a("can subtract from the quantity",(()=>e(void 0,void 0,void 0,(function*(){var e;const a=yield wt("character",{},sa);null===(e=null==a?void 0:a.sheet)||void 0===e||e.render(!0);const[s]=yield St(a,"item");s.update({system:{quantity:{value:2,max:4}}}),yield ht();const n=document.querySelector(`.sheet .item[data-item-id="${s.id}"] input[data-field="value"]`);i(s.system.quantity.value).equal(2),t(n,-1),yield ht(),i(s.system.quantity.value).equal(1)})))),n((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))})),t("_renderInner(...args)",(()=>{})),t("_onResize(event)",(()=>{})),t("_onConfigureActor(event)",(()=>{["character","monster"].forEach((t=>{a(`Entity Tweaks renders for ${t}`,(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},sa);yield null===(e=null==t?void 0:t.sheet)||void 0===e?void 0:e.render(!0),yield vt(300),$(".configure-actor").trigger("click"),yield vt(300);const a=yt("sheet-tweaks");i(a.length).equal(1),a[0].close()}))))})),n((()=>e(void 0,void 0,void 0,(function*(){yield It(sa)}))))})),t("_getHeaderButtons()",(()=>{}))};const ra="ose.actor.sheet.e2e.dragndrop",da={displayName:"OSE: Actor: Sheet E2E Drag'n'Drop",preSelected:!0},ua=t=>e(void 0,void 0,void 0,(function*(){var e,a;const i=new DragEvent("dragstart",{dataTransfer:new DataTransfer,bubbles:!0,cancelable:!0});null===(e=t.source.itemElement)||void 0===e||e.dispatchEvent(i);const s=new DragEvent("drop",{dataTransfer:i.dataTransfer,bubbles:!0,cancelable:!0});null===(a=t.target.itemElement)||void 0===a||a.dispatchEvent(s)}));var ca=({describe:t,it:a,expect:i,after:s,afterEach:n,beforeEach:l})=>{t("_onDragStart(event)",(()=>{a("populates dataTransfer correctly",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},ra);i(t).not.undefined,yield null===(e=t.sheet)||void 0===e?void 0:e.render(!0);const[a]=yield St(t,"weapon");i(a).not.undefined,yield ht();const s=document.querySelector(`.sheet .inventory li.item[data-item-id="${null==a?void 0:a.id}"]`);i(s).not.null;const n=(e=>{const t=new DragEvent("dragstart",{dataTransfer:new DataTransfer,bubbles:!0,cancelable:!0});return null==e||e.dispatchEvent(t),t})(s),l=TextEditor.getDragEventData(n);i(Object.keys(l)).contain("item")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ra)}))))})),t("_onDropItem(event, data)",(()=>{})),t("_onDragStart(event, data) & _onDrop(event, data) - Containers",(()=>{const s=(e,t)=>{var a,s,n,l,o;i(e.actor).not.undefined,i(null===(a=e.actor)||void 0===a?void 0:a.documentName).equal("Actor"),i(e.compendium).not.undefined,i(null===(s=e.compendium)||void 0===s?void 0:s.documentName).equal("Item"),i(t.target.item).not.undefined,i(null===(n=t.target.item)||void 0===n?void 0:n.documentName).equal("Item"),i(null===(l=t.target.item)||void 0===l?void 0:l.name).equal("TargetContainer"),i(t.target.itemElement).not.null,i(null===(o=t.target.itemElement)||void 0===o?void 0:o.constructor.name).equal("HTMLLIElement")},o=(e,t)=>{var a,s,n,l,o;i(t.source.item).not.undefined,i(null===(a=t.source.item)||void 0===a?void 0:a.documentName).equal("Item"),i(null===(s=t.source.item)||void 0===s?void 0:s.name).equal(e),i(t.source.itemElement).not.null,i(null===(n=t.source.itemElement)||void 0===n?void 0:n.constructor.name).equal("HTMLLIElement"),i(null===(l=t.source.item)||void 0===l?void 0:l.system.containerId).equal(""),i(null===(o=t.target.item)||void 0===o?void 0:o.system.itemIds.length).equal(0)},r=(e,t)=>{var a,s,n,l,o,r,d,u,c;i(null===(a=t.target.item)||void 0===a?void 0:a.system.itemIds.length).equal(1),i(null===(s=t.target.item)||void 0===s?void 0:s.system.itemIds).contain(null===(n=t.source.item)||void 0===n?void 0:n.id),i(null===(l=t.source.item)||void 0===l?void 0:l.system.containerId).equal(null===(o=t.target.item)||void 0===o?void 0:o.id);const m="armor"===(null===(r=t.source.item)||void 0===r?void 0:r.type)?null===(d=t.source.item)||void 0===d?void 0:d.type:`${null===(u=t.source.item)||void 0===u?void 0:u.type}s`,v="containers"===m?1:0;i(null===(c=e.actor)||void 0===c?void 0:c.system[m].length).equal(v)};a("Issue#357 Dragging container onto itself should retain container in inventory",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n,l,r,d,u,c,m,v;const g={source:{},target:{}},h=yield wt("character",{},ra);[g.target.item]=yield St(h,"container","TargetContainer"),[g.source.item]=yield St(h,"weapon"),null===(e=null==h?void 0:h.sheet)||void 0===e||e.render(!0),yield ht(),g.source.itemElement=document.querySelector(`.sheet .inventory li.item[data-item-id="${null===(a=null===(t=g.source)||void 0===t?void 0:t.item)||void 0===a?void 0:a.id}"]`),g.target.itemElement=document.querySelector(`.sheet .inventory li.item[data-item-id="${null===(n=null===(s=g.target)||void 0===s?void 0:s.item)||void 0===n?void 0:n.id}"]`),o("New Actor Test Weapon",g),yield ua(g),yield ht(),i(null===(l=g.target.item)||void 0===l?void 0:l.system.itemIds.length).equal(1),i(null===(r=g.target.item)||void 0===r?void 0:r.system.itemIds).contain(null===(d=g.source.item)||void 0===d?void 0:d.id),i(null===(u=g.source.item)||void 0===u?void 0:u.system.containerId).equal(null===(c=g.target.item)||void 0===c?void 0:c.id),g.source.itemElement=g.target.itemElement,g.source.item=g.target.item,yield ua(g),yield ht();const y=document.querySelector(`.sheet .inventory li.item[data-item-id="${null===(v=null===(m=g.target)||void 0===m?void 0:m.item)||void 0===v?void 0:v.id}"]`);i(y).not.null})))),Dt.forEach((i=>{if("spell"===i)return;if("ability"===i)return;const d={},u={source:{},target:{}};t(`manipulating ${i} item type`,(()=>{l((()=>e(void 0,void 0,void 0,(function*(){var t,a,i,s;d.actor=yield wt("character",{},ra),d.compendium=yield(t=>e(void 0,void 0,void 0,(function*(){return CompendiumCollection.createCompendium({label:"Test Compendium",name:"testcompendium",type:t,path:"",private:!1,package:"world"})})))("Item"),[u.target.item]=yield St(d.actor,"container","TargetContainer"),null===(a=null===(t=d.actor)||void 0===t?void 0:t.sheet)||void 0===a||a.render(!0),null===(i=d.compendium)||void 0===i||i.render(!0),yield ht(),u.target.itemElement=document.querySelector(`.sheet .inventory li.item[data-item-id="${null===(s=u.target.item)||void 0===s?void 0:s.id}"]`)})))),a(`drag ${i} from actor sheet into a container in a character sheet`,(()=>e(void 0,void 0,void 0,(function*(){var e;s(d,u),[u.source.item]=yield St(d.actor,i),yield ht(),u.source.itemElement=document.querySelector(`.sheet .inventory li.item[data-item-id="${null===(e=u.source.item)||void 0===e?void 0:e.id}"]`);const t=`New Actor Test ${i.capitalize()}`;o(t,u),yield ua(u),yield ht(),r(d,u)})))),a(`drag ${i} from item sidebar into a container in a character sheet`,(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;s(d,u),u.source.item=yield qt(i),yield ht(),u.source.itemElement=document.querySelector(`.sidebar-tab[data-tab="items"] li.item[data-document-id="${null===(e=u.source.item)||void 0===e?void 0:e.id}"]`);const n=`New World Test ${i.capitalize()}`;o(n,u),yield ua(u),yield ht(),u.source.item=null===(t=d.actor)||void 0===t?void 0:t.items.getName(null===(a=u.source.item)||void 0===a?void 0:a.name),r(d,u)})))),a(`drag ${i} from compendium into a container in a character sheet`,(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,n;s(d,u);const l=yield qt(i);u.source.item=yield null===(e=d.compendium)||void 0===e?void 0:e.importDocument(l),yield ht(),u.source.itemElement=document.querySelector(`.compendium li.item[data-document-id="${null===(t=u.source.item)||void 0===t?void 0:t.id}"]`);const c=`New World Test ${i.capitalize()}`;o(c,u),yield ua(u),yield ht(),u.source.item=null===(a=d.actor)||void 0===a?void 0:a.items.getName(null===(n=u.source.item)||void 0===n?void 0:n.name),r(d,u)})))),n((()=>e(void 0,void 0,void 0,(function*(){yield It(ra),yield e(void 0,void 0,void 0,(function*(){var e;return null===(e=game.packs.get("world.testcompendium"))||void 0===e?void 0:e.deleteCompendium()})),yield Ct()}))))}))}))}))};const ma="ose.actor.sheet.character",va={displayName:"OSE: Actor: Sheet: Character"};var ga=({describe:t,it:a,expect:i,after:s,afterEach:n})=>{s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma),yield bt()})))),t("defaultOptions()",(()=>{a("Has correctly set defaultOptions",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("character",{},ma),t=null==e?void 0:e.sheet;i(t.options.classes).contain("ose"),i(t.options.classes).contain("sheet"),i(t.options.classes).contain("actor"),i(t.options.classes).contain("character"),i(t.options.template).contain("/templates/actors/character-sheet.html"),i(t.options.width).equal(450),i(t.options.height).equal(530),i(t.options.resizable).is.true,i(t.options.tabs.length).equal(1),i(Object.keys(t.options.tabs[0])).contain("navSelector"),i(t.options.tabs[0].navSelector).equal(".sheet-tabs"),i(Object.keys(t.options.tabs[0])).contain("contentSelector"),i(t.options.tabs[0].contentSelector).equal(".sheet-body"),i(Object.keys(t.options.tabs[0])).contain("initial"),i(t.options.tabs[0].initial).equal("attributes"),i(t.options.scrollY.length).equal(1),i(t.options.scrollY[0]).equal(".inventory")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma)}))))})),t("_prepareItems(data)",(()=>{})),t("generateScores()",(()=>{const t={str:0,int:0,dex:0,wis:0,con:0,cha:0};a("renders the character creator",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("character",{},ma);(null==e?void 0:e.sheet).generateScores(),yield ht();const t=yt("creator");i(t.length).equal(1)})))),a("clicking on the dices generates scores",(()=>e(void 0,void 0,void 0,(function*(){const a=yield wt("character",{},ma);(null==a?void 0:a.sheet).generateScores(),yield vt(400);const s=yt("creator");i(s.length).equal(1),Object.keys(t).forEach((t=>e(void 0,void 0,void 0,(function*(){$(`.creator div[data-score="${t}"] a.score-roll`).trigger("click"),yield ht();const e=document.querySelector(`.creator div[data-score="${t}"] input.score-value`),{value:a}=e;i(parseInt(a,10)>0).equal(!0)}))))})))),a("saving scores records data to actor",(()=>e(void 0,void 0,void 0,(function*(){const a=yield wt("character",{},ma);(null==a?void 0:a.sheet).generateScores(),yield vt(400);const s=yt("creator");i(s.length).equal(1),Object.keys(t).forEach((a=>e(void 0,void 0,void 0,(function*(){$(`.creator div[data-score="${a}"] a.score-roll`).trigger("click"),yield ht();const e=document.querySelector(`.creator div[data-score="${a}"] input.score-value`),{value:s}=e;i(parseInt(s,10)>0).equal(!0),t[a]=parseInt(s,10)})))),$(".creator footer button").trigger("submit"),yield ht(),i(null==a?void 0:a.system.scores.str.value).equal(t.str),i(null==a?void 0:a.system.scores.dex.value).equal(t.dex),i(null==a?void 0:a.system.scores.wis.value).equal(t.wis),i(null==a?void 0:a.system.scores.int.value).equal(t.int),i(null==a?void 0:a.system.scores.con.value).equal(t.con),i(null==a?void 0:a.system.scores.cha.value).equal(t.cha)})))),n((()=>e(void 0,void 0,void 0,(function*(){yield gt(),yield It(ma);yt("creator").forEach((e=>e.close())),yield vt(300)}))))})),t("getData()",(()=>{a("returns the expected data",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},ma),a=yield null===(e=null==t?void 0:t.sheet)||void 0===e?void 0:e.getData();i(Object.keys(a)).contain("enrichedBiography"),i(Object.keys(a)).contain("enrichedNotes"),i(Object.keys(a)).contain("owned"),i(Object.keys(null==a?void 0:a.owned)).contain("weapons"),i(Object.keys(null==a?void 0:a.owned)).contain("items"),i(Object.keys(null==a?void 0:a.owned)).contain("containers"),i(Object.keys(null==a?void 0:a.owned)).contain("armors"),i(Object.keys(null==a?void 0:a.owned)).contain("treasures"),i(Object.keys(a)).contain("containers"),i(Object.keys(a)).contain("abilities"),i(Object.keys(a)).contain("spells"),i(Object.keys(a)).contain("slots"),i(Object.keys(a)).contain("system"),i(Object.keys(null==a?void 0:a.system)).contain("usesAscendingAC"),i(Object.keys(null==a?void 0:a.system)).contain("meleeMod"),i(Object.keys(null==a?void 0:a.system)).contain("rangedMod"),i(Object.keys(null==a?void 0:a.system)).contain("init")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma)}))))})),t("_chooseLang()",(()=>{a("renders a dialog",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},ma);null===(e=null==t?void 0:t.sheet)||void 0===e||e._chooseLang(),yield ht();const a=pt();i(a.length).equal(1),a[0].close()})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma),yield ft(),yield vt(300)}))))})),t("_pushLang(table)",(()=>{const t="languages";a("renders a dialog",(()=>e(void 0,void 0,void 0,(function*(){var e;const a=yield wt("character",{},ma);null===(e=null==a?void 0:a.sheet)||void 0===e||e._pushLang(t),yield ht();const s=pt();i(s.length).equal(1),s[0].close()})))),a("adds language on OK",(()=>e(void 0,void 0,void 0,(function*(){var e;const a=yield wt("character",{},ma);null===(e=null==a?void 0:a.sheet)||void 0===e||e._pushLang(t),yield vt(220),$("button.ok").trigger("click"),yield vt(500);const s=pt();i(s.length).equal(0),i(null==a?void 0:a.system.languages.value.length).equal(1),i(null==a?void 0:a.system.languages.value[0]).equal("Common")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma),yield ft()}))))})),t("_popLang(table, lang)",(()=>{a("can remove added language",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},ma);yield null==t?void 0:t.update({"system.languages.value":["Common"]}),yield ht(),i(null==t?void 0:t.system.languages.value.length).equal(1),i(null==t?void 0:t.system.languages.value[0]).equal("Common"),null===(e=null==t?void 0:t.sheet)||void 0===e||e._popLang("languages","Common"),yield ht(),i(null==t?void 0:t.system.languages.value.length).equal(0)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma)}))))})),t("_onShowModifiers(event)",(()=>{a("renders a dialog",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},ma);yield null==t?void 0:t.update({system:{scores:{str:{value:10},dex:{value:10},int:{value:10},con:{value:10},wis:{value:10},cha:{value:10}}}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield ht(),$(".sheet .profile a[data-action=modifiers]").trigger("click"),yield vt(200);const a=pt();i(a.length).equal(1)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma),yield ft(),yield vt(400)}))))})),t("_onShowGpCost(event, preparedData)",(()=>{a("renders a dialog",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("character",{},ma);yield null==t?void 0:t.update({system:{scores:{str:{value:10},dex:{value:10},int:{value:10},con:{value:10},wis:{value:10},cha:{value:10}}}}),null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield ht(),$(".sheet .profile a[data-action=gp-cost]").trigger("click"),yield vt(200);const a=pt();i(a.length).equal(1)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ma),yield ft(),yield vt(400)}))))})),t("_onShowItemTooltip(event)",(()=>{}))};const ha="ose.actor.sheet.monster",ya={displayName:"OSE: Actor: Sheet: Monster"};var pa=({describe:t,it:a,expect:i,after:s,before:n})=>{const l=game.settings.get(game.system.id,"invertedCtrlBehavior");s((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"invertedCtrlBehavior",l),yield It(ha),yield bt()})))),t("defaultOptions()",(()=>{a("Has correctly set defaultOptions",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wt("monster",{},ha),t=null==e?void 0:e.sheet;i(t.options.classes).contain("ose"),i(t.options.classes).contain("sheet"),i(t.options.classes).contain("actor"),i(t.options.classes).contain("monster"),i(t.options.template).contain("/templates/actors/monster-sheet.html"),i(t.options.width).equal(450),i(t.options.height).equal(560),i(t.options.resizable).is.true,i(t.options.tabs.length).equal(1),i(Object.keys(t.options.tabs[0])).contain("navSelector"),i(t.options.tabs[0].navSelector).equal(".tabs"),i(Object.keys(t.options.tabs[0])).contain("contentSelector"),i(t.options.tabs[0].contentSelector).equal(".sheet-body"),i(Object.keys(t.options.tabs[0])).contain("initial"),i(t.options.tabs[0].initial).equal("attributes")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ha)}))))})),t("_prepareItems(data)",(()=>{})),t("getData()",(()=>{a("returns the expected data",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("monster",{},ha),a=yield null===(e=null==t?void 0:t.sheet)||void 0===e?void 0:e.getData();i(Object.keys(a)).contain("owned"),i(Object.keys(null==a?void 0:a.owned)).contain("weapons"),i(Object.keys(null==a?void 0:a.owned)).contain("items"),i(Object.keys(null==a?void 0:a.owned)).contain("containers"),i(Object.keys(null==a?void 0:a.owned)).contain("armors"),i(Object.keys(null==a?void 0:a.owned)).contain("treasures"),i(Object.keys(a)).contain("attackPatterns"),i(Object.keys(a)).contain("spells"),i(Object.keys(a)).contain("isNew"),i(null==a?void 0:a.config.morale).equal(game.settings.get(game.system.id,"morale")),i(Object.keys(a)).contain("system"),i(Object.keys(null==a?void 0:a.system)).contain("details"),i(Object.keys(null==a?void 0:a.system.details)).contain("treasure"),i(Object.keys(null==a?void 0:a.system.details.treasure)).contain("link")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ha)}))))})),t("generateSave()",(()=>{a("renders a dialog",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("monster",{},ha);null===(e=null==t?void 0:t.sheet)||void 0===e||e.generateSave(),yield ht();const a=pt();i(a.length).equal(1),a[0].close()})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ha),yield ft(),yield vt(300)}))))})),t("_onDrop(event)",(()=>{s((()=>e(void 0,void 0,void 0,(function*(){var e;yield It(ha),null===(e=game.tables)||void 0===e||e.filter((e=>"Test RollTable"===e.name)).forEach((e=>e.delete()))})))),a("Can drag testing RollTable to Monster",(()=>e(void 0,void 0,void 0,(function*(){var t,a;const s=yield wt("monster",{},ha),n=yield e(void 0,void 0,void 0,(function*(){return RollTable.create({name:"Test RollTable"})}));null===(t=null==s?void 0:s.sheet)||void 0===t||t.render(!0),yield vt(300);const l=document.querySelector(`.tab li[data-document-id=${null==n?void 0:n.id}]`),o=document.querySelector(".monster .window-content");i(l).not.null,i(o).not.null;const r=new DragEvent("dragstart",{dataTransfer:new DataTransfer,bubbles:!0,cancelable:!0});null==l||l.dispatchEvent(r),null===(a=null==s?void 0:s.sheet)||void 0===a||a._onDrop(r),yield ht(),i(null==s?void 0:s.system.details.treasure.table).equal(`@UUID[RollTable.${null==n?void 0:n.id}]`)}))))})),t("_resetAttacks(event)",(()=>{a("resets the counter to max",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("monster",{},ha);null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0);const[a]=yield St(t,"weapon");a.update({system:{counter:{max:4,value:1}}}),yield vt(400),i(a.system.counter.value).equal(1),$(".item-reset").trigger("click"),yield ht(),i(a.system.counter.value).equal(4)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ha)}))))})),t("_updateAttackCounter(event)",(()=>{n((()=>{game.settings.set(game.system.id,"invertedCtrlBehavior",!0)})),a("updates counter when rolling",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("monster",{},ha);null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0);const[a]=yield St(t,"weapon");a.update({system:{counter:{max:4,value:4}}}),yield vt(400),i(a.system.counter.value).equal(4),$(`.tab .item[data-item-id="${a.id}"] .item-image`).trigger("click"),yield ht(),i(a.system.counter.value).equal(3)})))),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ha)}))))})),t("_cycleAttackPatterns(event)",(()=>{const l=Object.keys(CONFIG.OSE.colors);l.push("transparent"),n((()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wt("monster",{},ha);null===(e=null==t?void 0:t.sheet)||void 0===e||e.render(!0),yield St(t,"weapon"),yield vt(300)})))),t("properly cycles between colors",(()=>{l.forEach((t=>{a(`works for color ${t}`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield Et(ha),t=null==e?void 0:e.items.contents[0],a=null==t?void 0:t.system.pattern;i(a).not.undefined;const s=l.indexOf(a),n=s+1===l.length?0:s+1;$(".item-pattern").trigger("click"),yield vt(200),i(null==t?void 0:t.system.pattern).equal(l[n])}))))}))})),s((()=>e(void 0,void 0,void 0,(function*(){yield It(ha)}))))}))};const fa="ose.actor.sheet.character.dialog.modifiers",ba={displayName:"OSE: Actor: Dialog Sheet: Character Modifiers"},wa=(t,a={})=>e(void 0,void 0,void 0,(function*(){return wt(t,a,fa)}));var qa=({describe:t,it:a,expect:i,assert:s,after:n})=>{t("defaultOptions()",(()=>{a("Has correctly set defaultOptions",(()=>{const e=new j;i(e.options.id).equal("sheet-modifiers"),i(e.options.classes).contain("ose"),i(e.options.classes).contain("dialog"),i(e.options.classes).contain("modifiers"),i(e.options.template).contain("/templates/actors/dialogs/modifiers-dialog.html"),i(e.options.width).equal(240)}))})),t("title()",(()=>{a("Creates string in dialog window title",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield wa("character");new j(t).render(!0),yield ht();const a=null===(e=document.querySelector("div.modifiers .window-title"))||void 0===e?void 0:e.innerHTML;i(typeof a).equal("string");const s=yt("modifiers");i(s.length).equal(1),yield s[0].close(),i(yt("modifiers").length).equal(0)}))))})),t("getData()",(()=>{a("Returns proper data",(()=>e(void 0,void 0,void 0,(function*(){const e=yield wa("character"),t=new j(e).getData(),a=Object.keys(t);s(a.length>0),i(a).contain("user")}))))})),n((()=>e(void 0,void 0,void 0,(function*(){yield It(fa)}))))};const Sa="ose.actor.sheet.dialog.entity-tweaks",Oa={displayName:"OSE: Actor: Dialog Sheet: Entity Tweaks"},ka=(t,a={})=>e(void 0,void 0,void 0,(function*(){return wt(t,a,Sa)}));var Ea=({describe:t,it:a,expect:i,assert:s,after:n})=>{t("defaultOptions()",(()=>{a("Has correctly set defaultOptions",(()=>{const e=new z;i(e.options.id).equal("sheet-tweaks"),i(e.options.classes).contain("sheet-tweaks"),i(e.options.template).contain("/templates/actors/dialogs/tweaks-dialog.html"),i(e.options.width).equal(380)}))})),t("title()",(()=>{a("Creates string in dialog window title",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield ka("character");new z(t).render(!0),yield ht();const a=null===(e=document.querySelector("div.sheet-tweaks .window-title"))||void 0===e?void 0:e.innerHTML;i(typeof a).equal("string");const s=yt("sheet-tweaks");i(s.length).equal(1),yield s[0].close(),i(yt("sheet-tweaks").length).equal(0)}))))})),t("getData()",(()=>{a("Returns proper data",(()=>e(void 0,void 0,void 0,(function*(){const e=yield ka("character"),t=new z(e).getData(),a=Object.keys(t);s(a.length>=2),i(a).contain("config"),i(a).contain("user"),s(t.isCharacter)}))))})),t("_updateObject(event, formData)",(()=>{})),n((()=>e(void 0,void 0,void 0,(function*(){yield It(Sa)}))))};const Ta={displayName:"OSE: Item: Data Model: Ability"};var Ia=({describe:e,it:t,expect:a})=>{e("manualTags",(()=>{const e=new We;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags",(()=>{const e=new We;t("By default return auto-tags",(()=>{a(e.autoTags.length).equal(1),a(Object.keys(e.autoTags[0]).length).equal(1)})),t("By default return empty label",(()=>{a(e.autoTags[0].label).equal("")})),t("By default return tshirt icon",(()=>{a(e.autoTags[0].icon).is.undefined})),t("Requirements create autoTags",(()=>{e.requirements="magic-user,slow",a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(1),a(e.autoTags[0].label).equal("magic-user"),a(Object.keys(e.autoTags[1]).length).equal(1),a(e.autoTags[1].label).equal("slow")})),t("Save create autoTags",(()=>{e.save="death",a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[2]).length).equal(2),a(e.autoTags[2].label).equal(game.i18n.localize("OSE.saves.death.long")),a(e.autoTags[2].icon).equal("fa-skull")})),t("Roll create autoTags",(()=>{e.roll="1d20+1",a(e.autoTags.length).equal(4),a(Object.keys(e.autoTags[3]).length).equal(2),a(e.autoTags[2].label).equal(`${game.i18n.localize("OSE.items.Roll")} 1d20+1 undefinednull`)}))}))};const Ca={displayName:"OSE: Item: Data Model: Armor"};var Aa=({describe:e,it:t,expect:a})=>{e("ArmorTypes",(()=>{const e=Be.ArmorTypes;t("Has 4 armor types",(()=>{a(Object.keys(e).length).equal(4)})),t("Has unarmored",(()=>{a(e.unarmored).equal("OSE.armor.unarmored")})),t("Has light",(()=>{a(e.light).equal("OSE.armor.light")})),t("Has heavy",(()=>{a(e.heavy).equal("OSE.armor.heavy")})),t("Has shield",(()=>{a(e.shield).equal("OSE.armor.shield")}))})),e("manualTags",(()=>{const e=new Be;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.manualTags[0].label).equal("value")}))})),e("autoTags",(()=>{const e=new Be;t("By default return auto-tags",(()=>{a(e.autoTags.length).equal(1),a(Object.keys(e.autoTags[0]).length).equal(2)})),t("By default return light armor",(()=>{a(e.autoTags[0].label).equal("OSE.armor.light")})),t("By default return tshirt icon",(()=>{a(e.autoTags[0].icon).equal("fa-tshirt")}))}))};const Da={displayName:"OSE: Item: Data Model: Container"};var Ma=({describe:e,it:t,expect:a})=>{e("contents()",(()=>{t("Returns null if itemIds is empty Array",(()=>{const e=new Ue;a(e.contents).is.null}))})),e("totalWeight()",(()=>{t("Returns 0 with no items",(()=>{const e=new Ue;a(e.totalWeight).equal(0)}))})),e("manualTags()",(()=>{const e=new Ue;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{value:"value",title:"title"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags()",(()=>{const e=new Ue;t("By default return no auto-tags",(()=>{a(e.autoTags.length).equal(0)})),t("Can create autoTags",(()=>{e.tags=[{value:CONFIG.OSE.tags.blunt}],a(e.tags.length).equal(1),a(e.autoTags[0].label).equal(CONFIG.OSE.tags.blunt),a(e.autoTags[0].icon).equal("fa-hammer-crash"),a(e.autoTags[0].image).equal(`${CONFIG.OSE.assetsPath}/blunt.png`)}))}))};const Fa={displayName:"OSE: Item: Data Model: Misc"};var $a=({describe:e,it:t,expect:a})=>{e("manualTags()",(()=>{const e=new Ke;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags()",(()=>{const e=new Ke;t("By default return no auto-tags",(()=>{a(e.autoTags.length).equal(0)})),t("Can create autoTags",(()=>{e.tags=[{value:CONFIG.OSE.tags.blunt}],a(e.tags.length).equal(1),a(e.autoTags[0].label).equal(CONFIG.OSE.tags.blunt),a(e.autoTags[0].icon).equal("fa-hammer-crash"),a(e.autoTags[0].image).equal(`${CONFIG.OSE.assetsPath}/blunt.png`)}))}))};const _a={displayName:"OSE: Item: Data Model: Spell"};var Na=({describe:e,it:t,expect:a})=>{e("manualTags()",(()=>{const e=new Ve;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.tags[0].label).is.undefined}))})),e("autoTags()",(()=>{const e=new Ve;t("By default return 3 auto-tags",(()=>{a(e.autoTags.length).equal(3),e.autoTags.forEach((e=>{a(e).not.null,a(null==e?void 0:e.label).equal("")}))})),t("Save create autoTags",(()=>{e.save="death",a(e.autoTags.length).equal(4),a(Object.keys(e.autoTags[3]).length).equal(2),a(e.autoTags[3].label).equal(game.i18n.localize("OSE.saves.death.long")),a(e.autoTags[3].icon).equal("fa-skull")})),t("Roll create autoTags",(()=>{e.roll="1d20+1",a(e.autoTags.length).equal(5),a(Object.keys(e.autoTags[3]).length).equal(1),a(e.autoTags[3].label).equal(`${game.i18n.localize("OSE.items.Roll")} 1d20+1`)}))}))};const xa={displayName:"OSE: Item: Data Model: Weapon"};var ja=({describe:e,it:t,expect:a})=>{e("manualTags()",(()=>{const e=new Ye;t("By default return empty array",(()=>{a(e.manualTags.length).equal(0)})),t("Can write tags to tags field",(()=>{e.tags=[{title:"title",value:"value"}],a(e.tags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.tags[0].title).equal("title"),a(e.tags[0].value).equal("value"),a(e.tags[0].label).is.undefined})),t("Can retrieve tags",(()=>{a(e.manualTags.length).equal(1),a(Object.keys(e.tags[0]).length).equal(2),a(e.manualTags[0].title).equal("title"),a(e.manualTags[0].value).equal("value"),a(e.manualTags[0].label).is.undefined}))})),e("qualities()",(()=>{t("By default returns an empty array",(()=>{const e=new Ye;a(e.qualities.length).equal(0)})),t("Given a manual tag, it returns an array containing said tag",(()=>{const e=new Ye;e.tags=[{value:"slow",label:"slow"}],a(e.qualities.length).equal(1),a(Object.keys(e.qualities[0]).length).equal(2),a(e.qualities[0].label).equal(e.manualTags[0].label),a(e.qualities[0].value).equal(e.manualTags[0].value)})),t("Given a autoTag, it returns an array containing said autoTag",(()=>{const e=new Ye;e.slow=!0,a(e.qualities.length).equal(1),a(Object.keys(e.qualities[0]).length).equal(4),a(e.qualities[0].label).equal("Slow"),a(e.qualities[0].title).equal("Slow"),a(e.qualities[0].icon).equal("fa-weight-hanging"),a(e.qualities[0].image).contain("assets/slow.png")}))})),e("autotags()",(()=>{t("Returns an flattened array with damage and autotags",(()=>{const e=new Ye;a(e.autoTags.length).equal(1),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal("")})),t("Damage is present in flattened array",(()=>{const e=new Ye;e.damage="1d13",a(e.autoTags.length).equal(1),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal("1d13")})),t("A melee tag is returned as expected",(()=>{const e=new Ye;e.melee=!0,a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(3),a(e.autoTags[1].label).equal("Melee"),a(e.autoTags[1].icon).equal("fa-sword"),a(e.autoTags[1].image).contain("assets/melee.png")})),t("A missile tag is returned as expected",(()=>{const e=new Ye;e.missile=!0,a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(3),a(e.autoTags[1].label).equal("Missile"),a(e.autoTags[1].icon).equal("fa-bow-arrow"),a(e.autoTags[1].image).contain("assets/missile.png"),a(Object.keys(e.autoTags[2]).length).equal(2),a(e.autoTags[2].label).equal("0/0/0"),a(e.autoTags[2].icon).equal("fa-bullseye")})),t("A missile tag with ranges is returned as expected",(()=>{const e=new Ye;e.missile=!0,e.range.short=30,e.range.medium=60,e.range.long=90,a(e.autoTags.length).equal(3),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(3),a(e.autoTags[1].label).equal("Missile"),a(e.autoTags[1].icon).equal("fa-bow-arrow"),a(e.autoTags[1].image).contain("assets/missile.png"),a(Object.keys(e.autoTags[2]).length).equal(2),a(e.autoTags[2].label).equal("30/60/90"),a(e.autoTags[2].icon).equal("fa-bullseye")})),t("A slow tag is returned as expected",(()=>{const e=new Ye;e.slow=!0,a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(3),a(e.autoTags[1].label).equal("Slow"),a(e.autoTags[1].icon).equal("fa-weight-hanging"),a(e.autoTags[1].image).contain("assets/slow.png")})),t("A save tag is returned as expected",(()=>{const e=new Ye;e.save="death",a(e.autoTags.length).equal(2),a(Object.keys(e.autoTags[0]).length).equal(2),a(e.autoTags[0].icon).equal("fa-tint"),a(e.autoTags[0].label).equal(""),a(Object.keys(e.autoTags[1]).length).equal(2),a(e.autoTags[1].label).equal(game.i18n.localize("OSE.saves.death.long")),a(e.autoTags[1].icon).equal("fa-skull")}))}))};const Ra={displayName:"OSE: Item: Entity"},za=(t={})=>e(void 0,void 0,void 0,(function*(){return wt("character",t,"ose.item.entity")}));var Pa=({describe:t,it:a,expect:i,after:s,beforeEach:n,assert:l})=>{const o=new Set(["spell","ability","armor","weapon","item","container"]),{defaultIcons:r}=ze;s((()=>e(void 0,void 0,void 0,(function*(){Ct()})))),t("defaultIcons()",(()=>{a("There are 6 default icons",(()=>i(Object.keys(r).length).equal(6))),o.forEach((e=>{a(`Has ${e} icon`,(()=>i(r[e]).is.not.undefined))})),a("Asking for other items return null",(()=>i(r.non_existing).is.undefined))})),t("create()",(()=>{const t=t=>e(void 0,void 0,void 0,(function*(){var e;const a=yield qt(t);i(a).is.not.undefined,i(null==a?void 0:a.img).equals(r[t]);const s=null==a?void 0:a.name;yield null==a?void 0:a.delete(),i(null===(e=game.items)||void 0===e?void 0:e.find((e=>e.name===s))).is.undefined}));a("Can create weapon OseItem",(()=>e(void 0,void 0,void 0,(function*(){yield t("weapon")})))),a("Can create armor OseItem",(()=>e(void 0,void 0,void 0,(function*(){yield t("armor")})))),a("Can create item OseItem",(()=>e(void 0,void 0,void 0,(function*(){yield t("item")})))),a("Can create spell OseItem",(()=>e(void 0,void 0,void 0,(function*(){yield t("spell")})))),a("Can create ability OseItem",(()=>e(void 0,void 0,void 0,(function*(){yield t("ability")})))),a("Can create container OseItem",(()=>e(void 0,void 0,void 0,(function*(){yield t("container")}))))})),t("prepareData()",(()=>{})),t("prepareDerivedData()",(()=>{a("has the expected fields",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt(type);i(null==e?void 0:e.system.enrichedDescription).not.undefined,yield null==e?void 0:e.delete()}))))})),t("chatListeners(html)",(()=>{a("Correctly binds _onChatCardAction to element",(()=>{})),a("Correctly binds _onChatCardToggleContent to element",(()=>{}))})),t("getChatData(htmlOptions)",(()=>{a("Weapon with tags correctly stored in item.system.properties",(()=>{})),a("Spell stores class, level, range, and duration in item.system.properties",(()=>{})),a('Equipped item stores "Equipped" in item.system.properties',(()=>{})),a("Properly returns itemData",(()=>{}))})),t("rollWeapon(options)",(()=>{a("Actor with melee & missile weapon renders dialog",(()=>e(void 0,void 0,void 0,(function*(){const e=yield za();yield St(e,"weapon");const t=null==e?void 0:e.items.contents[0];yield null==t?void 0:t.update({system:{melee:!0,missile:!0}});const a=t.rollWeapon();yield ht(),yield e.delete(),i(pt().length).equal(1),l(a),yield ft(),yield ht(),yield ht(),yield ht(),i(pt().length).equal(0)})))),a("Actor with weapon with ",(()=>e(void 0,void 0,void 0,(function*(){const e=yield za();yield St(e,"weapon");const t=null==e?void 0:e.items.contents[0];yield null==t?void 0:t.update({system:{missile:!0,melee:!1}});const a=t.rollWeapon();yield e.delete(),l(a)}))))})),t("rollFormula(options)",(()=>{a("Missing item.system.roll throws error",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("item");try{yield e.rollFormula()}catch(e){i(e.name).equal("Error")}})))),a("Casting a spell trigger a dialog",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("spell");yield e.update({system:{roll:"1d20+12"}}),yield e.rollFormula(),yield ht(),yield ht(),yield ht(),i(pt().length).equal(1),yield ft(),yield gt()})))),a("A OseDice.Roll is returned from method",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("spell");yield e.update({system:{roll:"1d20+12"}});const t=yield e.rollFormula();l(t instanceof Roll)}))))})),t("spendSpell()",(()=>{a("Calling using non-spell item throws an error",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");try{yield e.spendSpell()}catch(e){i(e.name).equal("Error")}})))),a("Calling function reduces item.system.cast by one",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield qt("spell");yield t.update({system:{cast:3}}),yield t.spendSpell(),i(null===(e=null==t?void 0:t.system)||void 0===e?void 0:e.cast).equal(2)}))))})),t("_getRollTag(data)",(()=>{a("Data provided without a roll key returns void",(()=>e(void 0,void 0,void 0,(function*(){const e=(yield qt("weapon"))._getRollTag({});i(e).to.be.undefined})))),a("Returns ab object with value containing roll-info",(()=>e(void 0,void 0,void 0,(function*(){const e=(yield qt("weapon"))._getRollTag({roll:"1d12+4"});i(e).not.to.be.undefined,i(null==e?void 0:e.label).equal("Roll 1d12+4")}))))})),t("_getSaveTag(data)",(()=>{a("Data provided without a save key returns void",(()=>e(void 0,void 0,void 0,(function*(){const e=(yield qt("weapon"))._getSaveTag({});i(e).to.be.undefined})))),a("Returns an object with two keys; label and icon",(()=>e(void 0,void 0,void 0,(function*(){const e=(yield qt("weapon"))._getSaveTag({save:"death"});i(e).not.to.be.undefined,i(null==e?void 0:e.label).equal("Death Poison"),i(null==e?void 0:e.icon).equal("fa-skull")}))))})),t("pushManualTag(values)",(()=>{const t=(t,a,s)=>e(void 0,void 0,void 0,(function*(){var e,n,l,o;i(null===(e=null==t?void 0:t.system)||void 0===e?void 0:e.tags.length).equal(0),yield null==t?void 0:t.pushManualTag([a]),i(null===(n=null==t?void 0:t.system)||void 0===n?void 0:n.tags.length).equal(1);const r=null===(o=null===(l=null==t?void 0:t.system)||void 0===l?void 0:l.tags)||void 0===o?void 0:o.pop();i(r.label).equal(s.label),i(r.title).equal(s.title),i(r.value).equal(s.value)})),s=(e,t)=>{i(e.system.melee).equal(t.melee),i(e.system.slow).equal(t.slow),i(e.system.missile).equal(t.missile)};a("Provided value without () adds value to all keys",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");yield t(e,"test",{label:"test",title:"test",value:"test"}),e.delete()})))),a("Provided values have tags within () added to array as title",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");yield t(e,"test (test2)",{label:"test",title:"test2",value:"test"}),e.delete()})))),a("Weapons are automatically melee",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");s(e,{melee:!0,slow:!1,missile:!1}),yield null==e?void 0:e.delete()}))));new Set([CONFIG.OSE.tags.melee,CONFIG.OSE.tags.slow,CONFIG.OSE.tags.missile]).forEach((n=>{a(`"${n}" tag activates the boolean but not a tag`,(()=>e(void 0,void 0,void 0,(function*(){const t=yield qt("weapon");yield((t,a)=>e(void 0,void 0,void 0,(function*(){var e;i(null===(e=null==t?void 0:t.system)||void 0===e?void 0:e.tags.length).equal(0),yield null==t?void 0:t.pushManualTag([a])})))(t,n),s(t,{melee:!0,slow:n===CONFIG.OSE.tags.slow,missile:n===CONFIG.OSE.tags.missile}),t.delete()})))),a(`"Test (${n})" tags activates the boolean and adds a tag`,(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");yield t(e,`Test (${n})`,{label:"Test",title:n,value:"Test"}),s(e,{melee:!0,slow:n===CONFIG.OSE.tags.slow,missile:n===CONFIG.OSE.tags.missile}),e.delete()}))))}))})),t("popManualTag(value)",(()=>{a("Item without system.tags return undefined",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");i(e.system.tags.length).equal(0);const t=yield e.popManualTag("test");i(t).equal(void 0)})))),a("Tags matching input value are removed from item.system.tags",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");i(e.system.tags.length).equal(0),yield e.pushManualTag(["test","test2"]),i(e.system.tags.length).equal(2),yield e.popManualTag("test"),i(e.system.tags.length).equal(1),i(e.system.tags.pop().title).equal("test2")}))))})),t("getAutoTagList()",(()=>{a("Container does nothing",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("container"),t=e.getAutoTagList();i(t.length).equal(0),e.delete()})))),a("Item does nothing",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("item"),t=e.getAutoTagList();i(t.length).equal(0),e.delete()})))),a("Weapon has damage label applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon"),t=e.getAutoTagList();i(t.length).equal(1),i(t[0].icon).equal("fa-tint"),i(t[0].label).equal("1d6"),e.delete()})))),a("Missile weapon has ranges applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");yield e.pushManualTag([CONFIG.OSE.tags.missile]),l(e.system.missile);const t=e.getAutoTagList();i(t.length).equal(2),i(t[0].icon).equal("fa-tint"),i(t[0].label).equal("1d6"),i(t[1].icon).equal("fa-bullseye"),i(t[1].label).equal("0/0/0"),e.delete()})))),a("Manual weapon tags are applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("weapon");yield e.pushManualTag(["Test"]);const t=e.getAutoTagList();i(t.length).equal(2),i(t[0].icon).equal("fa-tint"),i(t[0].label).equal("1d6"),i(t[1].label).equal("Test"),e.delete()})))),a("Default Armor has armor type applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("armor"),t=e.getAutoTagList();i(t.length).equal(1),i(t[0].icon).equal("fa-tshirt"),i(t[0].label).equal("Light"),e.delete()})))),a("Heavy Armor has armor type applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("armor");yield e.update({system:{type:"heavy"}});const t=e.getAutoTagList();i(t.length).equal(1),i(t[0].icon).equal("fa-tshirt"),i(t[0].label).equal("Heavy"),e.delete()})))),a("Spells have class, range, and duration applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("spell"),t=e.getAutoTagList();i(t.length).equal(3),i(t[0].label).equal("Magic-User"),i(t[1].label).equal(""),i(t[2].label).equal(""),e.delete()})))),a("Abilities have requirements applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("ability");yield e.update({system:{requirements:"alice,bob"}});const t=e.getAutoTagList();i(t.length).equal(2),i(t[0].label).equal("alice"),i(t[1].label).equal("bob"),e.delete()})))),a("If rollTag exists, it is applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("spell");yield e.update({system:{roll:"1d20+12"}});const t=e.getAutoTagList();i(t.length).equal(4),i(t[3].label).equal("Roll 1d20+12"),e.delete()})))),a("If saveTag exists, it is applied",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("spell");yield e.update({system:{save:"death"}});const t=e.getAutoTagList();i(t.length).equal(4),i(t[3].label).equal("Death Poison"),i(t[3].icon).equal("fa-skull"),e.delete()}))))})),t("roll(options)",(()=>{a("Item of weapon type activates rollWeapon",(()=>e(void 0,void 0,void 0,(function*(){})))),a("Item of spell type activates spendSpell",(()=>{})),a("Item of ability type activates rollFormula if it has associated item.system.roll",(()=>{})),a("Item of ability type shows chat card if no item.system.roll associated",(()=>{})),a("Item of item type shows chat card",(()=>{})),a("Item of armor type shows chat card",(()=>{}))})),t("show()",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),s((()=>e(void 0,void 0,void 0,(function*(){var t;null===(t=game.items)||void 0===t||t.filter((e=>{var t;return(null===(t=null==e?void 0:e.name)||void 0===t?void 0:t.indexOf("Test Weapon Item "))>=0||!1})).forEach((t=>e(void 0,void 0,void 0,(function*(){return t.delete()})))),yield gt()}))));const t=t=>e(void 0,void 0,void 0,(function*(){var e,a,s,n,o;l(["publicroll","gmroll","blindroll","selfroll"].includes(t)),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(0),game.settings.set("core","rollMode",t),i(game.settings.get("core","rollMode")).equal(t);const r=yield qt("weapon");yield null==r?void 0:r.show(),i(null===(a=game.messages)||void 0===a?void 0:a.size).equal(1);const d=null===(s=game.messages)||void 0===s?void 0:s.contents.pop();i(null==d?void 0:d.blind).equal("blindroll"===t),i(null==d?void 0:d.type).equal(0),"publicroll"===t?i(null===(n=null==d?void 0:d.whisper)||void 0===n?void 0:n.length).equal(0):null===(o=null==d?void 0:d.whisper)||void 0===o||o.forEach((e=>{var t,a;l(null===(a=null===(t=game.users)||void 0===t?void 0:t.find((t=>t._id===e)))||void 0===a?void 0:a.isGM)})),yield null==r?void 0:r.delete()}));a("Private GM Roll whispers chat message to GM",(()=>e(void 0,void 0,void 0,(function*(){yield t("gmroll")})))),a("Blindroll whispers chat message to GM and is blind",(()=>e(void 0,void 0,void 0,(function*(){yield t("blindroll")})))),a("Selfroll whispers chat message to user",(()=>e(void 0,void 0,void 0,(function*(){yield t("selfroll")})))),a("Public messages is not a whisper and is not blind",(()=>e(void 0,void 0,void 0,(function*(){yield t("publicroll")}))))})),t("_onChatCardToggleContent(event)",(()=>{})),t("_onChatCardAction(event)",(()=>{})),t("_getChatCardActor(card)",(()=>{a("Returns actor if tokenId is properly set",(()=>{})),a("Returns actor if actorId is properly set",(()=>{})),a("Returns null if neither tokenId nor actorId is properly set",(()=>{}))})),t("_getChatCardTargets(card)",(()=>{}))};const Ha={displayName:"OSE: Item: Sheet"};var Ga=({describe:t,it:a,expect:i,after:s,assert:n})=>{s((()=>{Ct()})),t("defaultOptions() ",(()=>{a("Has correctly set defaultOptions",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("item"),t=null==e?void 0:e.sheet;i(t).is.not.undefined,i(null==t?void 0:t.options.classes.length).equal(3),i(null==t?void 0:t.options.classes).contain("ose"),i(null==t?void 0:t.options.classes).contain("sheet"),i(null==t?void 0:t.options.classes).contain("item"),i(null==t?void 0:t.options.width).equal(520),i(null==t?void 0:t.options.height).equal(390),n(!(null==t?void 0:t.options.resizable)),i(null==t?void 0:t.options.tabs.length).equal(1),i(Object.keys(null==t?void 0:t.options.tabs[0]).length).equal(4),i(Object.keys(null==t?void 0:t.options.tabs[0])).contain("callback"),i(typeof(null==t?void 0:t.options.tabs[0].callback)).equal("function"),i(null==t?void 0:t.options.tabs[0].callback.name).contain("_onChangeTab"),i(Object.keys(null==t?void 0:t.options.tabs[0])).contain("navSelector"),i(null==t?void 0:t.options.tabs[0].navSelector).equal(".tabs"),i(Object.keys(null==t?void 0:t.options.tabs[0])).contain("contentSelector"),i(null==t?void 0:t.options.tabs[0].contentSelector).equal(".sheet-body"),i(Object.keys(null==t?void 0:t.options.tabs[0])).contain("initial"),i(null==t?void 0:t.options.tabs[0].initial).equal("description")}))))})),t("template()",(()=>{a("Returns html path",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("item"),t=null==e?void 0:e.sheet;i(t).is.not.undefined,i(null==t?void 0:t.template).contain("templates/items"),i(null==t?void 0:t.template).contain("-sheet.html")}))))})),t("getData()",(()=>{a("Returns data",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qt("item"),t=null==e?void 0:e.sheet;i(t).is.not.undefined;const a=yield null==t?void 0:t.getData();i(Object.keys(a)).contain("_id"),i(Object.keys(a)).contain("editable"),i(Object.keys(a)).contain("config"),i(Object.keys(a)).contain("enriched")}))))}))};const La="ose.party.entity",Wa={displayName:"OSE: Party: Entity"};var Ba=({describe:t,it:a,expect:i,assert:s,after:n})=>{t("currentParty()",(()=>{a("Returns all characters in a party",(()=>e(void 0,void 0,void 0,(function*(){var t;const a=yield((t,a={})=>e(void 0,void 0,void 0,(function*(){return wt(t,a,La)})))("character"),n=new ct,l=yield n._addActorToParty(a);i(l).is.undefined,s(null==a?void 0:a.getFlag(game.system.id,"party"));const o=rt,r=null===(t=game.actors)||void 0===t?void 0:t.filter((e=>{var t;return null===(t=e.flags[game.system.id])||void 0===t?void 0:t.party}));i(o.currentParty.length).equal(null==r?void 0:r.length),yield null==a?void 0:a.delete()}))))})),n((()=>e(void 0,void 0,void 0,(function*(){yield It(La)}))))};const Ua="ose.party.sheet",Ka={displayName:"OSE: Party: Sheet"},Va=(t,a={})=>e(void 0,void 0,void 0,(function*(){return wt(t,a,Ua)}));var Ya=({describe:t,it:a,expect:i,assert:s,after:n})=>{t("defaultOptions()",(()=>{a("Has correctly set defaultOptions",(()=>{const e=new ct;i(e.options.classes).contain("ose"),i(e.options.classes).contain("dialog"),i(e.options.classes).contain("party-sheet"),i(e.options.template).contain("/templates/apps/party-sheet.html"),i(e.options.width).equal(280),i(e.options.height).equal(400),s(e.options.resizable),i(e.options.dragDrop[0].dragSelector).equal(".actor-list .actor"),i(e.options.dragDrop[0].dropSelector).equal(".party-members"),s(!e.options.closeOnSubmit)}))})),t("init()",(()=>{})),t("showPartySheet(options = {})",(()=>{a("Can render party sheet",(()=>e(void 0,void 0,void 0,(function*(){ct.showPartySheet(),yield ht();const e=yt("party-sheet");i(e.length).equal(1),i(e[0].options.classes).contain("party-sheet"),yield e[0].close(),i(yt("party-sheet").length).equal(0)}))))})),t("partySheet()",(()=>{a("Returns a partysheet",(()=>{const{partySheet:e}=ct;i(e).is.not.undefined,i(null==e?void 0:e.options.classes).contain("party-sheet")}))})),t("title()",(()=>{a("Creates string in dialog window title",(()=>e(void 0,void 0,void 0,(function*(){var e;ct.showPartySheet(),yield ht();const t=null===(e=document.querySelector("div.party-sheet .window-title"))||void 0===e?void 0:e.innerHTML;i(typeof t).equal("string");const a=yt("party-sheet");i(a.length).equal(1),yield a[0].close(),i(yt("party-sheet").length).equal(0)}))))})),t("getData()",(()=>{a("Returns proper data",(()=>{const e=(new ct).getData(),t=Object.keys(e);i(t.length).equal(4),i(t).contain("partyActors"),i(t).contain("config"),i(t).contain("user"),i(t).contain("settings")}))})),t("_addActorToParty(actor)",(()=>{a("Monster returns undefined",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Va("monster"),t=new ct,a=yield t._addActorToParty(e);i(a).is.undefined,yield e.delete()})))),a("Adding a character updates the actor",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Va("character"),t=new ct,a=yield t._addActorToParty(e);i(a).is.undefined,s(null==e?void 0:e.getFlag(game.system.id,"party")),yield e.delete()}))))})),t("_removeActorFromParty(actor)",(()=>e(void 0,void 0,void 0,(function*(){a("Removing a character updates the actor flags",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Va("character"),t=new ct,a=yield t._addActorToParty(e);i(a).is.undefined,s(null==e?void 0:e.getFlag(game.system.id,"party"));const n=yield t._removeActorFromParty(e);i(n).is.undefined,s(!(null==e?void 0:e.getFlag(game.system.id,"party"))),yield e.delete()}))))})))),t("_onDrop(event)",(()=>{})),t("_onDropActor(event, data)",(()=>{a("Dropping a non-actor type returns nothing",(()=>e(void 0,void 0,void 0,(function*(){const e=new ct,t=yield e._onDropActor("",{type:"not-actor"});i(t).is.undefined})))),a("Dropping an actor type updates the actor",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Va("character"),t={type:null==e?void 0:e.documentName,uuid:null==e?void 0:e.uuid},a=new ct,n=yield a._onDropActor("",t);yield ht(),i(n).is.undefined,s(null==e?void 0:e.getFlag(game.system.id,"party")),yield null==e?void 0:e.delete()}))))})),t("_recursiveAddFolder(folder)",(()=>{a("Folder of actors add actors to party",(()=>e(void 0,void 0,void 0,(function*(){const e=new ct,t=yield Folder.create({name:`Test Folder ${Ua}`,type:"Actor"}),a=yield Va("character");yield null==a?void 0:a.update({folder:null==t?void 0:t._id}),i(null==a?void 0:a.folder).equal(t),e._recursiveAddFolder(t),yield ht(),s(null==a?void 0:a.getFlag(game.system.id,"party")),yield null==a?void 0:a.delete(),yield null==t?void 0:t.delete()})))),a("Folder with sub-folders of actors add actors to party",(()=>e(void 0,void 0,void 0,(function*(){const e=new ct,t=yield Folder.create({name:`Test Folder ${Ua}`,type:"Actor"}),a=yield Folder.create({name:`Test Folder ${Ua} subfolder`,type:"Actor",folder:t._id}),n=yield Va("character");yield null==n?void 0:n.update({folder:null==a?void 0:a._id}),i(null==n?void 0:n.folder).equal(a),e._recursiveAddFolder(t),yield ht(),s(null==n?void 0:n.getFlag(game.system.id,"party")),yield null==n?void 0:n.delete()}))))})),t("_onDropFolder(event, data)",(()=>{a("Dropping with documentName that is not Actor returns undefined",(()=>e(void 0,void 0,void 0,(function*(){const e=new ct,t=yield e._onDropFolder("",{documentName:"Not-Actor"});i(t).is.undefined})))),a("Dropping a folder with an actor in it adds it to the party",(()=>e(void 0,void 0,void 0,(function*(){const e=new ct,t=yield Folder.create({name:`Test Folder ${Ua}`,type:"Actor"}),a=yield Va("character");yield null==a?void 0:a.update({folder:null==t?void 0:t._id}),i(null==a?void 0:a.folder).equal(t),yield e._onDropFolder("",t),yield ht(),s(null==a?void 0:a.getFlag(game.system.id,"party")),yield null==a?void 0:a.delete(),yield null==t?void 0:t.delete()}))))})),t("_onDragStart(event)",(()=>{})),t("_dealXP(event)",(()=>{})),n((()=>e(void 0,void 0,void 0,(function*(){var e,t,a;It(Ua),null===(a=null===(t=null===(e=game.folders)||void 0===e?void 0:e.contents)||void 0===t?void 0:t.filter((e=>{var t;return null===(t=e.name)||void 0===t?void 0:t.includes(`Test Folder ${Ua}`)})))||void 0===a||a.forEach((e=>e.delete()))}))))};const Xa={displayName:"OSE: Party XP: Sheet"};var Ja=({describe:t,it:a,expect:i,assert:s})=>{t("defaultOptions()",(()=>{a("Has correctly set defaultOptions",(()=>{const e=new dt;i(e.options.classes).contain("ose"),i(e.options.classes).contain("dialog"),i(e.options.classes).contain("party-xp"),i(e.options.template).contain("/templates/apps/party-xp.html"),i(e.options.width).equal(300),i(e.options.height).equal("auto"),s(!e.options.resizable),s(e.options.closeOnSubmit)}))})),t("title()",(()=>{a("Creates string in dialog window title",(()=>e(void 0,void 0,void 0,(function*(){var e;(new dt).render(!0),yield ht();const t=null===(e=document.querySelector("div.party-xp .window-title"))||void 0===e?void 0:e.innerHTML;i(typeof t).equal("string");const a=yt("party-xp");i(a.length).equal(1),yield a[0].close(),i(yt("party-xp").length).equal(0)}))))})),t("getData()",(()=>{a("Returns proper data",(()=>{const e=(new dt).getData(),t=Object.keys(e);i(t.length).equal(5),i(t).contain("actors"),i(t).contain("data"),i(t).contain("config"),i(t).contain("user"),i(t).contain("settings")}))})),t("_onDrop(event)",(()=>{})),t("_updateObject(event)",(()=>{})),t("_calculateShare()",(()=>{})),t("_dealXP(event)",(()=>{}))};const Qa={displayName:"OSE: Helpers: Behaviour"};var Za=({describe:t,it:a,before:i,after:s,assert:n})=>{t("skipRollDialogCheck(event)",(()=>{const l=game.settings.get(game.system.id,"invertedCtrlBehavior");t("invertedCtrlBehavior is set to false",(()=>{i((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"invertedCtrlBehavior",!1)})))),a("Setting is false",(()=>e(void 0,void 0,void 0,(function*(){const e=yield game.settings.get(game.system.id,"invertedCtrlBehavior");n(!e)})))),a("Not holding ctrl should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!1});n(!R(e))})),a("Not holding meta should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{metaKey:!1});n(!R(e))})),a("Holding ctrl should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!0});n(R(e))})),a("Holding meta should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{metaKey:!0});n(R(e))}))})),t("invertedCtrlBehavior is set to true",(()=>{i((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"invertedCtrlBehavior",!0)})))),a("Setting is false",(()=>e(void 0,void 0,void 0,(function*(){const e=yield game.settings.get(game.system.id,"invertedCtrlBehavior");n(e)})))),a("Not holding ctrl should skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!1});n(R(e))})),a("Not holding meta should skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!1});n(R(e))})),a("Holding ctrl should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{ctrlKey:!0});n(!R(e))})),a("Holding meta should not skip dialog",(()=>{const e=new KeyboardEvent("keydown",{metaKey:!0});n(!R(e))}))})),s((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"invertedCtrlBehavior",l)}))))}))};const ei={displayName:"OSE: Helpers: Chat"};var ti=({describe:e,it:t,before:a,after:i,expect:s})=>{e("applyChatCardDamage(roll, multiplier)",(()=>{})),e("addChatMessageContextOptions(_, options)",(()=>{})),e("addChatMessageButtons(msg. html)",(()=>{}))};const ai={displayName:"OSE: Helpers: Dice"},ii=(e,t=[e])=>{const a=[];return t.forEach((e=>{a.push({result:e})})),{terms:[{results:a}],total:e}};var si=({describe:t,it:a,after:i,afterEach:s,before:n,expect:l})=>{const o=game.settings.get(game.system.id,"ascendingAC");n((()=>e(void 0,void 0,void 0,(function*(){var e;yield null===(e=ui.notifications)||void 0===e?void 0:e.close()})))),i((()=>e(void 0,void 0,void 0,(function*(){var e;game.settings.set(game.system.id,"ascendingAC",o),yield null===(e=ui.notifications)||void 0===e?void 0:e.render(!0)})))),t("sendRoll(parts, data, title, flavor, speaker, form, chatMessage)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt()})))),a("Can roll with single part",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield _.sendRoll({parts:["1d10"],data:{roll:{blindroll:!1}}});yield ht(),yield ht();const a=null===(e=document.querySelector(".chat-message .dice-formula"))||void 0===e?void 0:e.innerHTML;l(Object.keys(t)).contain("_evaluated"),l(t._evaluated).equal(!0),l(Object.keys(t)).contain("_formula"),l(t._formula).equal("1d10"),l(a).equal("1d10")})))),a("Can roll with multiple parts",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield _.sendRoll({parts:["1d10","1d20"],data:{roll:{blindroll:!1}}});yield ht(),yield ht();const a=null===(e=document.querySelector(".chat-message .dice-formula"))||void 0===e?void 0:e.innerHTML;l(Object.keys(t)).contain("_evaluated"),l(t._evaluated).equal(!0),l(Object.keys(t)).contain("_formula"),l(t._formula).equal("1d10 + 1d20"),l(a).equal("1d10 + 1d20")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield gt()}))))})),t("digestResult(data, roll)",(()=>{const e=(e,t,a=0)=>({roll:{type:e,target:t,thac0:a}});t("result type",(()=>{const t=e("result",10);a("Successful roll hitting target",(()=>{const e=ii(10);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)})),a("Unsuccessful roll under",(()=>{const e=ii(9);l(_.digestResult(t,e).isSuccess).equal(!1),l(_.digestResult(t,e).isFailure).equal(!0)})),a("Unsuccessful roll over",(()=>{const e=ii(11);l(_.digestResult(t,e).isSuccess).equal(!1),l(_.digestResult(t,e).isFailure).equal(!0)}))})),t("above type",(()=>{const t=e("above",10);a("Successful roll hitting target",(()=>{const e=ii(10);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)})),a("Unsuccessful roll under",(()=>{const e=ii(9);l(_.digestResult(t,e).isSuccess).equal(!1),l(_.digestResult(t,e).isFailure).equal(!0)})),a("Successful roll over",(()=>{const e=ii(11);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)}))})),t("below type",(()=>{const t=e("below",10);a("Successful roll hitting target",(()=>{const e=ii(10);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)})),a("Successful roll under",(()=>{const e=ii(9);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)})),a("Unsuccessful roll over",(()=>{const e=ii(11);l(_.digestResult(t,e).isSuccess).equal(!1),l(_.digestResult(t,e).isFailure).equal(!0)}))})),t("check type",(()=>{const t=e("check",10);a("Successful roll on a nat 1",(()=>{const e=ii(1);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)})),a("Unsuccessful roll on a nat 20",(()=>{const t=e("check",20),a=ii(20);l(_.digestResult(t,a).isSuccess).equal(!1),l(_.digestResult(t,a).isFailure).equal(!0)})),a("Successful roll hitting target",(()=>{const e=ii(10);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)})),a("Successful roll under",(()=>{const e=ii(9);l(_.digestResult(t,e).isSuccess).equal(!0),l(_.digestResult(t,e).isFailure).equal(!1)})),a("Unsuccessful roll over",(()=>{const e=ii(11);l(_.digestResult(t,e).isSuccess).equal(!1),l(_.digestResult(t,e).isFailure).equal(!0)}))})),t("table type",(()=>{const e={roll:{type:"table",target:10,table:{9:"Success",10:"Failure"}}};a("Successful roll hitting target",(()=>{const t=ii(9);l(_.digestResult(e,t).isSuccess).equal(!1),l(_.digestResult(e,t).isSuccess).equal(!1),l(_.digestResult(e,t).details).equal("Success")})),a("Successful roll under",(()=>{const t=ii(10);l(_.digestResult(e,t).isSuccess).equal(!1),l(_.digestResult(e,t).isSuccess).equal(!1),l(_.digestResult(e,t).details).equal("Failure")}))})),t("unknown type",(()=>{const t=e("unknown",10);a("Returns default result",(()=>{const e=ii(4);l(_.digestResult(t,e).isSuccess).equal(!1),l(_.digestResult(t,e).isSuccess).equal(!1),l(_.digestResult(t,e).target).equal(10),l(_.digestResult(t,e).total).equal(4)}))}))})),t("attackIsSuccess(roll, target, bonus)",(()=>{t("Ascending AC",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!0)})))),a("Natural 1 always fails",(()=>{const e=ii(1,[1]);l(_.attackIsSuccess(e,100,0)).equal(!1);const t=ii(20,[1]);l(_.attackIsSuccess(t,100,0)).equal(!1)})),a("Natural 20 always succeeds",(()=>{const e=ii(1,[20]);l(_.attackIsSuccess(e,0,100)).equal(!0);const t=ii(20,[20]);l(_.attackIsSuccess(t,0,100)).equal(!0)})),a("Roll + bonus equal target is successful",(()=>{const e=ii(10);l(_.attackIsSuccess(e,20,10)).equal(!0)})),a("Roll + bonus above target is successful",(()=>{const e=ii(10);l(_.attackIsSuccess(e,19,10)).equal(!0)})),a("Roll + bnous under target is unsuccessful",(()=>{const e=ii(10);l(_.attackIsSuccess(e,21,10)).equal(!1)}))})),t("Descending AC",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!1)})))),a("Natural 1 always fails",(()=>{const e=ii(1,[1]);l(_.attackIsSuccess(e,100,0)).equal(!1);const t=ii(20,[1]);l(_.attackIsSuccess(t,100,0)).equal(!1)})),a("Natural 20 always succeeds",(()=>{const e=ii(1,[20]);l(_.attackIsSuccess(e,0,100)).equal(!0);const t=ii(20,[20]);l(_.attackIsSuccess(t,0,100)).equal(!0)})),a("Roll + ac equal thac0 is successful",(()=>{const e=ii(10);l(_.attackIsSuccess(e,20,10)).equal(!0)})),a("Roll + ac above thac0 is successful",(()=>{const e=ii(10);l(_.attackIsSuccess(e,19,10)).equal(!0)})),a("Roll + ac under thac0 is unsuccessful",(()=>{const e=ii(10);l(_.attackIsSuccess(e,21,10)).equal(!1)}))}))})),t("digestAttackResult(data, roll)",(()=>{const i={roll:{thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}};t("Ascending AC",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!0)})))),a("Natural 1 terms is unsuccessful",(()=>e(void 0,void 0,void 0,(function*(){l(game.settings.get(game.system.id,"ascendingAC")).equal(!0);const e=ii(1,[1]);l(_.digestAttackResult(i,e).isSuccess).equal(!1),l(_.digestAttackResult(i,e).isFailure).equal(!0);const t=ii(20,[1]);l(_.digestAttackResult(i,t).isSuccess).equal(!1),l(_.digestAttackResult(i,t).isFailure).equal(!0)})))),a("Attack rolls with a modified result of 1 are allowed to succeeed if hits target AC. Issue#340",(()=>{const e={roll:{thac0:19,target:{actor:{system:{ac:{value:0},aac:{value:1}}}}}},t=ii(1,[2,-1]);l(_.digestAttackResult(e,t).isSuccess).equal(!0),l(_.digestAttackResult(e,t).isFailure).equal(!1)})),a("Lower than target AC is unsuccessful",(()=>{const e=19-i.roll.thac0,t=ii(i.roll.target.actor.system.aac.value-e-1);l(_.digestAttackResult(i,t).isSuccess).equal(!1),l(_.digestAttackResult(i,t).isFailure).equal(!0)})),a("Equal than target AC is successful",(()=>{const e=19-i.roll.thac0,t=ii(i.roll.target.actor.system.aac.value-e);l(_.digestAttackResult(i,t).isSuccess).equal(!0),l(_.digestAttackResult(i,t).isFailure).equal(!1)})),a("Higher than target AC is successful",(()=>{const e=19-i.roll.thac0,t=ii(i.roll.target.actor.system.aac.value-e+1);l(_.digestAttackResult(i,t).isSuccess).equal(!0),l(_.digestAttackResult(i,t).isFailure).equal(!1)})),a("Attack rolls with a modified result of 20 are allowed to fail if doesn't hit target AC. Issue#340",(()=>{const e={roll:{thac0:19,target:{actor:{system:{ac:{value:0},aac:{value:21}}}}}},t=ii(20,[19,1]);l(_.digestAttackResult(e,t).isSuccess).equal(!1),l(_.digestAttackResult(e,t).isFailure).equal(!0)})),a("Natural 20 is successful",(()=>{const e=ii(1,[20]);l(_.digestAttackResult(i,e).isSuccess).equal(!0),l(_.digestAttackResult(i,e).isFailure).equal(!1);const t=ii(20,[20]);l(_.digestAttackResult(i,t).isSuccess).equal(!0),l(_.digestAttackResult(i,t).isFailure).equal(!1)}))})),t("Descending AC, ac=0",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield game.settings.set(game.system.id,"ascendingAC",!1)})))),a("Natural 1 terms is unsuccessful",(()=>e(void 0,void 0,void 0,(function*(){l(game.settings.get(game.system.id,"ascendingAC")).equal(!1);const e=ii(1,[1]);l(_.digestAttackResult(i,e).isSuccess).equal(!1),l(_.digestAttackResult(i,e).isFailure).equal(!0);const t=ii(20,[1]);l(_.digestAttackResult(i,t).isSuccess).equal(!1),l(_.digestAttackResult(i,t).isFailure).equal(!0)})))),a("Lower than thac0 is unsuccessful",(()=>{const e=ii(i.roll.thac0-1);l(_.digestAttackResult(i,e).isSuccess).equal(!1),l(_.digestAttackResult(i,e).isFailure).equal(!0)})),a("Equal to thac0 is successful",(()=>{const e=ii(i.roll.thac0);l(_.digestAttackResult(i,e).isSuccess).equal(!0),l(_.digestAttackResult(i,e).isFailure).equal(!1)})),a("Higher than thac0 is successful",(()=>{const e=ii(i.roll.thac0+1);l(_.digestAttackResult(i,e).isSuccess).equal(!0),l(_.digestAttackResult(i,e).isFailure).equal(!1)})),a("Natural 20 is successful",(()=>{const e=ii(1,[20]);l(_.digestAttackResult(i,e).isSuccess).equal(!0),l(_.digestAttackResult(i,e).isFailure).equal(!1);const t=ii(20,[20]);l(_.digestAttackResult(i,t).isSuccess).equal(!0),l(_.digestAttackResult(i,t).isFailure).equal(!1)}))}))})),t("sendAttackRoll(parts, data, flags, title, flavor, speaker, form)",(()=>{n((()=>e(void 0,void 0,void 0,(function*(){yield gt(),yield game.settings.set(game.system.id,"ascendingAC",!0)})))),a("Missing dmg roll shows notification",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a;null===(e=ui.notifications)||void 0===e||e.close();const i={parts:["1d20","0","0","0"],data:{roll:{type:"melee",dmg:["1d6"],thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}}};i.data.roll.dmg=[],yield _.sendAttackRoll(i),yield ht();const s=null===(t=ui.notifications)||void 0===t?void 0:t.queue.pop();l(null===(a=ui.notifications)||void 0===a?void 0:a.queue.length).equal(0),l(null==s?void 0:s.message).equal("Attack has no damage dice terms; be sure to set the attack's damage")})))),a("Can roll with single part and single dmg die",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a={parts:["1d20","0","0","0"],data:{roll:{type:"melee",dmg:["1d6"],thac0:15,target:{actor:{system:{ac:{value:0},aac:{value:9}}}}}}};yield _.sendAttackRoll(a),yield ht(),yield ht(),yield ht(),yield ht();const i=null===(e=document.querySelector(".dice-formula"))||void 0===e?void 0:e.innerHTML;l(i).equal("1d20 + 0 + 0 + 0");const s=null===(t=document.querySelector(".damage-roll .dice-formula"))||void 0===t?void 0:t.innerHTML;l(s).equal("1d6")})))),s((()=>e(void 0,void 0,void 0,(function*(){yield gt()}))))})),t("RollSave(parts, data, skipDialog, speaker, flavor, title, chatMessage)",(()=>{t("Skipping dialog",(()=>{a("produces a roll chat message",(()=>e(void 0,void 0,void 0,(function*(){yield _.RollSave({parts:["1d10"],skipDialog:true,data:{roll:{blindroll:!1}}}),yield ht(),l(game.messages.size).equal(1),l(document.querySelector(".roll-result")).not.undefined}))))})),t("Not skipping dialog",(()=>{a("produces a dialog",(()=>e(void 0,void 0,void 0,(function*(){_.RollSave({parts:["1d10"],data:{roll:{blindroll:!1}}}),yield ht();const e=document.querySelector(".dialog");l(null==e?void 0:e.querySelector(".ok")).not.null,l(null==e?void 0:e.querySelector(".magic")).not.null,l(null==e?void 0:e.querySelector(".cancel")).not.null,yield ft()}))))})),s((()=>e(void 0,void 0,void 0,(function*(){yield gt(),yield ft()}))))})),t("Roll(parts, data, skipDialog, speaker, flavor, title, chatMessage, flags)",(()=>{t("Skipping dialog",(()=>{a("produces a roll chat message",(()=>e(void 0,void 0,void 0,(function*(){yield _.Roll({parts:["1d10"],skipDialog:true,data:{roll:{blindroll:!1}}}),yield ht(),l(game.messages.size).equal(1),l(document.querySelector(".roll-result")).not.undefined}))))})),t("Not skipping dialog",(()=>{a("produces a dialog",(()=>e(void 0,void 0,void 0,(function*(){_.Roll({parts:["1d10"],data:{roll:{blindroll:!1}}}),yield ht();const e=document.querySelector(".dialog");l(null==e?void 0:e.querySelector(".ok")).not.null,l(null==e?void 0:e.querySelector(".magic")).is.null,l(null==e?void 0:e.querySelector(".cancel")).not.null,yield ft()}))))})),s((()=>e(void 0,void 0,void 0,(function*(){yield gt(),yield ft(),yield ht()}))))}))};const ni={displayName:"OSE: Helpers: Handlebars"};var li=({describe:t,it:a,expect:i})=>{t("registerHelpers()",(()=>{t("eq helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("eq")})),a("is functional",(()=>{i(Handlebars.helpers.eq(1,1)).equal(!0),i(Handlebars.helpers.eq("test","test")).equal(!0),i(Handlebars.helpers.eq(1,2)).equal(!1),i(Handlebars.helpers.eq("test",1)).equal(!1),i(Handlebars.helpers.eq([],[])).equal(!1)}))})),t("mod helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("mod")})),a("is functional",(()=>{i(Handlebars.helpers.mod(0)).equal("0"),i(Handlebars.helpers.mod(1)).equal("+1"),i(Handlebars.helpers.mod(-1)).equal("-1"),i(Handlebars.helpers.mod("1")).equal("+1"),i(Handlebars.helpers.mod("-1")).equal("-1"),i(Handlebars.helpers.mod("a")).equal("0")}))})),t("add helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("add")})),a("is functional",(()=>{i(Handlebars.helpers.add(1,2)).equal(3),i(Handlebars.helpers.add(1,-2)).equal(-1),i(Handlebars.helpers.add("1","3")).equal(4),i(Handlebars.helpers.add("1","-3")).equal(-2)}))})),t("subtract helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("subtract")})),a("is functional",(()=>{i(Handlebars.helpers.subtract(1,2)).equal(-1),i(Handlebars.helpers.subtract(1,-2)).equal(3),i(Handlebars.helpers.subtract("1","3")).equal(-2),i(Handlebars.helpers.subtract("1","-3")).equal(4)}))})),t("divide helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("divide")})),a("is functional",(()=>{i(Handlebars.helpers.divide(1,2)).equal(0),i(Handlebars.helpers.divide(1,-2)).equal(-1),i(Handlebars.helpers.divide(10,3)).equal(3),i(Handlebars.helpers.divide("10","3")).equal(3),i(Handlebars.helpers.divide("10","-3")).equal(-4)}))})),t("mult helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("mult")})),a("is functional",(()=>{i(Handlebars.helpers.mult(1,2)).equal(2),i(Handlebars.helpers.mult(1,-2)).equal(-2),i(Handlebars.helpers.mult(10,3)).equal(30),i(Handlebars.helpers.mult("10","3")).equal(30),i(Handlebars.helpers.mult("10","-3")).equal(-30),i(Handlebars.helpers.mult(.1,2)).equal(.2),i(Handlebars.helpers.mult(.01,1)).equal(.01),i(Handlebars.helpers.mult(.001,1)).equal(0)}))})),t("roundWeight helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("roundWeight")})),a("is functional",(()=>{i(Handlebars.helpers.roundWeight(10.1)).equal(0),i(Handlebars.helpers.roundWeight(100.1)).equal(.1),i(Handlebars.helpers.roundWeight(1000.1)).equal(1)}))})),t("getTagIcon helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("getTagIcon")})),t("is functional",(()=>{Object.keys(CONFIG.OSE.tags).forEach((t=>{a(`for ${t} tag`,(()=>e(void 0,void 0,void 0,(function*(){i(Handlebars.helpers.getTagIcon(CONFIG.OSE.tags[t])).equal(CONFIG.OSE.tag_images[t])}))))}))}))})),t("counter helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("counter")})),a("is functional",(()=>{i(Handlebars.helpers.counter(!0,12,10)).equal(100),i(Handlebars.helpers.counter(!0,-10,10)).equal(0),i(Handlebars.helpers.counter(!0,3,10)).equal(30),i(Handlebars.helpers.counter(!0,33,100)).equal(33),i(Handlebars.helpers.counter(!0,100,400)).equal(25),i(Handlebars.helpers.counter(!1,12,10)).equal(0),i(Handlebars.helpers.counter(!1,-10,10)).equal(100),i(Handlebars.helpers.counter(!1,3,10)).equal(70),i(Handlebars.helpers.counter(!1,33,100)).equal(67),i(Handlebars.helpers.counter(!1,100,400)).equal(75)}))})),t("times helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("times")})),a("is functional",(()=>{const e={fn:e=>e};i(Handlebars.helpers.times(2,e)).equal("01"),i(Handlebars.helpers.times(5,e)).equal("01234")}))})),t("path helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("path")})),a("is functional",(()=>{i(Handlebars.helpers.path("/test")).equal(`${CONFIG.OSE.systemPath()}/test`)}))})),t("asset helper",(()=>{a("is registered",(()=>{i(Object.keys(Handlebars.helpers)).contain("asset")})),a("is functional",(()=>{i(Handlebars.helpers.asset("/test")).equal(`${CONFIG.OSE.assetsPath}/test`)}))}))}))};const oi="ose.helpers.macro",ri={displayName:"OSE: Helpers: Macro"},di=(t,a={})=>e(void 0,void 0,void 0,(function*(){return wt(t,a,oi)})),ci=()=>It(oi);var mi=({describe:t,it:a,expect:i,before:s,after:n,afterEach:l})=>{s((()=>e(void 0,void 0,void 0,(function*(){var e,t,a;null===(t=null===(e=null===game||void 0===game?void 0:game.scenes)||void 0===e?void 0:e.active)||void 0===t||t.update({active:!1}),yield null===(a=ui.notifications)||void 0===a?void 0:a.close()})))),l((()=>e(void 0,void 0,void 0,(function*(){Tt(),ci(),Ct(),At()})))),n((()=>e(void 0,void 0,void 0,(function*(){var e;ft(),Tt(),ci(),Ct(),At(),yield null===(e=ui.notifications)||void 0===e?void 0:e.render(!0)})))),t("createOseMacro(data, slot)",(()=>{a("Can create macro",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield Ot();i(null===(e=game.macros)||void 0===e?void 0:e.contents.find((e=>e.uuid===(null==t?void 0:t.uuid)))).not.undefined})))),a("Can drag Macro to hotbar",(()=>e(void 0,void 0,void 0,(function*(){var e;const t=yield Ot(),a={type:"Macro",uuid:null==t?void 0:t.uuid};yield nt(a,9);const s=null===(e=game.user)||void 0===e?void 0:e.getHotbarMacros(1);i(s[8].macro).equal(t)})))),a("Dragging Actor to hotbar send notification",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n;const l=yield di("character"),o={type:null==l?void 0:l.type,uuid:null==l?void 0:l.uuid};i(null===(e=ui.notifications)||void 0===e?void 0:e.queue.length).equal(0),yield nt(o,9),i(null===(t=ui.notifications)||void 0===t?void 0:t.queue.length).equal(1),i(null===(s=null===(a=ui.notifications)||void 0===a?void 0:a.queue.pop())||void 0===s?void 0:s.message).equal(game.i18n.localize("OSE.warn.macrosNotAnItem")),i(null===(n=ui.notifications)||void 0===n?void 0:n.queue.length).equal(0),yield null==l?void 0:l.delete()})))),a("Dragging World Item to hotbar send notification",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n;const l=yield di("character"),o=yield qt("weapon"),r={type:"Item",uuid:null==o?void 0:o.uuid};i(null===(e=ui.notifications)||void 0===e?void 0:e.queue.length).equal(0),yield nt(r,9),i(null===(t=ui.notifications)||void 0===t?void 0:t.queue.length).equal(1),i(null===(s=null===(a=ui.notifications)||void 0===a?void 0:a.queue.pop())||void 0===s?void 0:s.message).equal(game.i18n.localize("OSE.warn.macrosOnlyForOwnedItems")),i(null===(n=ui.notifications)||void 0===n?void 0:n.queue.length).equal(0),yield null==l?void 0:l.delete(),yield null==o?void 0:o.delete()})))),t("Dragging all item types creates macros",(()=>{new Set(["spell","ability","armor","weapon","item","container"]).forEach((t=>{a(`Dragging Actor ${t.capitalize()} to hotbar craetes macro`,(()=>e(void 0,void 0,void 0,(function*(){var e,a;const s=yield di("character");yield St(s,t);const n=null==s?void 0:s.items.contents[0],l={type:"Item",uuid:null==n?void 0:n.uuid,item:{name:null==n?void 0:n.name,img:""}};yield nt(l,9);const o=null===(e=game.user)||void 0===e?void 0:e.getHotbarMacros()[8];i(null===(a=null==o?void 0:o.macro)||void 0===a?void 0:a.command).equal(`game.ose.rollItemMacro("New Actor Test ${t.capitalize()}");`),yield null==s?void 0:s.delete()}))))}))}))})),t("rollItemMacro(itemName)",(()=>{a("No scene creates warning",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n,l;const o="weapon",r=yield di("character");yield St(r,o),yield null===(e=game.user)||void 0===e?void 0:e.update({character:null==r?void 0:r.id}),i(ChatMessage.getSpeaker().scene).is.null,i(ChatMessage.getSpeaker().actor).is.not.null,i(null===(t=ui.notifications)||void 0===t?void 0:t.queue.length).equal(0),yield lt(`New Actor Test ${o.capitalize()}`),i(null===(a=ui.notifications)||void 0===a?void 0:a.queue.length).equal(1),i(null===(n=null===(s=ui.notifications)||void 0===s?void 0:s.queue.pop())||void 0===n?void 0:n.message).equal(game.i18n.localize("OSE.warn.macrosNoTokenOwnedInScene")),i(null===(l=ui.notifications)||void 0===l?void 0:l.queue.length).equal(0),yield null==r?void 0:r.delete()})))),a("No assigned actor creates warning",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n,l;const o="weapon",r=yield di("character"),d=yield kt();i(null==d?void 0:d.tokenVision).equal(!0),yield St(r,o),yield null===(e=game.user)||void 0===e?void 0:e.update({character:null}),i(ChatMessage.getSpeaker().scene).is.not.null,i(ChatMessage.getSpeaker().actor).is.null,i(null===(t=ui.notifications)||void 0===t?void 0:t.queue.length).equal(0),yield lt(`New Actor Test ${o.capitalize()}`),i(null===(a=ui.notifications)||void 0===a?void 0:a.queue.length).equal(1),i(null===(n=null===(s=ui.notifications)||void 0===s?void 0:s.queue.pop())||void 0===n?void 0:n.message).equal(game.i18n.localize("OSE.warn.macrosNoTokenOwnedInScene")),i(null===(l=ui.notifications)||void 0===l?void 0:l.queue.length).equal(0),yield null==r?void 0:r.delete(),yield null==d?void 0:d.delete()})))),a("Scene & assigned actor creates roll",(()=>e(void 0,void 0,void 0,(function*(){var e;const t="weapon",a=yield di("character"),s=yield kt();i(null==s?void 0:s.tokenVision).equal(!0),yield St(a,t),yield null===(e=game.user)||void 0===e?void 0:e.update({character:null==a?void 0:a.id}),i(ChatMessage.getSpeaker().scene).is.not.null,i(ChatMessage.getSpeaker().actor).is.not.null,yield lt(`New Actor Test ${t.capitalize()}`),yield ht(),i(pt().length).equal(1),yield ft(),yield null==a?void 0:a.delete(),yield null==s?void 0:s.delete()})))),a("Duplicate item creates warning but also craetes rolls",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n,l;const o="weapon",r=yield di("character"),d=yield kt();i(null==d?void 0:d.tokenVision).equal(!0),yield St(r,o),yield St(r,o),yield null===(e=game.user)||void 0===e?void 0:e.update({character:null==r?void 0:r.id}),i(null===(t=ui.notifications)||void 0===t?void 0:t.queue.length).equal(0),yield lt(`New Actor Test ${o.capitalize()}`),yield ht(),i(null===(a=ui.notifications)||void 0===a?void 0:a.queue.length).equal(1),i(null===(n=null===(s=ui.notifications)||void 0===s?void 0:s.queue.pop())||void 0===n?void 0:n.message).equal(game.i18n.format("OSE.warn.moreThanOneItemWithName",{actorName:null==r?void 0:r.name,itemName:`New Actor Test ${o.capitalize()}`})),i(null===(l=ui.notifications)||void 0===l?void 0:l.queue.length).equal(0),yield ht(),i(pt().length).equal(1),yield ft(),yield null==r?void 0:r.delete(),yield null==d?void 0:d.delete()})))),a("Missing item creates warning",(()=>e(void 0,void 0,void 0,(function*(){var e,t,a,s,n,l;const o="weapon",r=yield di("character"),d=yield kt();i(null==d?void 0:d.tokenVision).equal(!0),yield St(r,o),yield null===(e=game.user)||void 0===e?void 0:e.update({character:null==r?void 0:r.id}),yield null===(t=null==r?void 0:r.items.getName(`New Actor Test ${o.capitalize()}`))||void 0===t?void 0:t.delete(),i(null===(a=ui.notifications)||void 0===a?void 0:a.queue.length).equal(0),yield lt(`New Actor Test ${o.capitalize()}`),yield ht(),i(null===(s=ui.notifications)||void 0===s?void 0:s.queue.length).equal(1);const u=null===(n=ui.notifications)||void 0===n?void 0:n.queue.pop();i(null===(l=ui.notifications)||void 0===l?void 0:l.queue.length).equal(0),i(null==u?void 0:u.type).equal("error"),i(null==u?void 0:u.message).equal(game.i18n.format("OSE.error.noItemWithName",{actorName:null==r?void 0:r.name,itemName:`New Actor Test ${o.capitalize()}`})),yield null==r?void 0:r.delete(),yield null==d?void 0:d.delete()}))))}))};const vi="ose.helpers.party",gi={displayName:"OSE: Helpers: Party"},hi=(t,a={})=>e(void 0,void 0,void 0,(function*(){return wt(t,a,vi)}));var yi=({describe:t,it:a,expect:i,after:s})=>{s((()=>{It(vi)})),t("addControl(object, html)",(()=>{})),t("update(actor)",(()=>{a("Doesn't render a partysheet when not in party",(()=>e(void 0,void 0,void 0,(function*(){const e=yield hi("character");mt(e),i(pt().length).equal(0),yield null==e?void 0:e.delete()})))),a("Opens a partysheet when in party",(()=>e(void 0,void 0,void 0,(function*(){var e,t;const a=yield hi("character");null==a||a.setFlag(game.system.id,"party",!0),mt(a),yield ht(),yield null===(e=null==ct?void 0:ct.partySheet)||void 0===e?void 0:e.render(!0),yield ht();const s=null===(t=document.querySelector(".party-members .actor"))||void 0===t?void 0:t.getAttribute("data-actor-id");i(s).equal(null==a?void 0:a.id),i(pt().length).equal(1),yield ft(),null==a||a.delete(),i(pt().length).equal(1)}))))}))};const{drawTreasure:pi,rollTreasure:fi}=st,bi="ose.helpers.treasure",wi={displayName:"OSE: Helpers: Treasure"},qi=()=>e(void 0,void 0,void 0,(function*(){return RollTable.create({name:`Mock Table ${bi}`})})),Si=()=>e(void 0,void 0,void 0,(function*(){const e=yield qi();return yield e.update({name:`Mock Treasure Table ${bi}`}),yield e.setFlag(game.system.id,"treasure",!0),e}));var Oi=({describe:t,it:a,expect:i,after:s})=>{t("augmentTable(table, html)",(()=>{})),t("drawTreasure(table, data)",(()=>{a("Can create table",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Si();yield e.createEmbeddedDocuments("TableResult",[{text:"50% Chance",range:[1,1],weight:50}]),i(e.results.size).equal(1),yield e.delete()})))),a("Draws successfully from a treasure table",(()=>e(void 0,void 0,void 0,(function*(){const e=yield Si();yield e.createEmbeddedDocuments("TableResult",[{text:"100% Chance",range:[1,1],weight:100}]);const t=yield pi(e,{});yield ht(),i(t.treasure).is.not.undefined;const a=Object.keys(t.treasure)[0];i(t.treasure[a].text).equal("100% Chance")})))),a("Just draws from a non-treasure table",(()=>e(void 0,void 0,void 0,(function*(){const e=yield qi();null==e||e.update({formula:"1d100"}),yield null==e?void 0:e.createEmbeddedDocuments("TableResult",[{text:"100% Chance",range:[1,100]}]);const t=yield pi(e,{});yield ht(),i(t.treasure).is.not.undefined;const a=Object.keys(t.treasure)[0];i(t.treasure[a].text).equal("100% Chance")}))))})),t("rollTreasure(table, options)",(()=>{a("Rolling on treasure table produces a chat message",(()=>e(void 0,void 0,void 0,(function*(){var e,t;gt();const a=yield Si();yield a.createEmbeddedDocuments("TableResult",[{text:"100% Chance",range:[1,1],weight:100}]),yield fi(a),yield ht(),i(null===(e=game.messages)||void 0===e?void 0:e.size).equal(1),i(null===(t=game.messages)||void 0===t?void 0:t.contents[0].content).contains("100% Chance")}))))})),s((()=>{e(void 0,void 0,void 0,(function*(){var e;const t=null===(e=game.tables)||void 0===e?void 0:e.filter((e=>e.name===`Mock Table ${bi}`||e.name===`Mock Treasure Table ${bi}`));null==t||t.forEach((e=>e.delete()))})),gt()}))};Hooks.on("quenchReady",(t=>e(void 0,void 0,void 0,(function*(){t.registerBatch(Mt,_t,Ft),t.registerBatch("ose.actor.datamodel.character.ac",xt,Nt),t.registerBatch("ose.actor.datamodel.character.encumbrance",Pt,jt),t.registerBatch("ose.actor.datamodel.character.move",Lt,Ht),t.registerBatch("ose.actor.datamodel.character.scores",Bt,Wt),t.registerBatch("ose.actor.datamodel.character.spells",Yt,Ut),t.registerBatch(Xt,Zt,Jt),t.registerBatch(ea,ia,ta),t.registerBatch(sa,oa,na),t.registerBatch(ra,ca,da),t.registerBatch(ma,ga,va),t.registerBatch(ha,pa,ya),t.registerBatch(fa,qa,ba),t.registerBatch(Sa,Ea,Oa),t.registerBatch("ose.item.datamodel.ability",Ia,Ta),t.registerBatch("ose.item.datamodel.armor",Aa,Ca),t.registerBatch("ose.item.datamodel.container",Ma,Da),t.registerBatch("ose.item.datamodel.misc",$a,Fa),t.registerBatch("ose.item.datamodel.spell",Na,_a),t.registerBatch("ose.item.datamodel.weapon",ja,xa),t.registerBatch("ose.item.entity",Pa,Ra),t.registerBatch("ose.item.sheet",Ga,Ha),t.registerBatch(La,Ba,Wa),t.registerBatch(Ua,Ya,Ka),t.registerBatch("ose.party-xp.sheet",Ja,Xa),t.registerBatch("ose.helpers.behaviour",Za,Qa),t.registerBatch("ose.helpers.chat",ti,ei),t.registerBatch("ose.helpers.dice",si,ai),t.registerBatch("ose.helpers.handlebars",li,ni),t.registerBatch(oi,mi,ri),t.registerBatch(vi,yi,gi),t.registerBatch(bi,Oi,wi)}))));"function"!=typeof Math.clamp&&(Math.clamp=Math.clamped),Hooks.once("init",(async()=>{CONFIG.Combat.initiative={formula:"1d6 + @init",decimals:2},CONFIG.OSE=F,game.ose={rollItemMacro:lt,rollTableMacro:ot,oseCombat:tt},ct.init(),e(void 0,void 0,void 0,(function*(){Handlebars.registerHelper("eq",((e,t)=>e===t)),Handlebars.registerHelper("mod",(e=>e>0?`+${e}`:e<0?`${e}`:"0")),Handlebars.registerHelper("add",((e,t)=>parseInt(e,10)+parseInt(t,10))),Handlebars.registerHelper("subtract",((e,t)=>parseInt(e,10)-parseInt(t,10))),Handlebars.registerHelper("divide",((e,t)=>Math.floor(parseFloat(e)/parseFloat(t)))),Handlebars.registerHelper("mult",((e,t)=>Math.round(100*parseFloat(e)*parseFloat(t))/100)),Handlebars.registerHelper("roundWeight",(e=>Math.round(parseFloat(e)/100)/10)),Handlebars.registerHelper("getTagIcon",(e=>{const t=Object.keys(CONFIG.OSE.tags).find((t=>CONFIG.OSE.tags[t]===e));return t?CONFIG.OSE.tag_images[t]:null})),Handlebars.registerHelper("counter",((e,t,a)=>e?Math.clamp(100*t/a,0,100):Math.clamp(100-100*t/a,0,100))),Handlebars.registerHelper("times",((e,t)=>{let a="";for(let i=0;i<e;++i)a+=t.fn(i);return a})),Handlebars.registerHelper("path",(e=>`${F.systemPath()}${e}`)),Handlebars.registerHelper("asset",(e=>`${F.assetsPath}${e}`)),Handlebars.registerHelper("ceil",(e=>Math.ceil(e)))})),Hooks.call("ose-setup-encumbrance"),game.settings.register(game.system.id,"initiative",{name:game.i18n.localize("OSE.Setting.Initiative"),hint:game.i18n.localize("OSE.Setting.InitiativeHint"),default:"group",scope:"world",type:String,config:!0,choices:{individual:"OSE.Setting.InitiativeIndividual",group:"OSE.Setting.InitiativeGroup"}}),game.settings.register(game.system.id,"rerollInitiative",{name:game.i18n.localize("OSE.Setting.RerollInitiative"),hint:game.i18n.localize("OSE.Setting.RerollInitiativeHint"),default:"reset",scope:"world",type:String,config:!0,choices:{keep:"OSE.Setting.InitiativeKeep",reset:"OSE.Setting.InitiativeReset",reroll:"OSE.Setting.InitiativeReroll"}}),game.settings.register(game.system.id,"ascendingAC",{name:game.i18n.localize("OSE.Setting.AscendingAC"),hint:game.i18n.localize("OSE.Setting.AscendingACHint"),default:!1,scope:"world",type:Boolean,config:!0}),game.settings.register(game.system.id,"morale",{name:game.i18n.localize("OSE.Setting.Morale"),hint:game.i18n.localize("OSE.Setting.MoraleHint"),default:!1,scope:"world",type:Boolean,config:!0}),game.settings.register(game.system.id,"encumbranceOption",{name:game.i18n.localize("OSE.Setting.Encumbrance"),hint:game.i18n.localize("OSE.Setting.EncumbranceHint"),default:"detailed",scope:"world",type:String,config:!0,choices:Object.values(CONFIG.OSE.encumbranceOptions).reduce(((e,t)=>Object.assign(Object.assign({},e),{[t.type]:t.localizedLabel})),{})}),game.settings.register(game.system.id,"significantTreasure",{name:game.i18n.localize("OSE.Setting.SignificantTreasure"),hint:game.i18n.localize("OSE.Setting.SignificantTreasureHint"),default:800,scope:"world",type:Number,config:!0}),game.settings.register(game.system.id,"languages",{name:game.i18n.localize("OSE.Setting.Languages"),hint:game.i18n.localize("OSE.Setting.LanguagesHint"),default:"",scope:"world",type:String,config:!0}),game.settings.register(game.system.id,"applyDamageOption",{name:game.i18n.localize("OSE.Setting.applyDamageOption"),hint:game.i18n.localize("OSE.Setting.applyDamageOptionHint"),default:"selected",scope:"world",type:String,config:!0,choices:{selected:game.i18n.localize("OSE.Setting.damageSelected"),targeted:game.i18n.localize("OSE.Setting.damageTarget"),originalTarget:game.i18n.localize("OSE.Setting.damageOriginalTarget")}}),game.settings.register(game.system.id,"invertedCtrlBehavior",{name:game.i18n.localize("OSE.Setting.InvertedCtrlBehavior"),hint:game.i18n.localize("OSE.Setting.InvertedCtrlBehaviorHint"),default:!1,scope:"world",type:Boolean,config:!0}),Hooks.once("item-piles-ready",(async()=>{game.itempiles.API.addSystemIntegration({VERSION:"1.0.1",ACTOR_CLASS_TYPE:"character",ITEM_QUANTITY_ATTRIBUTE:"system.quantity.value",ITEM_PRICE_ATTRIBUTE:"system.cost",ITEM_FILTERS:[{path:"type",filters:"spell,ability"}],UNSTACKABLE_ITEM_TYPES:["weapon","armor","container"],ITEM_SIMILARITIES:["name","type","system.treasure"],CURRENCIES:[{type:"item",name:"OSE.items.gp.long",img:"systems/ose/assets/gold.png",abbreviation:"{#}GP",data:{item:{name:"Gold Coins",type:"item",img:"systems/ose/assets/gold.png",system:{quantity:{value:1,max:null},weight:.1,cost:1,treasure:!0}}},primary:!0,exchangeRate:1}]})})),CONFIG.Actor.documentClass=He,CONFIG.Item.documentClass=ze,CONFIG.Actor.systemDataModels={character:xe,monster:Re},CONFIG.Item.systemDataModels={weapon:Ye,armor:Be,item:Ke,spell:Ve,ability:We,container:Ue},Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet(game.system.id,H,{types:["character"],makeDefault:!0,label:"OSE.SheetClassCharacter"}),Actors.registerSheet(game.system.id,Ge,{types:["monster"],makeDefault:!0,label:"OSE.SheetClassMonster"}),Items.unregisterSheet("core",ItemSheet),Items.registerSheet(game.system.id,Xe,{makeDefault:!0,label:"OSE.SheetClassItem"}),await e(void 0,void 0,void 0,(function*(){const e=[`${F.systemPath()}/templates/actors/character-sheet.html`,`${F.systemPath()}/templates/actors/monster-sheet.html`,`${F.systemPath()}/templates/actors/partials/character-header.html`,`${F.systemPath()}/templates/actors/partials/character-attributes-tab.html`,`${F.systemPath()}/templates/actors/partials/character-abilities-tab.html`,`${F.systemPath()}/templates/actors/partials/character-spells-tab.html`,`${F.systemPath()}/templates/actors/partials/character-inventory-tab.html`,`${F.systemPath()}/templates/actors/partials/actor-item-summary.html`,`${F.systemPath()}/templates/actors/partials/character-notes-tab.html`,`${F.systemPath()}/templates/actors/partials/monster-header.html`,`${F.systemPath()}/templates/actors/partials/monster-attributes-tab.html`,`${F.systemPath()}/templates/actors/partials/item-auto-tags-partial.html`,`${F.systemPath()}/templates/apps/party-sheet.html`];return loadTemplates(e)}))})),Hooks.once("setup",(()=>{["saves_short","saves_long","scores","armor","colors","tags"].forEach((e=>{CONFIG.OSE[e]=Object.entries(CONFIG.OSE[e]).reduce(((e,t)=>{const a={...e};return a[t[0]]=game.i18n.localize(t[1]),a}),{})}));const e=game.settings.get(game.system.id,"languages");if(""!==e){const t=e.split(",").map((e=>e.trim()));CONFIG.OSE.languages=t}})),Hooks.once("ready",(async()=>{Hooks.on("hotbarDrop",((e,t,a)=>(nt(t,a),!1)))})),Hooks.on("renderSidebarTab",(async(e,t)=>{if(e instanceof ActorDirectory&&((e,t)=>{const a=`<button class='ose-party-sheet' type="button" title='${game.i18n.localize("OSE.dialog.partysheet")}'><i class='fas fa-users'></i></button>`;t.find(".fas.fa-search").replaceWith($(a)),t.find(".ose-party-sheet").click((e=>{e.preventDefault(),Hooks.call("OSE.Party.showSheet")}))})(0,t),e instanceof Settings){const e=t.find("#game-details");e.find("h4").last().append(' <sub><a href="https://oldschoolessentials.necroticgnome.com/srd/index.php">SRD<a></sub>');const a=`${F.systemPath()}/templates/chat/license.html`,i=await renderTemplate(a);e.find(".system").append(i);const s=t.find("button[data-action='docs']"),n="border:none;margin-right:2px;vertical-align:middle;margin-bottom:5px";$(`<button type="button" data-action="userguide"><img src='${F.assetsPath}/dragon.png' width='16' height='16' style='${n}'/>Old School Guide</button>`).insertAfter(s),t.find('button[data-action="userguide"]').click((()=>{new FrameViewer("https://ose.vtt.red/",{resizable:!0}).render(!0)}))}})),Hooks.on("preCreateCombatant",((e,t,a,i)=>{"group"===game.settings.get(game.system.id,"initiative")&&tt.addCombatant(e,t,a,i)})),Hooks.on("updateCombatant",tt.debounce(tt.updateCombatant),100),Hooks.on("renderCombatTracker",tt.debounce(tt.format,100)),Hooks.on("preUpdateCombat",tt.preUpdateCombat),Hooks.on("getCombatTrackerEntryContext",tt.debounce(tt.addContextEntry,100)),Hooks.on("renderChatLog",((e,t)=>ze.chatListeners(t))),Hooks.on("getChatLogEntryContext",((e,t)=>(t.push({name:game.i18n.localize("OSE.messages.applyDamage"),icon:'<i class="fas fa-user-minus"></i>',condition:Ze,callback:e=>Je(e,1)},{name:game.i18n.localize("OSE.messages.applyHealing"),icon:'<i class="fas fa-user-plus"></i>',condition:Ze,callback:e=>Je(e,-1)}),t))),Hooks.on("renderChatMessage",((e,t)=>{var a;const i=t.find(".blindable");(null==e?void 0:e.blind)&&!(null===(a=game.user)||void 0===a?void 0:a.isGM)&&i&&!0===i.data("blind")&&i.replaceWith("<div class='dice-roll'><div class='dice-result'><div class='dice-formula'>???</div></div></div>");const s=t.find(".damage-roll");s.length>0&&et(t)&&(s.append($('<div class="dice-damage"><button type="button" data-action="apply-damage"><i class="fas fa-tint"></i></button></div>')),s.find('button[data-action="apply-damage"]').on("click",(e=>{e.preventDefault(),Je(t,1)})))})),Hooks.on("renderRollTableConfig",((e,t)=>{const a=Boolean(e.object.getFlag(game.system.id,"treasure")),i=$("<div class='toggle-treasure' title='Toggle Treasure Table'></div>");i.toggleClass("active",a);if(t.find(".sheet-header").append(i),t.find(".toggle-treasure").click((t=>{const a=Boolean(e.object.getFlag(game.system.id,"treasure"));e.object.setFlag(game.system.id,"treasure",!a)})),!a)return;t.find(".result-range").hide(),t.find(".normalize-results").remove();t.find(".table-header .result-weight").text("Chance (%)");t.find(".result-weight").css("flex","0 0 75px");const s=t.find("input[name=formula]");s.attr("value","1d100"),s.attr("disabled",!0);const n=`<button class="roll-treasure" type="button"><i class="fas fa-gem"></i> ${game.i18n.localize("OSE.table.treasure.roll")}</button>`;t.find(".sheet-footer .roll").replaceWith(n),t.find(".roll-treasure").click((t=>{it(e.object,{event:t})}))})),Hooks.on("updateActor",mt),Hooks.on("renderCompendium",(async(e,t,a)=>{if("Item"!==e.metadata.type)return;const i=t[0].querySelectorAll(".item"),s=await a.collection.getDocuments();i.forEach((async(e,t)=>{const a=i[t].dataset.documentId,n=s.find((e=>e.id===a)),l=$.parseHTML(await renderTemplate(`${F.systemPath()}/templates/actors/partials/item-auto-tags-partial.html`,{tags:n.system.autoTags}));$(e).append(l)}))})),Hooks.on("renderSidebarDirectory",(async(e,t)=>{if("items"!==e.id)return;const a=t[0].querySelectorAll(".item"),i=e.documents;a.forEach((async e=>{const t=i.find((t=>t.id===e.dataset.documentId)),a=$.parseHTML(await renderTemplate(`${F.systemPath()}/templates/actors/partials/item-auto-tags-partial.html`,{tags:t.system.autoTags||[]}));$(e).append(a)}))})),Hooks.on("OSE.Party.showSheet",ct.showPartySheet);
//# sourceMappingURL=ose.js.map
